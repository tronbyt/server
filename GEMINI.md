# GEMINI.md

## Project Overview

This project is the **Tronbyt Server**, a Go-based application which manages Tronbyt devices (flashed Tidbyts) locally, providing a web UI and API for app management and rendering.

The core functionality involves serving WebP images to devices, generated by rendering Pixlet apps (Starlark scripts). The server integrates with the native Go `pixlet` library.

## Key Technologies

*   **Language:** Go 1.25+
*   **Web Framework:** Standard Library `net/http` with `ServeMux` (Go 1.22+ routing features).
*   **Database:** SQLite/Postgres/MySQL with **GORM** (ORM). Data is stored in a relational schema (Users, Devices, Apps).
*   **Templating:** `html/template` (standard library).
*   **Rendering:** Native Go integration with `github.com/tronbyt/pixlet`.
*   **Authentication:** Session-based (secure cookies via `gorilla/sessions`) with Argon2id password hashing.
*   **Internationalization:** `go-i18n` (JSON translation files).

## Project Structure

*   `cmd/boot/`: Entry point for containers.
*   `cmd/server/`: Main entry point for the server binary.
*   `cmd/migrate/`: Tool to migrate legacy SQLite databases to the new schema.
*   `internal/apps/`: App metadata and discovery.
*   `internal/auth/`: Authentication logic (password hashing).
*   `internal/config/`: Configuration loading (env vars).
*   `internal/data/`: Data models and GORM setup.
*   `internal/firmware/`: Device firmware generation.
*   `internal/gitutils/`: Utilities for git operations (apps repositories).
*   `internal/legacy/`: Helpers for reading legacy Python-based data structures.
*   `internal/migration/`: Migration tooling from earlier versions.
*   `internal/renderer/`: Pixlet rendering integration.
*   `internal/server/`: HTTP handlers, middleware, routing, and business logic.
*   `internal/sync/`: Event hub for websockets.
*   `internal/version/`: Version information.
*   `web/i18n/`: Translation files (e.g., `de.json`).
*   `web/static/`: Static assets (CSS, JS, images).
*   `web/templates/`: HTML templates.

## Building and Running

### Local Development

1.  **Dependencies:** Ensure Go 1.25+ and C build tools (gcc) are installed.
2.  **Run with `go run` (for development):**
    ```bash
    go run ./cmd/server -db data/tronbyt.db -data .
    ```
3.  **Build and Run (for production/deployment):**
    ```bash
    go build -o tronbyt-server ./cmd/server
    ./tronbyt-server -db users/new.db -data .
    ```

### Testing

1.  `go test ./...`

### Docker

1.  **Build:**
    ```bash
    docker build -t tronbyt-server .
    ```
2.  **Run:**
    ```bash
    docker run -p 8000:8000 -v $(pwd)/data:/app/data tronbyt-server
    ```

## Development Conventions

*   **Formatting:** Use `go fmt ./...` for Go and `djlint --profile=golang --reformat` for HTML templates.
*   **Linting:** Use `golangci-lint run` for Go and `djlint --profile=golang --lint` for HTML templates.
*   **Logging:** Use `log/slog` for structured logging.
*   **Templates:** Use `{{ t .Localizer "MessageID" }}` for translated strings.
*   **Database:** Use GORM for DB interactions. Ensure migrations are updated in `cmd/migrate` or auto-migrated in `server.go` if appropriate.
*   **Testing**: Use the `testify` library (`assert` and `require`) in unit tests.
