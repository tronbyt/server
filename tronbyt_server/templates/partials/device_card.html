<!-- Device Card Component -->
<div class="w3-card-4 w3-padding device-container">
  <article>
    <div>
      <table width="100%">
        <tr>
          <td colspan="2">
            <header>
              <h1>
                <a href="{{ device.img_url }}" target="_blank" class="device-link">
                  {{ device.name }}
                </a>
                {% if device.pinned_app %}
                  {% set pinned_app_iname = device.pinned_app %}
                  {% set pinned_app = device.apps.get(pinned_app_iname) if device.apps else None %}
                  {% if pinned_app %}
                    <span class="pinned-badge">
                      <i class="fa-solid fa-thumbtack" aria-hidden="true"></i> {{ _('Pinned:') }} {{ pinned_app.name }}
                    </span>
                  {% endif %}
                {% endif %}
              </h1>
            </header>
          </td>
          <td rowspan="4" width="40%">
            <div class="app-img"><img id="currentWebp-{{ device.id }}"
                data-src="{{url_for('currentwebp', device_id=device.id) }}"
                src="{{url_for('currentwebp', device_id=device.id) }}"
                alt="{{ _('Preview') }}">
            </div>
            <div>{{ _('Currently Displaying App') }}</div>
            <div class="device-info-box">
              <button class="device-info-toggle" aria-expanded="false" aria-controls="device-info-content-{{ device.id }}">
                <i class="fas fa-chevron-down"></i> {{ _('Device Info') }}
              </button>
              <div id="device-info-content-{{ device.id }}" class="device-info-content">
                <table class="device-info-table">
                  {% if device.info.firmware_version %}
                  <tr><td>{{ _('Firmware Version:') }}</td><td>{{ device.info.firmware_version }}</td></tr>
                  {% endif %}
                  {% if device.info.firmware_type %}
                  <tr><td>{{ _('Firmware Type:') }}</td><td>{{ device.info.firmware_type }}</td></tr>
                  {% endif %}
                  {% if device.info.protocol_version %}
                  <tr><td>{{ _('Protocol Version:') }}</td><td>{{ device.info.protocol_version }}</td></tr>
                  {% endif %}
                  {% if device.info.mac_address %}
                  <tr><td>{{ _('MAC Address:') }}</td><td>{{ device.info.mac_address }}</td></tr>
                  {% endif %}
                  {% if device.info.protocol_type %}
                  <tr><td>{{ _('Protocol Type:') }}</td><td>{{ device.info.protocol_type.value }}</td></tr>
                  {% endif %}
                  {% if device.last_seen %}
                  <tr><td>{{ _('Last Seen:') }}</td><td>{{ device.last_seen.astimezone().strftime('%Y-%m-%d %H:%M:%S') }}</td></tr>
                  {% endif %}
                </table>
              </div>
            </div>
          </td>
        </tr>
        <tr>
          <td>
            <label>{{ _('Brightness') }}</label> =
            <span id="brightnessValue-{{ device.id }}">{{ brightness_ui }}</span>
            <div class="brightness-panel" id="brightness-panel-{{ device.id }}">
              <button type="button" class="brightness-btn {% if brightness_ui == 0 %}active{% endif %}"
                      data-brightness="0" onclick="setBrightness('{{ device.id }}', 0)">0</button>
              <button type="button" class="brightness-btn {% if brightness_ui == 1 %}active{% endif %}"
                      data-brightness="1" onclick="setBrightness('{{ device.id }}', 1)">1</button>
              <button type="button" class="brightness-btn {% if brightness_ui == 2 %}active{% endif %}"
                      data-brightness="2" onclick="setBrightness('{{ device.id }}', 2)">2</button>
              <button type="button" class="brightness-btn {% if brightness_ui == 3 %}active{% endif %}"
                      data-brightness="3" onclick="setBrightness('{{ device.id }}', 3)">3</button>
              <button type="button" class="brightness-btn {% if brightness_ui == 4 %}active{% endif %}"
                      data-brightness="4" onclick="setBrightness('{{ device.id }}', 4)">4</button>
              <button type="button" class="brightness-btn {% if brightness_ui == 5 %}active{% endif %}"
                      data-brightness="5" onclick="setBrightness('{{ device.id }}', 5)">5</button>
            </div>
          </td>
        </tr>
        <tr>
          <td>
            <label for="default_interval-{{ device.id }}">{{ _('App Cycle Time (Seconds)') }}</label> = <span
              id="intervalValue-{{ device.id }}">{{
              device.default_interval }} </span> s<br>
            <input type="range" name="default_interval" id="default_interval-{{ device.id }}" min="1" max="30"
              value="{{ device.default_interval }}" oninput="updateIntervalValue('{{ device.id }}', this.value)"
              onmouseup="updateInterval('{{ device.id }}', this.value)">
          </td>
        </tr>
        <tr>
          <td>
            <a class="w3-button w3-teal w3-round" style="min-width: 100px;"
              href="{{ url_for('addapp', device_id=device.id) }}"><i class="fa-solid fa-circle-plus" aria-hidden="true"></i> {{ _('Add App') }}</a>

            <a class="w3-button w3-teal w3-round" style="min-width: 100px;"
              href="{{ url_for('update', device_id=device.id) }}"><i class="fa-solid fa-pen-to-square" aria-hidden="true"></i> {{ _('Edit Device') }}</a>
            {% if device.type in ["tidbyt_gen1", "tidbyt_gen2", "pixoticker", "tronbyt_s3", "tronbyt_s3_wide", "matrixportal_s3", "matrixportal_s3_waveshare"] %}
                  <a class="w3-button w3-teal w3-round" style="min-width: 100px;"
                    href="{{ url_for('generate_firmware', device_id=device.id) }}"><i class="fa-solid fa-microchip" aria-hidden="true"></i> {{ _('Firmware') }}</a>
            {% endif %}
        </tr>
      </table>

      <!-- View Toggle Row -->
      <div class="view-toggle-row" style="display: flex; justify-content: space-between; align-items: center;">
        <div class="view-toggle-container" style="display: flex; align-items: center;">
          <span style="margin-right: 10px; font-weight: bold;">{{ _('View:') }}</span>
          <button id="listViewBtn-{{ device.id }}" class="w3-button w3-blue w3-round view-toggle-btn active"
                  onclick="switchToListView('{{ device.id }}')" title="{{ _('List View') }}">
            <i class="fas fa-list"></i> {{ _('List') }}
          </button>
          <button id="gridViewBtn-{{ device.id }}" class="w3-button w3-blue w3-round view-toggle-btn"
                  onclick="switchToGridView('{{ device.id }}')" title="{{ _('Grid View') }}">
            <i class="fas fa-th"></i> {{ _('Grid') }}
          </button>
          <button id="collapsedViewBtn-{{ device.id }}" class="w3-button w3-blue w3-round view-toggle-btn"
                  onclick="switchToCollapsedView('{{ device.id }}')" title="{{ _('Collapsed View') }}">
            <i class="fas fa-chevron-up"></i> {{ _('Collapsed') }}
          </button>
        </div>
        <div class="instruction-text" style="color: #666; font-style: italic;">
          {{ _('Drag apps to reorder or copy from/to another device') }}
        </div>
      </div>

      <div id="appsList-{{ device.id }}" class="visible apps-list-view">
        {% set apps_list = (device.apps.values()|list if device.apps else [])|sort(attribute='order') %}
        {% set pinned_app_iname = device.pinned_app %}
        {% set pinned_apps = apps_list|selectattr('iname', 'equalto', pinned_app_iname) if pinned_app_iname else [] %}
        {% set unpinned_apps = apps_list|rejectattr('iname', 'equalto', pinned_app_iname) %}
        {% set all_apps_ordered = pinned_apps|list + unpinned_apps|list %}

        {% for app in all_apps_ordered %}
          {% include 'partials/app_card.html' %}
          {% if not loop.last %}
          <hr class="list-view-separator">
          {% endif %}
        {% endfor %}
      </div>

    </div>
  </article>
</div>
