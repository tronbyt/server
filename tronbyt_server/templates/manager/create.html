{% extends 'base.html' %}
{% block header %}
<link rel="stylesheet" href="{{ url_for('static', path='css/update-simple.css') }}">
<script src="{{ url_for('static', path='js/location.js') }}"></script>
<div class="header-container">
  <h1 class="page-title">{% block title %}{{ _('New Tronbyt Device') }}{% endblock %}</h1>
</div>
<script>
  function setBrightnessCreate(brightness) {
    document.getElementById('brightness').value = brightness;
    document.getElementById('brightness-output').innerText = brightness;
    const buttons = document.querySelectorAll('#brightness-panel .brightness-btn');
    buttons.forEach(btn => {
      if (parseInt(btn.dataset.brightness) === parseInt(brightness)) {
        btn.classList.add('active');
      } else {
        btn.classList.remove('active');
      }
    });
  }
</script>
{% endblock %}
{% block content %}
<form method="post" id="create-device-form">
  <div class="device-settings-section">
    <h2>{{ _('Basic Information') }}</h2>

    <div class="device-settings-row">
      <div>
        <label for="name" class="device-settings-label">{{ _('Name') }}</label>
        <input name="name" id="name" value="{{ form.name if form else '' }}" required class="device-settings-input">
        <small class="small-text">{{ _('Descriptive name for this Tronbyt device') }}</small>
      </div>
      <div>
        <label for="device_type" class="device-settings-label">{{ _('Device Type') }}</label>
        <select name="device_type" id="device_type" class="device-settings-input">
          {% for value, name in device_type_choices.items() %}
            <option value="{{ value }}" {% if (form.device_type.value if form else default_device_type) == value %}selected{% endif %}>{{ name }}</option>
          {% endfor %}
        </select>
      </div>
    </div>
  </div>

  <div class="device-settings-section">
    <h2>{{ _('Connection URLs') }}</h2>

    <div class="device-settings-row">
      <div>
        <label for="img_url" class="device-settings-label">{{ _('Image URL') }}</label>
        <input name="img_url" id="img_url" value="{{ form.img_url if form else '' }}" class="device-settings-input">
        <small class="small-text">{{ _('Leave blank unless advanced user.') }}</small>
      </div>
      <div>
        <label for="ws_url" class="device-settings-label">{{ _('WebSocket URL') }}</label>
        <input name="ws_url" id="ws_url" value="{{ form.ws_url if form else '' }}" class="device-settings-input">
        <small class="small-text">{{ _('Leave blank unless advanced user.') }}</small>
      </div>
    </div>
  </div>

  <div class="device-settings-section">
    <h2>{{ _('Display Settings') }}</h2>

    <table class="device-settings-table">
      <tr>
        <td>
          <label class="device-settings-label">{{ _('Brightness Level (0 - 5)') }}</label>
        </td>
        <td>
          <output id="brightness-output">{{ form.brightness if form else '3' }}</output>
          <input type="hidden" name="brightness" id="brightness" value="{{ form.brightness if form else '3' }}">
          <div class="brightness-panel" id="brightness-panel">
            <button type="button" class="brightness-btn {% if (form.brightness if form else 3) == 0 %}active{% endif %}" data-brightness="0" onclick="setBrightnessCreate(0)">0</button>
            <button type="button" class="brightness-btn {% if (form.brightness if form else 3) == 1 %}active{% endif %}" data-brightness="1" onclick="setBrightnessCreate(1)">1</button>
            <button type="button" class="brightness-btn {% if (form.brightness if form else 3) == 2 %}active{% endif %}" data-brightness="2" onclick="setBrightnessCreate(2)">2</button>
            <button type="button" class="brightness-btn {% if (form.brightness if form else 3) == 3 %}active{% endif %}" data-brightness="3" onclick="setBrightnessCreate(3)">3</button>
            <button type="button" class="brightness-btn {% if (form.brightness if form else 3) == 4 %}active{% endif %}" data-brightness="4" onclick="setBrightnessCreate(4)">4</button>
            <button type="button" class="brightness-btn {% if (form.brightness if form else 3) == 5 %}active{% endif %}" data-brightness="5" onclick="setBrightnessCreate(5)">5</button>
          </div>
        </td>
      </tr>
    </table>
  </div>

  <div class="device-settings-section">
    <h2>{{ _('Location & Notes') }}</h2>

    <div class="device-settings-row">
      <div>
        <label for="location_search" class="device-settings-label">{{ _('Location') }}</label>
        <input type="text" id="location_search" placeholder="{{ _('Enter a location') }}"
          value="{{ form.location_search if form else '' }}" class="device-settings-input">
        <ul id="location_results"></ul>
        <input type="hidden" name="location" id="location" value='{{ (form.location if form else {}) | tojson }}'>
      </div>
      <div>
        <label for="notes" class="device-settings-label">{{ _('Notes') }}</label>
        <input name="notes" id="notes" value="{{ form.notes if form else '' }}" class="device-settings-input" placeholder="{{ _('Optional notes about this device') }}">
      </div>
    </div>
  </div>

  <input type="hidden" name="api_key" id="api_key">

  <div class="device-settings-section">
    <div class="config-management-container" style="display:flex;align-items:center;gap:8px;">
      <button type="submit" class="w3-button w3-green config-management-btn"><i class="fa-solid fa-floppy-disk" aria-hidden="true"></i> {{ _('Save') }}</button>
      <button type="button" class="w3-button w3-orange config-management-btn"
              onclick="window.location.href='{{ url_for('import_device') }}';">
        <i class="fa-solid fa-file-import" aria-hidden="true"></i> {{ _('Import Configuration') }}
      </button>
    </div>
  </div>
</form>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    enableLocationSearch(document.getElementById('location_search'), document.getElementById('location_results'), document.getElementById('location'), null);
  });
</script>
{% endblock %}
