{% extends 'base.html' %}
{% block header %}
<link rel="stylesheet" href="{{ url_for('static', path='css/update-simple.css') }}">
<script src="{{ url_for('static', path='js/location.js') }}"></script>
<div class="header-container">
  <h1 class="page-title">{% block title %}{{ _('New Tronbyt Device') }}{% endblock %}</h1>
</div>
<script>
  function setBrightnessCreate(brightness) {
    document.getElementById('brightness').value = brightness;
    document.getElementById('brightness-output').innerText = brightness;
    const buttons = document.querySelectorAll('#brightness-panel .brightness-btn');
    buttons.forEach(btn => {
      if (parseInt(btn.dataset.brightness) === parseInt(brightness)) {
        btn.classList.add('active');
      } else {
        btn.classList.remove('active');
      }
    });
  }
</script>
{% endblock %}
{% block content %}
<form method="post" id="create-device-form">
  <div class="device-settings-section">
    <h2>{{ _('Basic Information') }}</h2>

    <div class="device-settings-row">
      <div>
        <label for="name" class="device-settings-label">{{ _('Name') }}</label>
        <input name="name" id="name" value="{{ request.form['name'] }}" required class="device-settings-input">
        <small class="small-text">{{ _('Descriptive name for this Tronbyt device') }}</small>
      </div>
      <div>
        <label for="device_type" class="device-settings-label">{{ _('Device Type') }}</label>
        <select name="device_type" id="device_type" class="device-settings-input">
          <option value="tidbyt_gen1" selected>Tidbyt Gen1</option>
          <option value="tidbyt_gen2">Tidbyt Gen2</option>
          <option value="pixoticker">Pixoticker</option>
          <option value="tronbyt_s3">Tronbyt S3</option>
          <option value="tronbyt_s3_wide">Tronbyt S3 Wide</option>
          <option value="raspberrypi">Raspberry Pi</option>
          <option value="other">Other</option>
        </select>
      </div>
    </div>
  </div>

  <div class="device-settings-section">
    <h2>{{ _('Connection URLs') }}</h2>

    <div class="device-settings-row">
      <div>
        <label for="img_url" class="device-settings-label">{{ _('Image URL') }}</label>
        <input name="img_url" id="img_url" value="{{ request.form['img_url'] }}" class="device-settings-input">
        <small class="small-text">{{ _('Leave blank unless advanced user.') }}</small>
      </div>
      <div>
        <label for="ws_url" class="device-settings-label">{{ _('WebSocket URL') }}</label>
        <input name="ws_url" id="ws_url" value="{{ request.form['ws_url'] }}" class="device-settings-input">
        <small class="small-text">{{ _('Leave blank unless advanced user.') }}</small>
      </div>
    </div>
  </div>

  <div class="device-settings-section">
    <h2>{{ _('Display Settings') }}</h2>

    <table class="device-settings-table">
      <tr>
        <td>
          <label class="device-settings-label">{{ _('Brightness Level (0 - 5)') }}</label>
        </td>
        <td>
          <output id="brightness-output">3</output>
          <input type="hidden" name="brightness" id="brightness" value="3">
          <div class="brightness-panel" id="brightness-panel">
            <button type="button" class="brightness-btn" data-brightness="0" onclick="setBrightnessCreate(0)">0</button>
            <button type="button" class="brightness-btn" data-brightness="1" onclick="setBrightnessCreate(1)">1</button>
            <button type="button" class="brightness-btn" data-brightness="2" onclick="setBrightnessCreate(2)">2</button>
            <button type="button" class="brightness-btn active" data-brightness="3" onclick="setBrightnessCreate(3)">3</button>
            <button type="button" class="brightness-btn" data-brightness="4" onclick="setBrightnessCreate(4)">4</button>
            <button type="button" class="brightness-btn" data-brightness="5" onclick="setBrightnessCreate(5)">5</button>
          </div>
        </td>
      </tr>
    </table>
  </div>

  <div class="device-settings-section">
    <h2>{{ _('Location & Notes') }}</h2>

    <div class="device-settings-row">
      <div>
        <label for="location_search" class="device-settings-label">{{ _('Location') }}</label>
        <input type="text" id="location_search" placeholder="{{ _('Enter a location') }}"
          value="{{ request.form['location_search'] }}" class="device-settings-input">
        <ul id="location_results"></ul>
        <input type="hidden" name="location" id="location" value='{{ (request.form["location"] or {}) | tojson }}'>
      </div>
      <div>
        <label for="notes" class="device-settings-label">{{ _('Notes') }}</label>
        <input name="notes" id="notes" value="{{ request.form['notes'] }}" class="device-settings-input" placeholder="{{ _('Optional notes about this device') }}">
      </div>
    </div>
  </div>

  <input type="hidden" name="api_key" id="api_key">

  <div class="device-settings-section">
    <div class="config-management-container" style="display:flex;align-items:center;gap:8px;">
      <button type="submit" class="w3-button w3-green config-management-btn">{{ _('Save') }}</button>
      <button type="button" class="w3-button w3-orange config-management-btn"
              onclick="window.location.href='{{ url_for('import_device') }}';">
        {{ _('Import Configuration') }}
      </button>
    </div>
  </div>
</form>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    enableLocationSearch(document.getElementById('location_search'), document.getElementById('location_results'), document.getElementById('location'), null);
  });
</script>
{% endblock %}
