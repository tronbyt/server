{% extends 'base.html' %}
{% set device_type_names = {
  'tidbyt_gen1': 'Tidbyt Gen1',
  'tidbyt_gen2': 'Tidbyt Gen2',
  'pixoticker': 'Pixoticker',
  'tronbyt_s3': 'Tronbyt S3',
  'tronbyt_s3_wide': 'Tronbyt S3 Wide',
  'matrixportal_s3': 'MatrixPortal S3',
  'matrixportal_s3_waveshare': 'MatrixPortal S3 Waveshare',
  'raspberrypi': 'Raspberry Pi',
  'other': 'Other'
} %}
{% block header %}
<link rel="stylesheet" href="{{ url_for('static', path='css/firmware-simple.css') }}">
<div class="header-container">
  <h1 class="page-title">{% block title %}{{ _('Generate Firmware for') }} {{ device.name }} - {{ device_type_names.get(device.type, device.type) }}{% endblock %}</h1>
</div>
{% endblock %}
{% block content %}
{% if firmware_version %}
<div class="firmware-info">
    <div>
        <strong>{{ _('Firmware Image Version') }}:</strong> {{ firmware_version }}
    </div>
    {% if user.username == 'admin' %}
    <div>
        <a href="{{ url_for('edit') }}#firmware-management" class="w3-button w3-small w3-gray firmware-management-btn">
            <i class="fa-solid fa-screwdriver-wrench" aria-hidden="true"></i> {{ _('Manage Firmware') }}
        </a>
    </div>
    {% endif %}
</div>
{% endif %}

<form method="post" id="firmware-form">
  <div class="device-settings-section">
    <h2>{{ _('Firmware Generation') }}</h2>

    <div class="device-settings-section-divider">
      <h3>{{ _('Download ESP Flasher') }}</h3>
      <p>{{ _('Download ESP Flasher here') }} <a href="https://github.com/Jason2866/ESP_Flasher/releases" target="_blank">ESP Flasher</a></p>
      <p>{{ _('Connect your device to your computer with a data USB cable, run the ESP Flasher program and select your downloaded firmware file to flash your device. Do NOT use a web based flasher.') }}</p>
      <p><i>{{ _('macOS and Windows users may need to install a serial driver:') }}
        <br>
        <a href="https://www.silabs.com/developer-tools/usb-to-uart-bridge-vcp-drivers?tab=downloads" target="_blank">CP210x Drivers</a>
        <br>
        <a href="https://github.com/WCHSoftGroup/ch34xser_macos" target="_blank">CH34x Drivers</a>
      </i></p>
    </div>

    <input type="hidden" name="id" id="id" value="{{ device.id }}">

    <div class="device-settings-section-divider">
      <h3>{{ _('Connection Settings') }}</h3>

      <table class="device-settings-table">
        <tr>
          <td>
            <label class="device-settings-label">{{ _('Connection Type') }}</label>
          </td>
          <td>
            <div class="connection-type-container">
              <label><input type="radio" name="url_variant" id="variant_ws" value="ws"> WebSocket</label>
              <label><input type="radio" name="url_variant" id="variant_http" value="http"> HTTP</label>
              <label><input type="radio" name="url_variant" id="variant_custom" value="custom"> Custom</label>
            </div>
          </td>
        </tr>
        <tr>
          <td>
            <label for="img_url" class="device-settings-label">{{ _('Image URL') }}</label>
          </td>
          <td>
            <input name="img_url" id="img_url" value="{{ device.img_url }}" class="device-settings-input">
          </td>
        </tr>
      </table>
    </div>

    <div class="device-settings-section-divider">
      <h3>{{ _('WiFi Configuration') }}</h3>

      <table class="device-settings-table">
        <tr>
          <td>
            <label for="wifi_ap" class="device-settings-label">{{ _('WiFi Network Name (SSID) 2.4Ghz Only') }}</label>
          </td>
          <td>
            <input name="wifi_ap" id="wifi_ap" required class="device-settings-input">
          </td>
        </tr>
        <tr>
          <td>
            <label for="wifi_password" class="device-settings-label">{{ _('WiFi Password') }}</label>
          </td>
          <td>
            <input name="wifi_password" id="wifi_password" required class="device-settings-input">
          </td>
        </tr>
        {% if device.type == 'tidbyt_gen1' %}
        <tr>
          <td>
            <label for="swap_colors" class="device-settings-label">{{ _('Swap Colors?') }}</label>
          </td>
          <td>
            <input type="checkbox" name="swap_colors" id="swap_colors">
          </td>
        </tr>
        {% endif %}
      </table>

      {% if device.type == 'tidbyt_gen1' %}
      <div class="w3-panel w3-pale-blue w3-border w3-border-blue w3-round-large" style="margin-top: 15px;">
        <p><i class="fa-solid fa-info-circle"></i> <strong>{{ _('Color Swap Information') }}:</strong></p>
        <p>{{ _('If the colors appear incorrect or swapped on your Tidbyt Gen1 display after flashing, regenerate the firmware with the "Swap Colors" checkbox selected and flash again.') }}</p>
      </div>
      {% endif %}
    </div>
  </div>

  <div class="device-settings-section">
    <div class="config-management-container">
      <button class="w3-button w3-blue config-management-btn" type="submit"><i class="fa-solid fa-microchip" aria-hidden="true"></i> {{ _('Generate Firmware File') }}</button>
    </div>
  </div>
</form>
<hr>

<script>
    (function () {
        const input = document.getElementById('img_url');
        const httpRadio = document.getElementById('variant_http');
        const wsRadio = document.getElementById('variant_ws');
        const customRadio = document.getElementById('variant_custom');
        const httpVal = "{{ device.img_url }}";
        const wsVal = "{{ device.ws_url }}";

        function updateUrl() {
            if (httpRadio.checked || wsRadio.checked) {
                input.value = httpRadio.checked ? httpVal : wsVal;
                input.readOnly = true;
            } else if (customRadio.checked) {
                input.value = "";
                input.readOnly = false;
            }
        }

        document.querySelectorAll('input[name="url_variant"]').forEach(radio => {
            radio.addEventListener('change', updateUrl);
        });

        // Initialize
        wsRadio.checked = true;
        updateUrl();
    })();
</script>

{% endblock %}
