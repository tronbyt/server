{% extends 'base.html' %}
{% block header %}
<h1>{% block title %}{{ _('Generate Firmware for') }} {{ device['name'] }}{% endblock %}</h1>
{% endblock %}
{% block content %}
{% if firmware_version %}
<div style="background-color: #2a2a2a; padding: 10px; margin-bottom: 15px; border-radius: 4px; border-left: 4px solid #4CAF50; display: flex; justify-content: space-between; align-items: center;">
    <div>
        <strong>{{ _('Firmware Image Version') }}:</strong> {{ firmware_version }}
    </div>
    {% if g.user.username == 'admin' %}
    <div>
        <a href="{{ url_for('auth.edit') }}#firmware-management" class="w3-button w3-small w3-gray">
            {{ _('Manage Firmware') }}
        </a>
    </div>
    {% endif %}
</div>
{% endif %}

<form method="post">
    <h2>{{ _('Download ESP Flasher here') }} <a href="https://github.com/Jason2866/ESP_Flasher/releases">ESP Flasher</a></h2>
    {{ _('Connect your device to your computer with a data USB cable, run the ESP Flasher program and select your
    downloaded firmware file to flash your device. Do NOT use a web based flasher.') }}
    <br><i>{{ _('macOS and Windows users may need to install a serial driver:') }}
        <br>
        <a href="https://www.silabs.com/developer-tools/usb-to-uart-bridge-vcp-drivers?tab=downloads">CP210x Drivers</a>
        <br>
        <a href="https://github.com/WCHSoftGroup/ch34xser_macos">CH34x Drivers</a>
    </i>
    <br>
    <input type="hidden" name="id" id="id" value="{{ device['id'] }}">

    <div class="left-align" style="margin: 6px 0 8px;">
        <label style="margin-right:8px;">{{ _('Connection Type') }}:</label>
        <label style="margin-right:12px;"><input type="radio" name="url_variant" id="variant_http" value="http">
            HTTP</label>
        <label style="margin-right:12px;"><input type="radio" name="url_variant" id="variant_ws" value="ws">
            WebSocket</label>
        <label><input type="radio" name="url_variant" id="variant_custom" value="custom"> Custom</label>
    </div>

    <div style="margin-bottom: 15px;">
        <label for="img_url" style="display: block; margin-bottom: 5px; font-weight: bold;">{{ _('Image URL') }}</label>
        <input name="img_url" id="img_url" value="{{ device['img_url'] }}" style="display: block; width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
    </div>

    <div style="margin-bottom: 15px;">
        <label for="wifi_ap" style="display: block; margin-bottom: 5px; font-weight: bold;">{{ _('WiFi Network Name (SSID) 2.4Ghz Only') }}</label>
        <input name="wifi_ap" id="wifi_ap" required style="display: block; width: 100%; max-width: 400px; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
    </div>
    <div style="margin-bottom: 15px;">
        <label for="wifi_password" style="display: block; margin-bottom: 5px; font-weight: bold;">{{ _('WiFi Password') }}</label>
        <input name="wifi_password" id="wifi_password" required style="display: block; width: 100%; max-width: 400px; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
    </div>
    <style>
        .left-align {
            text-align: left;
        }
    </style>

    {% if device.get('type') == 'tidbyt_gen1' %}
    <div class="left-align">
        <label for="swap_colors">{{ _('Swap Colors?') }}</label>
        <input type="checkbox" name="swap_colors" id="swap_colors" {% if request.form.get('swap_colors') %} checked {%
            endif %}>
    </div>
    {% endif %}
    <input class="w3-button w3-blue" type="submit" value="{{ _('Generate Firmware File') }}">
</form>
<hr>

<script>
    (function () {
        const input = document.getElementById('img_url');
        const httpRadio = document.getElementById('variant_http');
        const wsRadio = document.getElementById('variant_ws');
        const customRadio = document.getElementById('variant_custom');
        const httpVal = "{{ device['img_url'] }}";
        const wsVal = "{{ device['ws_url'] }}";

        function updateUrl() {
            if (httpRadio.checked || wsRadio.checked) {
                input.value = httpRadio.checked ? httpVal : wsVal;
                input.readOnly = true;
            } else if (customRadio.checked) {
                input.value = "";
                input.readOnly = false;
            }
        }

        document.querySelectorAll('input[name="url_variant"]').forEach(radio => {
            radio.addEventListener('change', updateUrl);
        });

        // Initialize
        httpRadio.checked = true;
        updateUrl();
    })();
</script>

{% endblock %}