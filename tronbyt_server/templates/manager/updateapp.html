{% extends 'base.html' %}
{% block header %}
<h1>{% block title %}{{ _('Edit') }} "{{ app['name'] }}-{{ app['iname'] }}"{% endblock %}</h1><br>
{% endblock %}
{% block content %}
<!-- Container for flexbox alignment -->
<div class="flex-container">
  <!-- Show Config Toggle Button -->
  <button id="toggleConfigBtn" class="w3-button"
    style="background-color: #608ff3; margin-bottom: 5px; margin-top: 10px;">{{ _('Show App Config') }}</button>
  <a href="{{ url_for('manager.configapp', device_id=device_id, iname=app['iname'], delete_on_cancel=0) }}"
    class="w3-button" style="background-color: #608ff3; margin-bottom: 5px; margin-top: 10px;">{{ _('Configure') }}</a>
  <!-- Show Debug Toggle Button -->
  <button id="toggleDebugBtn" class="w3-button"
    style="background-color: #608ff3; margin-bottom: 5px; margin-top: 10px;">{{ _('Show Render Debug') }}</button>

  <!-- Config Content -->
  <div id="configContent" class="hidden">
    <pre class="flash">{{ config }}</pre>
  </div>

  <!-- Debug Content -->
  <div id="debugContent" class="hidden">
    <pre class="flash">{{ app.get('render_messages', []) | tojson(indent=2) }}</pre>
  </div>
</div>
<form method="post">
  <input type="hidden" name="iname" id="iname" value="{{ request.form['iname'] or app['iname'] }}" readonly>
  <input type="hidden" name="name" id="name" value="{{ request.form['name'] or app['name'] }}" readonly>
  <div><b>{{ _('Enabled: ') }}</b><input name="enabled" type="checkbox" {% if app['enabled'] %} checked {% endif
      %}></input></div>
  <div class="app-img"><img width="400" src="{{url_for('manager.appwebp', device_id=device_id,iname=app['iname']) }}"
      alt="{{ _('Preview') }}"></div>
  <label for="uinterval">{{ _('Render Interval Minutes (Update every X minutes)') }}</label>
  <div><input type="number" name="uinterval" id="uinterval" min="0"
      value="{{ request.form['uinterval'] or app['uinterval'] }}" required></div>

  <label for="display_time">{{ _('Display Time Seconds (0 for device default)') }}</label>
  <div><input type="number" name="display_time" id="display_time" min="0"
      value="{{ request.form['display_time'] or app['display_time'] or 0 }}"></div>

  <label for="notes">{{ _('Notes: ') }}</label>
  <input name="notes" id="notes" value="{{request.form['notes'] or app['notes'] }}">

  <!-- Schedule Section -->
  <h2>{{ _('Schedule') }}</h2>
  <label for="start_time">{{ _('Start Time') }}</label>
  <div><input type="time" name="start_time" id="start_time"
      value="{{ request.form['start_time'] or app['start_time'] }}"></div>

  <label for="end_time">{{ _('End Time') }}</label>
  <div><input type="time" name="end_time" id="end_time" value="{{ request.form['end_time'] or app['end_time'] }}"></div>

  <!-- Legacy Schedule (Default) -->
  <div id="legacy_schedule">
    <label for="days">{{ _('Active Days') }}</label> {{ _('(none selected is ALL selected)') }}
    <div>
      <input type="checkbox" name="days" value="monday" {% if 'monday' in app.get('days', []) or not app.get('days', [])
        %} checked {% endif %}> {{ _('Monday') }}
      <input type="checkbox" name="days" value="tuesday" {% if 'tuesday' in app.get('days', []) or not app.get('days',
        []) %} checked {% endif %}> {{ _('Tuesday') }}
      <input type="checkbox" name="days" value="wednesday" {% if 'wednesday' in app.get('days', []) or not
        app.get('days', []) %} checked {% endif %}> {{ _('Wednesday') }}
      <input type="checkbox" name="days" value="thursday" {% if 'thursday' in app.get('days', []) or not app.get('days',
        []) %} checked {% endif %}> {{ _('Thursday') }}
      <input type="checkbox" name="days" value="friday" {% if 'friday' in app.get('days', []) or not app.get('days', [])
        %} checked {% endif %}> {{ _('Friday') }}
      <input type="checkbox" name="days" value="saturday" {% if 'saturday' in app.get('days', []) or not app.get('days',
        []) %} checked {% endif %}> {{ _('Saturday') }}
      <input type="checkbox" name="days" value="sunday" {% if 'sunday' in app.get('days', []) or not app.get('days', [])
        %} checked {% endif %}> {{ _('Sunday') }}
    </div>
  </div>

  <!-- Custom Recurrence Toggle -->
  <div style="margin-top: 15px; margin-bottom: 15px;">
    <label for="use_custom_recurrence">
      <input type="checkbox" name="use_custom_recurrence" id="use_custom_recurrence" {% if
        request.form.get('use_custom_recurrence') or app.get('use_custom_recurrence', False) %} checked {% endif %}
        onchange="toggleCustomRecurrence()">
      {{ _('Use Custom Recurrence') }}
    </label>
    <small style="display: block; color: #666; margin-top: 5px;">
      {{ _('Enable advanced scheduling options (bi-weekly, monthly, yearly, etc.)') }}
    </small>
  </div>

  <!-- Custom Recurrence Section -->
  <div id="custom_recurrence" style="display: none; border: 1px solid #ddd; padding: 15px; border-radius: 5px;">
    <h3>{{ _('Custom Recurrence') }}</h3>
    <label for="recurrence_type">{{ _('Frequency') }}</label>
    <div>
      <select name="recurrence_type" id="recurrence_type" onchange="toggleRecurrenceOptions()">
        <option value="daily" {% if (request.form['recurrence_type'] or app.get('recurrence_type', 'daily' ))=='daily'
          %} selected {% endif %}>{{ _('Daily') }}</option>
        <option value="weekly" {% if (request.form['recurrence_type'] or app.get('recurrence_type', 'daily' ))=='weekly'
          %} selected {% endif %}>{{ _('Weekly') }}</option>
        <option value="monthly" {% if (request.form['recurrence_type'] or app.get('recurrence_type', 'daily'
          ))=='monthly' %} selected {% endif %}>{{ _('Monthly') }}</option>
        <option value="yearly" {% if (request.form['recurrence_type'] or app.get('recurrence_type', 'daily' ))=='yearly'
          %} selected {% endif %}>{{ _('Yearly') }}</option>
      </select>
    </div>

    <label for="recurrence_interval">{{ _('Repeat every') }}</label>
    <div>
      <input type="number" name="recurrence_interval" id="recurrence_interval" min="1" max="52"
        value="{{ request.form['recurrence_interval'] or app.get('recurrence_interval', 1) }}">
      <span id="interval_unit">{{ _('days') }}</span>
    </div>

    <label for="recurrence_start_date">{{ _('Start Date') }}</label>
    <div>
      <input type="date" name="recurrence_start_date" id="recurrence_start_date"
        value="{{ request.form['recurrence_start_date'] or app.get('recurrence_start_date') or '' }}">
    </div>

    <label for="recurrence_end_date">{{ _('End Date (optional)') }}</label>
    <div>
      <input type="date" name="recurrence_end_date" id="recurrence_end_date"
        value="{{ request.form['recurrence_end_date'] or app.get('recurrence_end_date') or '' }}">
    </div>

    <!-- Weekly Options -->
    <div id="weekly_options" style="display: none;">
      <label for="weekdays">{{ _('Active Days') }}</label> {{ _('(none selected is ALL selected)') }}
      <div>
        {% set selected_weekdays = request.form.getlist('weekdays') or app.get('recurrence_pattern', {}).get('weekdays',
        app.get('days', [])) %}
        <input type="checkbox" name="weekdays" value="monday" {% if 'monday' in selected_weekdays or not
          selected_weekdays %} checked {% endif %}> {{ _('Monday') }}
        <input type="checkbox" name="weekdays" value="tuesday" {% if 'tuesday' in selected_weekdays or not
          selected_weekdays %} checked {% endif %}> {{ _('Tuesday') }}
        <input type="checkbox" name="weekdays" value="wednesday" {% if 'wednesday' in selected_weekdays or not
          selected_weekdays %} checked {% endif %}> {{ _('Wednesday') }}
        <input type="checkbox" name="weekdays" value="thursday" {% if 'thursday' in selected_weekdays or not
          selected_weekdays %} checked {% endif %}> {{ _('Thursday') }}
        <input type="checkbox" name="weekdays" value="friday" {% if 'friday' in selected_weekdays or not
          selected_weekdays %} checked {% endif %}> {{ _('Friday') }}
        <input type="checkbox" name="weekdays" value="saturday" {% if 'saturday' in selected_weekdays or not
          selected_weekdays %} checked {% endif %}> {{ _('Saturday') }}
        <input type="checkbox" name="weekdays" value="sunday" {% if 'sunday' in selected_weekdays or not
          selected_weekdays %} checked {% endif %}> {{ _('Sunday') }}
      </div>
    </div>

    <!-- Monthly Options -->
    <div id="monthly_options" style="display: none;">
      <label for="monthly_pattern">{{ _('Monthly Pattern') }}</label>
      <div>
        <select name="monthly_pattern" id="monthly_pattern">
          {% set current_pattern = request.form['monthly_pattern'] or (app.get('recurrence_pattern',
          {}).get('day_of_month') and 'day_of_month') or (app.get('recurrence_pattern', {}).get('day_of_week') and
          'day_of_week') or 'day_of_month' %}
          <option value="day_of_month" {% if current_pattern=='day_of_month' %} selected {% endif %}>{{ _('Day of
            Month') }}</option>
          <option value="day_of_week" {% if current_pattern=='day_of_week' %} selected {% endif %}>{{ _('Day of Week')
            }}</option>
        </select>
      </div>

      <div id="day_of_month_option">
        <label for="day_of_month">{{ _('Day of Month') }}</label>
        <div>
          <input type="number" name="day_of_month" id="day_of_month" min="1" max="31"
            value="{{ request.form['day_of_month'] or app.get('recurrence_pattern', {}).get('day_of_month', 1) }}">
        </div>
      </div>

      <div id="day_of_week_option" style="display: none;">
        <label for="day_of_week_pattern">{{ _('Day of Week Pattern') }}</label>
        <div style="display: flex; gap: 10px; align-items: center;">
          <select name="week_occurrence" id="week_occurrence">
            {% set current_occurrence = (request.form['day_of_week_pattern'] or app.get('recurrence_pattern',
            {}).get('day_of_week', 'first_monday')).split('_')[0] %}
            <option value="first" {% if current_occurrence=='first' %} selected {% endif %}>{{ _('First') }}</option>
            <option value="second" {% if current_occurrence=='second' %} selected {% endif %}>{{ _('Second') }}</option>
            <option value="third" {% if current_occurrence=='third' %} selected {% endif %}>{{ _('Third') }}</option>
            <option value="fourth" {% if current_occurrence=='fourth' %} selected {% endif %}>{{ _('Fourth') }}</option>
            <option value="last" {% if current_occurrence=='last' %} selected {% endif %}>{{ _('Last') }}</option>
          </select>
          <select name="week_day" id="week_day">
            {% set current_day = (request.form['day_of_week_pattern'] or app.get('recurrence_pattern',
            {}).get('day_of_week', 'first_monday')).split('_')[1] %}
            <option value="monday" {% if current_day=='monday' %} selected {% endif %}>{{ _('Monday') }}</option>
            <option value="tuesday" {% if current_day=='tuesday' %} selected {% endif %}>{{ _('Tuesday') }}</option>
            <option value="wednesday" {% if current_day=='wednesday' %} selected {% endif %}>{{ _('Wednesday') }}
            </option>
            <option value="thursday" {% if current_day=='thursday' %} selected {% endif %}>{{ _('Thursday') }}</option>
            <option value="friday" {% if current_day=='friday' %} selected {% endif %}>{{ _('Friday') }}</option>
            <option value="saturday" {% if current_day=='saturday' %} selected {% endif %}>{{ _('Saturday') }}</option>
            <option value="sunday" {% if current_day=='sunday' %} selected {% endif %}>{{ _('Sunday') }}</option>
          </select>
          <!-- Hidden input to combine the values for form submission -->
          <input type="hidden" name="day_of_week_pattern" id="day_of_week_pattern" value="">
        </div>
      </div>
    </div>
  </div>

  <div style="display: flex; gap: 10px; margin-top: 20px;">
    <input type="submit" class="w3-button w3-green w3-round" value="{{ _('Save') }}">
    <input type="submit" class="w3-button w3-red w3-round"
      formaction="{{ url_for('manager.deleteapp', device_id=device_id,iname=app['iname']) }}" formmethod="post"
      onclick="return confirm('{{ _('Delete App?') }}');" value="{{ _('Delete') }}">
  </div>
</form>

<!-- API Examples Section -->
<div style="margin-top: 30px; padding: 20px; background-color: #2a2a2a; border-radius: 8px; border-left: 4px solid #4CAF50;">
  <h2 style="margin-top: 0; color: #4CAF50;">{{ _('API Usage') }}</h2>
  <p style="color: #b0b0b0; margin-bottom: 20px;">{{ _('Use these curl commands to control this app via the API:') }}</p>

  <!-- Enable App -->
  <div style="margin-bottom: 20px;">
    <h3 style="color: #4CAF50; font-size: 1.1em; margin-bottom: 10px;">{{ _('Enable App') }}</h3>
    <pre style="background-color: #1e1e1e; padding: 15px; border-radius: 4px; overflow-x: auto; color: #e0e0e0; font-size: 0.9em;">curl -X PATCH \
  -H "Authorization: Bearer {{ device.get('api_key', 'YOUR_API_KEY') }}" \
  -H "Content-Type: application/json" \
  -d '{"set_enabled": true}' \
  {{ request.url_root }}v0/devices/{{ device_id }}/installations/{{ app['iname'] }}</pre>
  </div>

  <!-- Disable App -->
  <div style="margin-bottom: 20px;">
    <h3 style="color: #ff9800; font-size: 1.1em; margin-bottom: 10px;">{{ _('Disable App') }}</h3>
    <pre style="background-color: #1e1e1e; padding: 15px; border-radius: 4px; overflow-x: auto; color: #e0e0e0; font-size: 0.9em;">curl -X PATCH \
  -H "Authorization: Bearer {{ device.get('api_key', 'YOUR_API_KEY') }}" \
  -H "Content-Type: application/json" \
  -d '{"set_enabled": false}' \
  {{ request.url_root }}v0/devices/{{ device_id }}/installations/{{ app['iname'] }}</pre>
  </div>

  <!-- Pin App -->
  <div style="margin-bottom: 20px;">
    <h3 style="color: #4CAF50; font-size: 1.1em; margin-bottom: 10px;">{{ _('Pin App') }}</h3>
    <pre style="background-color: #1e1e1e; padding: 15px; border-radius: 4px; overflow-x: auto; color: #e0e0e0; font-size: 0.9em;">curl -X PATCH \
  -H "Authorization: Bearer {{ device.get('api_key', 'YOUR_API_KEY') }}" \
  -H "Content-Type: application/json" \
  -d '{"set_pinned": true}' \
  {{ request.url_root }}v0/devices/{{ device_id }}/installations/{{ app['iname'] }}</pre>
  </div>

  <!-- Unpin App -->
  <div style="margin-bottom: 20px;">
    <h3 style="color: #ff9800; font-size: 1.1em; margin-bottom: 10px;">{{ _('Unpin App') }}</h3>
    <pre style="background-color: #1e1e1e; padding: 15px; border-radius: 4px; overflow-x: auto; color: #e0e0e0; font-size: 0.9em;">curl -X PATCH \
  -H "Authorization: Bearer {{ device.get('api_key', 'YOUR_API_KEY') }}" \
  -H "Content-Type: application/json" \
  -d '{"set_pinned": false}' \
  {{ request.url_root }}v0/devices/{{ device_id }}/installations/{{ app['iname'] }}</pre>
  </div>

  <p style="color: #888; font-size: 0.9em; margin-top: 20px;">
    <strong>{{ _('Note:') }}</strong> {{ _('Replace YOUR_API_KEY with your device API key if not using the one shown above.') }}
  </p>
</div>

<!-- style and javascript to show and hide the config -->
<style>
  .hidden {
    display: none;
    opacity: 0;
    transition: opacity 0.5s ease-in-out;
  }

  .visible {
    display: block;
    opacity: 1;
    transition: opacity 0.5s ease-in-out;
  }
</style>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const toggleBtn = document.getElementById("toggleConfigBtn");
    const configContent = document.getElementById("configContent");

    toggleBtn.addEventListener("click", function () {
      if (configContent.classList.contains("hidden")) {
        configContent.classList.remove("hidden");
        configContent.classList.add("visible");
        toggleBtn.textContent = "{{ _('Hide App Config') }}";
      } else {
        configContent.classList.remove("visible");
        configContent.classList.add("hidden");
        toggleBtn.textContent = "{{ _('Show App Config') }}";
      }
    });

    // Add debug toggle functionality
    const toggleDebugBtn = document.getElementById("toggleDebugBtn");
    const debugContent = document.getElementById("debugContent");

    toggleDebugBtn.addEventListener("click", function () {
      if (debugContent.classList.contains("hidden")) {
        debugContent.classList.remove("hidden");
        debugContent.classList.add("visible");
        toggleDebugBtn.textContent = "{{ _('Hide Render Debug') }}";
      } else {
        debugContent.classList.remove("visible");
        debugContent.classList.add("hidden");
        toggleDebugBtn.textContent = "{{ _('Show Render Debug') }}";
      }
    });

    // Initialize recurrence options on page load
    toggleCustomRecurrence();

    // Initialize monthly pattern options
    const monthlyPatternSelect = document.getElementById("monthly_pattern");
    if (monthlyPatternSelect) {
      monthlyPatternSelect.addEventListener("change", toggleMonthlyPatternOptions);
      toggleMonthlyPatternOptions();
    }

    // Add event listeners for the week occurrence and day dropdowns
    const weekOccurrenceSelect = document.getElementById("week_occurrence");
    const weekDaySelect = document.getElementById("week_day");
    if (weekOccurrenceSelect && weekDaySelect) {
      weekOccurrenceSelect.addEventListener("change", updateDayOfWeekPattern);
      weekDaySelect.addEventListener("change", updateDayOfWeekPattern);
      updateDayOfWeekPattern(); // Initialize on page load
    }
  });

  function toggleCustomRecurrence() {
    const useCustom = document.getElementById("use_custom_recurrence").checked;
    const legacySchedule = document.getElementById("legacy_schedule");
    const customRecurrence = document.getElementById("custom_recurrence");

    if (useCustom) {
      legacySchedule.style.display = "none";
      customRecurrence.style.display = "block";
      // Initialize custom recurrence options
      toggleRecurrenceOptions();
    } else {
      legacySchedule.style.display = "block";
      customRecurrence.style.display = "none";
    }
  }

  function toggleRecurrenceOptions() {
    const recurrenceType = document.getElementById("recurrence_type").value;
    const intervalUnit = document.getElementById("interval_unit");
    const weeklyOptions = document.getElementById("weekly_options");
    const monthlyOptions = document.getElementById("monthly_options");

    // Update interval unit text
    switch (recurrenceType) {
      case "daily":
        intervalUnit.textContent = "{{ _('days') }}";
        break;
      case "weekly":
        intervalUnit.textContent = "{{ _('weeks') }}";
        break;
      case "monthly":
        intervalUnit.textContent = "{{ _('months') }}";
        break;
      case "yearly":
        intervalUnit.textContent = "{{ _('years') }}";
        break;
    }

    // Show/hide relevant options
    weeklyOptions.style.display = (recurrenceType === "weekly") ? "block" : "none";
    monthlyOptions.style.display = (recurrenceType === "monthly") ? "block" : "none";
  }

  function toggleMonthlyPatternOptions() {
    const monthlyPattern = document.getElementById("monthly_pattern").value;
    const dayOfMonthOption = document.getElementById("day_of_month_option");
    const dayOfWeekOption = document.getElementById("day_of_week_option");

    if (monthlyPattern === "day_of_month") {
      dayOfMonthOption.style.display = "block";
      dayOfWeekOption.style.display = "none";
    } else {
      dayOfMonthOption.style.display = "none";
      dayOfWeekOption.style.display = "block";
    }
  }

  function updateDayOfWeekPattern() {
    const occurrence = document.getElementById("week_occurrence").value;
    const day = document.getElementById("week_day").value;
    const hiddenField = document.getElementById("day_of_week_pattern");

    if (occurrence && day) {
      hiddenField.value = occurrence + "_" + day;
    }
  }
</script>
{% endblock %}
