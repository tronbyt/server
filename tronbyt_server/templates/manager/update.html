{% extends 'base.html' %}
{% block header %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/update-simple.css') }}">
<script src="{{ url_for('static', filename='js/location.js') }}"></script>
<div class="header-container">
  <h1 class="page-title">{% block title %}{{ _('Edit Device') }}: "{{ device['name'] }}"{% endblock %}</h1>
  <div id="header-buttons"></div>
</div>
<script>
  function setBrightnessUpdate(brightness) {
    document.getElementById('brightness').value = brightness;
    const buttons = document.querySelectorAll('#brightness-panel .brightness-btn');
    buttons.forEach(btn => {
      if (parseInt(btn.dataset.brightness) === parseInt(brightness)) {
        btn.classList.add('active');
      } else {
        btn.classList.remove('active');
      }
    });
  }

  function setNightBrightnessUpdate(brightness) {
    document.getElementById('night_brightness').value = brightness;
    const buttons = document.querySelectorAll('#night-brightness-panel .brightness-btn');
    buttons.forEach(btn => {
      if (parseInt(btn.dataset.brightness) === parseInt(brightness)) {
        btn.classList.add('active');
      } else {
        btn.classList.remove('active');
      }
    });
  }

  function setDimBrightnessUpdate(brightness) {
    document.getElementById('dim_brightness').value = brightness;
    const buttons = document.querySelectorAll('#dim-brightness-panel .brightness-btn');
    buttons.forEach(btn => {
      if (parseInt(btn.dataset.brightness) === parseInt(brightness)) {
        btn.classList.add('active');
      } else {
        btn.classList.remove('active');
      }
    });
  }

  // Move buttons to header on page load
  document.addEventListener('DOMContentLoaded', function() {
    const headerButtons = document.getElementById('header-buttons');
    const form = document.getElementById('device-form');

    // Create Save button
    const saveBtn = document.createElement('button');
    saveBtn.type = 'button';
    saveBtn.className = 'w3-button w3-green config-management-btn';
    saveBtn.textContent = '{{ _('Save') }}';
    saveBtn.onclick = function() {
      if (confirm('{{ _('Save device settings?') }}')) {
        form.submit();
      }
    };

    // Create Delete button
    const deleteBtn = document.createElement('button');
    deleteBtn.type = 'button';
    deleteBtn.className = 'w3-button w3-red config-management-btn';
    deleteBtn.textContent = '{{ _('Delete') }}';
    deleteBtn.onclick = function() {
      if (confirm('{{ _('Delete device and ALL apps? This action cannot be undone.') }}')) {
        form.action = "{{ url_for('manager.delete', device_id=device['id']) }}";
        form.method = 'post';
        form.submit();
      }
    };

    headerButtons.appendChild(saveBtn);
    headerButtons.appendChild(deleteBtn);
  });
</script>
{% endblock %}
{% block content %}
<form method="post" id="device-form">
  <h1>{{ _('Device Settings') }}</h1>

  <div class="device-settings-section">
    <h2>{{ _('Basic Information') }}</h2>
    
    <div class="device-settings-row">
      <div>
        <label for="name" class="device-settings-label">{{ _('Device Name') }}</label>
        <input name="name" id="name" value="{{ request.form['name'] or device['name'] }}" required class="device-settings-input">
      </div>
      <div>
        <label for="device_type" class="device-settings-label">{{ _('Device Type') }}</label>
        <select name="device_type" id="device_type" class="device-settings-input">
          <option value="tidbyt_gen1" {% if device.get('type')=='tidbyt_gen1' %}selected{% endif %}>Tidbyt Gen1</option>
          <option value="tidbyt_gen2" {% if device.get('type')=='tidbyt_gen2' %}selected{% endif %}>Tidbyt Gen2</option>
          <option value="pixoticker" {% if device.get('type')=='pixoticker' %}selected{% endif %}>Pixoticker</option>
          <option value="tronbyt_s3" {% if device.get('type')=='tronbyt_s3' %}selected{% endif %}>Tronbyt S3</option>
          <option value="tronbyt_s3_wide" {% if device.get('type')=='tronbyt_s3_wide' %}selected{% endif %}>Tronbyt S3 Wide</option>
          <option value="raspberrypi" {% if device.get('type')=='raspberrypi' %}selected{% endif %}>Raspberry Pi</option>
          <option value="other" {% if device.get('type')=='other' %}selected{% endif %}>Other</option>
        </select>
      </div>
    </div>

    <div class="device-settings-section-divider">
      <h3>{{ _('Connection URLs') }}</h3>
      
      <table class="device-settings-table">
        <tr>
          <td>
            <label for="img_url" class="device-settings-label">{{ _('Image URL') }}</label>
          </td>
          <td>
            <div class="url-input-container">
              <input name="img_url" id="img_url" value="{{ device['img_url'] }}"
                oninput="updateExampleCommands()">
              <button type="button" class="w3-button w3-small w3-gray url-reset-btn" onclick="resetImgUrl()"
                title="{{ _('Reset to default') }}">{{ _('Reset') }}</button>
            </div>
          </td>
        </tr>
        <tr>
          <td>
            <label for="ws_url" class="device-settings-label">{{ _('Websocket URL') }}</label>
          </td>
          <td>
            <div class="url-input-container">
              <input name="ws_url" id="ws_url" value="{{ device['ws_url'] }}">
              <button type="button" class="w3-button w3-small w3-gray url-reset-btn" onclick="resetWsUrl()"
                title="{{ _('Reset to default') }}">{{ _('Reset') }}</button>
            </div>
          </td>
        </tr>
      </table>
    </div>
  </div>

    <script>
      function resetImgUrl() {
        document.getElementById('img_url').value = '{{ default_img_url }}';
        updateExampleCommands(); // Update example commands if they exist
      }

      function resetWsUrl() {
        document.getElementById('ws_url').value = '{{ default_ws_url }}';
      }
    </script>

  <div class="device-settings-section">
    <h2>{{ _('Display Settings') }}</h2>
    
    <table class="device-settings-table">
      <tr>
        <td>
          <label for="default_interval" class="device-settings-label">{{ _('App Cycle Time (Seconds)') }}</label>
        </td>
        <td>
          <div class="range-container">
            <input type="range" name="default_interval" id="default_interval" min="1" max="30"
              value="{{ device['default_interval'] }}" oninput="this.nextElementSibling.value = this.value">
            <output class="range-output">{{ device['default_interval'] }}</output>
          </div>
        </td>
      </tr>
    </table>

    <div class="device-settings-section-divider">
      <h3>{{ _('Brightness Settings') }}</h3>
      
      <table class="device-settings-table">
        <tr>
          <td>
            <label for="brightness" class="device-settings-label">{{ _('Brightness') }}</label>
          </td>
          <td>
            <input type="hidden" name="brightness" id="brightness" value="{{ device['brightness'] }}">
            <div class="brightness-panel" id="brightness-panel">
              <button type="button" class="brightness-btn {% if device['brightness'] == 0 %}active{% endif %}"
                      data-brightness="0" onclick="setBrightnessUpdate(0)">0</button>
              <button type="button" class="brightness-btn {% if device['brightness'] == 1 %}active{% endif %}"
                      data-brightness="1" onclick="setBrightnessUpdate(1)">1</button>
              <button type="button" class="brightness-btn {% if device['brightness'] == 2 %}active{% endif %}"
                      data-brightness="2" onclick="setBrightnessUpdate(2)">2</button>
              <button type="button" class="brightness-btn {% if device['brightness'] == 3 %}active{% endif %}"
                      data-brightness="3" onclick="setBrightnessUpdate(3)">3</button>
              <button type="button" class="brightness-btn {% if device['brightness'] == 4 %}active{% endif %}"
                      data-brightness="4" onclick="setBrightnessUpdate(4)">4</button>
              <button type="button" class="brightness-btn {% if device['brightness'] == 5 %}active{% endif %}"
                      data-brightness="5" onclick="setBrightnessUpdate(5)">5</button>
            </div>
          </td>
        </tr>
      </table>
    </div>
  </div>

  <div class="device-settings-section">
    <h2>{{ _('Night Mode Settings') }}</h2>
    
    <table class="device-settings-table">
      <tr>
        <td>
          <label for="night_mode_enabled" class="device-settings-label">{{ _('Enable Night Mode') }}</label>
        </td>
        <td>
          <input type="checkbox" name="night_mode_enabled" id="night_mode_enabled" {% if device['night_mode_enabled'] %}checked{% endif %}>
        </td>
      </tr>
    </table>

    <div class="device-settings-section-divider">
      <h3>{{ _('Night Mode Configuration') }}</h3>
      
      <table class="device-settings-table">
        <tr>
          <td>
            <label for="night_start" class="device-settings-label">{{ _('Night Start Time') }}</label>
          </td>
          <td>
            <input type="time" name="night_start" id="night_start" value="{{ device.get('night_start', '22:00') }}" class="device-settings-input">
          </td>
        </tr>
        <tr>
          <td>
            <label for="night_end" class="device-settings-label">{{ _('Night End Time') }}</label>
          </td>
          <td>
            <input type="time" name="night_end" id="night_end" value="{{ device.get('night_end', '06:00') }}" class="device-settings-input">
          </td>
        </tr>
        <tr>
          <td>
            <label for="night_brightness" class="device-settings-label">{{ _('Night Brightness') }}</label>
          </td>
          <td>
            <input type="hidden" name="night_brightness" id="night_brightness" value="{{ device.get('night_brightness', 1) }}">
            <div class="brightness-panel" id="night-brightness-panel">
              <button type="button" class="brightness-btn {% if device.get('night_brightness', 1) == 0 %}active{% endif %}"
                      data-brightness="0" onclick="setNightBrightnessUpdate(0)">0</button>
              <button type="button" class="brightness-btn {% if device.get('night_brightness', 1) == 1 %}active{% endif %}"
                      data-brightness="1" onclick="setNightBrightnessUpdate(1)">1</button>
              <button type="button" class="brightness-btn {% if device.get('night_brightness', 1) == 2 %}active{% endif %}"
                      data-brightness="2" onclick="setNightBrightnessUpdate(2)">2</button>
              <button type="button" class="brightness-btn {% if device.get('night_brightness', 1) == 3 %}active{% endif %}"
                      data-brightness="3" onclick="setNightBrightnessUpdate(3)">3</button>
              <button type="button" class="brightness-btn {% if device.get('night_brightness', 1) == 4 %}active{% endif %}"
                      data-brightness="4" onclick="setNightBrightnessUpdate(4)">4</button>
              <button type="button" class="brightness-btn {% if device.get('night_brightness', 1) == 5 %}active{% endif %}"
                      data-brightness="5" onclick="setNightBrightnessUpdate(5)">5</button>
            </div>
          </td>
        </tr>
        <tr>
          <td>
            <label for="night_mode_app" class="device-settings-label">{{ _('Night Mode App') }}</label>
          </td>
          <td>
            <select name="night_mode_app" id="night_mode_app" class="select-container">
              <option value="None">{{ _('None') }}</option>
              {% if 'apps' in device %}
              {% for app in device['apps'].values() %}
              <option value="{{ app['iname'] }}" {% if 'night_mode_app' in device and device['night_mode_app']==app['iname'] %}selected{% endif %}>
                {{ app['iname'] }} {{ app['name'] }}
              </option>
              {% endfor %}
              {% endif %}
            </select>
            <small class="small-text">{{ _('To prevent the night mode app from displaying during the day, set it to disabled on the app edit page.') }}</small>
          </td>
        </tr>
      </table>
    </div>
  </div>

  <div class="device-settings-section">
    <h2>{{ _('Dim Mode Settings') }}</h2>
    
    <table class="device-settings-table">
      <tr>
        <td>
          <label for="dim_time" class="device-settings-label">{{ _('Dim Start Time') }}</label>
        </td>
        <td>
          <input type="time" name="dim_time" id="dim_time" value="{{ device.get('dim_time', '') }}" class="device-settings-input">
          <small class="small-text">{{ _('Leave empty to disable dim mode. Dim mode ends at Night End Time (if set) or 6:00 AM by default.') }}</small>
        </td>
      </tr>
      <tr>
        <td>
          <label for="dim_brightness" class="device-settings-label">{{ _('Dim Brightness') }}</label>
        </td>
        <td>
          <input type="hidden" name="dim_brightness" id="dim_brightness" value="{{ device.get('dim_brightness', 2) }}">
          <div class="brightness-panel" id="dim-brightness-panel">
            <button type="button" class="brightness-btn {% if device.get('dim_brightness', 2) == 0 %}active{% endif %}"
                    data-brightness="0" onclick="setDimBrightnessUpdate(0)">0</button>
            <button type="button" class="brightness-btn {% if device.get('dim_brightness', 2) == 1 %}active{% endif %}"
                    data-brightness="1" onclick="setDimBrightnessUpdate(1)">1</button>
            <button type="button" class="brightness-btn {% if device.get('dim_brightness', 2) == 2 %}active{% endif %}"
                    data-brightness="2" onclick="setDimBrightnessUpdate(2)">2</button>
            <button type="button" class="brightness-btn {% if device.get('dim_brightness', 2) == 3 %}active{% endif %}"
                    data-brightness="3" onclick="setDimBrightnessUpdate(3)">3</button>
            <button type="button" class="brightness-btn {% if device.get('dim_brightness', 2) == 4 %}active{% endif %}"
                    data-brightness="4" onclick="setDimBrightnessUpdate(4)">4</button>
            <button type="button" class="brightness-btn {% if device.get('dim_brightness', 2) == 5 %}active{% endif %}"
                    data-brightness="5" onclick="setDimBrightnessUpdate(5)">5</button>
          </div>
        </td>
      </tr>
    </table>
  </div>

  <div class="device-settings-section">
    <h2>{{ _('Location & API Settings') }}</h2>
    
    <table class="device-settings-table">
      <tr>
        <td>
          <label for="location_search" class="device-settings-label">{{ _('Location') }}</label>
        </td>
        <td>
          <input type="text" id="location_search" placeholder="{{ _('Enter a location') }}"
            value="{{ request.form.get('location_search') or (device.get('location') or {}).get('description', '') }}" class="device-settings-input">
          <ul id="location_results"></ul>
          <input type="hidden" name="location" id="location"
            value='{{ (request.form.get("location") or device.get("location") or {}) | tojson }}'>
        </td>
      </tr>
    </table>

    <div class="device-settings-section-divider">
      <h3>{{ _('API Configuration') }}</h3>
      
      <table class="device-settings-table">
        <tr>
          <td>
            <label for="device_id" class="device-settings-label">{{ _('Device ID') }}</label>
          </td>
          <td>
            <input id="device_id" value="{{ device['id'] }}" readonly class="device-settings-input">
          </td>
        </tr>
        <tr>
          <td>
            <label for="api_key" class="device-settings-label">{{ _('Device API Key') }}</label>
          </td>
          <td>
            <input name="api_key" id="api_key" value="{{ request.form['api_key'] or device['api_key'] }}"
              oninput="updateExampleCommands()" class="device-settings-input">
          </td>
        </tr>
        <tr>
          <td>
            <label for="curl_example" class="device-settings-label">{{ _('Example curl Command') }}</label>
          </td>
          <td>
            <textarea id="curl_example" rows="3" readonly class="device-example-command-input"></textarea>
          </td>
        </tr>
        <tr>
          <td>
            <label for="pixlet_example" class="device-settings-label">{{ _('Example pixlet Command') }}</label>
          </td>
          <td>
            <textarea id="pixlet_example" rows="3" readonly class="device-example-command-input"></textarea>
          </td>
        </tr>
      </table>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      enableLocationSearch(document.getElementById('location_search'), document.getElementById('location_results'), document.getElementById('location'), null);
    });
  </script>

    <script>
      function parseImageUrl(imageUrl) {
        try {
          const url = new URL(imageUrl);
          const pathParts = url.pathname.split("/").filter(Boolean);
          const deviceId = pathParts[0];
          const server = `${url.protocol}//${url.host}`;
          return { server, deviceId };
        } catch (e) {
          return { server: 'http://localhost:8000', deviceId: 'UNKNOWN' };
        }
      }

      function updateExampleCommands() {
        const apiKey = document.getElementById("api_key").value.trim();
        const imageUrl = document.getElementById("img_url").value.trim();
        const { server, deviceId } = parseImageUrl(imageUrl);

        const curl = `curl -X POST ${server}/v0/devices/${deviceId}/push -H 'Authorization: ${apiKey || 'CHANGEME'}' -H 'Content-Type: application/json' --data '{"image": "'$(base64 -w 0 -i test.webp)'"}'`;
        document.getElementById("curl_example").value = curl;

        const pixlet = `pixlet push -u ${server} -t '${apiKey || 'CHANGEME'}' ${deviceId} test.webp`;
        document.getElementById("pixlet_example").value = pixlet;
      }

      // Update curl command on page load
      document.addEventListener("DOMContentLoaded", updateExampleCommands);
    </script>

  <div class="device-settings-section">
    <h2>{{ _('Additional Settings') }}</h2>
    
    <table class="device-settings-table">
      <tr>
        <td>
          <label for="notes" class="device-settings-label">{{ _('Notes') }}</label>
        </td>
        <td>
          <input name="notes" id="notes" value="{{ request.form['notes'] or device['notes'] }}" class="notes-input" placeholder="{{ _('Optional notes about this device') }}">
        </td>
      </tr>
    </table>
  </div>

  <div class="device-settings-section">
    <h2>{{ _('Configuration Management') }}</h2>
    
    <div class="config-management-container">
      <a href="{{ url_for('manager.export_device_config', device_id=device['id']) }}" class="w3-button w3-blue config-management-btn">
        ðŸ“¥ {{ _('Export Configuration') }}
      </a>
      <a href="{{ url_for('manager.import_device_config', device_id=device['id']) }}" class="w3-button w3-orange config-management-btn">
        ðŸ“¤ {{ _('Import Configuration') }}
      </a>
    </div>
  </div>
</form>
{% endblock %}
