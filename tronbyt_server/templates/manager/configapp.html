{% extends 'base.html' %}
{% block header %}
<link rel="stylesheet" href="{{ url_for('static', path='css/configapp-simple.css') }}">
<link rel="stylesheet" href="{{ url_for('static', path='css/updateapp-simple.css') }}">
<script src="{{ url_for('static', path='js/location.js') }}"></script>
<script src="{{ url_for('static', path='js/manager.js') }}"></script>
<h1>{% block title %}{{ _('Configuring') }} {{ app.iname }} ({{ app.name}}){% endblock %}</h1>
{% endblock %}
{% block content %}
<!-- Navigation and Toggle Buttons -->
<div class="flex-container">
  <!-- Toggle Buttons -->
  <div class="toggle-buttons">
    <button id="toggleConfigBtn" class="w3-button" style="background-color: var(--primary-color); color: white;"><i class="fa-solid fa-file-code" aria-hidden="true"></i> <span class="button-label">{{ _('Show App Config') }}</span></button>
    <button id="toggleDebugBtn" class="w3-button" style="background-color: var(--primary-color); color: white;"><i class="fa-solid fa-bug" aria-hidden="true"></i> <span class="button-label">{{ _('Show Render Debug') }}</span></button>

  </div>

  <!-- Action Buttons -->
  <div class="action-buttons">
    <button type="button" class="w3-button w3-green w3-round" id="saveButton"><i class="fa-solid fa-floppy-disk" aria-hidden="true"></i> {{ _('Save') }}</button>
    <button type="button" class="w3-button w3-red w3-round" id="cancelButtonTop"><i class="fa-solid fa-circle-xmark" aria-hidden="true"></i> {{ _('Cancel') }}</button>
  </div>
</div>

<!-- Config Content -->
<div id="configContent" class="hidden">
  <pre class="flash">{{ config | tojson(indent=2) }}</pre>
</div>

<!-- Debug Content -->
<div id="debugContent" class="hidden">
  <pre class="flash">{{ (app.render_messages or []) | join('\n') }}</pre>
</div>

<!-- App Preview -->
<div class="app-img">
  <img id="previewImage"
    src="{{ url_for('preview', device_id=device['id'], iname=app['iname']) }}?config={{ config | tojson | urlencode }}"
    alt="{{ _('Preview') }}">
  <div class="skeleton-loader"></div>
</div>

<form method="post" id="dynamicForm">
    <!-- Schema Config Section -->
    <h2>{{ _('App Configuration') }}</h2>
    <table id="schemaConfigContainer" class="form-table" style="border-spacing: 0 15px;">
        <!-- Schema fields will be injected here -->
    </table>

    <hr>

    <!-- App Settings Section -->
    <h2>{{ _('Settings') }}</h2>
    <table class="form-table">
        <!-- Name (ReadOnly) -->
        <tr>
            <td><label>{{ _('Name') }}</label></td>
            <td><input type="text" id="name" name="name" class="form-control" value="{{ app.name }}" readonly></td>
        </tr>
        <!-- Enabled Status -->
        <tr>
          <td>
            <label for="enabled">{{ _('Enabled') }}</label>
            <small>{{ _('Enable or disable this app') }}</small>
          </td>
          <td>
            <input name="enabled" type="checkbox" id="enabled" class="form-control"
                   {% if app.enabled %} checked {% endif %} data-default="{{ 'true' if app.enabled else 'false' }}">
          </td>
        </tr>

        <!-- Autopin Status -->
        <tr>
          <td>
            <label for="autopin">{{ _('Autopin') }}</label>
            <small>{{ _('Automatically pin this app when it renders successfully') }}</small>
          </td>
          <td>
            <input name="autopin" type="checkbox" id="autopin" class="form-control"
                   {% if app.autopin %} checked {% endif %} data-default="{{ 'true' if app.autopin else 'false' }}">
          </td>
        </tr>

        <!-- Render Interval -->
        <tr>
          <td>
            <label for="uinterval">{{ _('Render Interval Minutes') }}</label>
            <small>{{ _('Update every X minutes') }}</small>
          </td>
          <td>
            <input type="number" name="uinterval" id="uinterval" min="0" class="form-control"
                   value="{{ app.uinterval }}" data-default="{{ app.uinterval }}" required>
          </td>
        </tr>

        <!-- Display Time -->
        <tr>
          <td>
            <label for="display_time">{{ _('Display Time Seconds') }}</label>
            <small>{{ _('0 for device default') }}</small>
          </td>
          <td>
            <input type="number" name="display_time" id="display_time" min="0" class="form-control"
                   value="{{ app.display_time or 0 }}" data-default="{{ app.display_time or 0 }}">
          </td>
        </tr>

        <!-- Color Filter -->
        <tr>
          <td>
            <label for="color_filter">{{ _('Color Filter') }}</label>
            <span class="tooltip-icon" title="{{ _('Apply custom filters to the image:
            None: No transformation
            Dimmed: Darkens image uniformly while preserving hue
            Redshift: CCT-derived chromatic adaptation matrix ~3400K target
            Warm: Adds a subtle warm, orange/yellow hue
            Sunset: Emulates deep pink/orange of a setting sun
            Sepia: Adds a warm, antique brown tone mimicking aged photographs
            Vintage: Muted, brown/green nostalgic tones
            Dusk: Fades brightness, adds reddish cast
            Cool: Adds a cool, blue tint
            Black & White: Converts image to perceptual grayscale using luminance weights
            Ice: Pale desaturation with bluish cast
            Moonlight: Dim blue-gray, night lighting effect
            Neon: Boosts contrast, magenta-blue cyberpunk
            Pastel: Softens tones, gentle highlight boost') }}">â“˜</span>
            <small>{{ _('Override device color filter') }}</small>
          </td>
          <td>
            <select name="color_filter" id="color_filter" class="form-control">
              {% for value, name in color_filter_choices.items() %}
              <option value="{{ value }}" {% if app.color_filter==value %}selected{% endif %}>{{ _(name) }}</option>
              {% endfor %}
            </select>
          </td>
        </tr>

        <!-- Notes -->
        <tr>
          <td>
            <label for="notes">{{ _('Notes') }}</label>
            <small>{{ _('Optional notes about this app') }}</small>
          </td>
          <td>
            <input name="notes" id="notes" class="form-control"
                   value="{{ app.notes }}" data-default="{{ app.notes }}">
          </td>
        </tr>
    </table>

    <hr>

    <!-- Schedule Section -->
    <div class="schedule-section">
        <h2>{{ _('Schedule') }}</h2>

        <table class="form-table">
          <!-- Start Time -->
          <tr>
            <td>
              <label for="start_time">{{ _('Start Time') }}</label>
              <small>{{ _('When the app should start displaying') }}</small>
            </td>
            <td>
              <input type="time" name="start_time" id="start_time" class="form-control"
                     value="{{ app.start_time }}" data-default="{{ app.start_time or '' }}">
            </td>
          </tr>

          <!-- End Time -->
          <tr>
            <td>
              <label for="end_time">{{ _('End Time') }}</label>
              <small>{{ _('When the app should stop displaying') }}</small>
            </td>
            <td>
              <input type="time" name="end_time" id="end_time" class="form-control"
                     value="{{ app.end_time }}" data-default="{{ app.end_time or '' }}">
            </td>
          </tr>
        </table>

        <!-- Legacy Schedule (Default) -->
        <div id="legacy_schedule">
          <h3>{{ _('Active Days') }}</h3>
          <small>{{ _('(none selected is ALL selected)') }}</small>
          <div style="margin-top: 10px;">
            <label style="display: inline-block; margin-right: 15px; margin-bottom: 5px;">
              <input type="checkbox" name="days" value="monday" {% if 'monday' in app.days or not app.days %} checked {% endif %} data-default="{{ 'true' if 'monday' in app.days or not app.days else 'false' }}"> {{ _('Monday') }}
            </label>
            <label style="display: inline-block; margin-right: 15px; margin-bottom: 5px;">
              <input type="checkbox" name="days" value="tuesday" {% if 'tuesday' in app.days or not app.days %} checked {% endif %} data-default="{{ 'true' if 'tuesday' in app.days or not app.days else 'false' }}"> {{ _('Tuesday') }}
            </label>
            <label style="display: inline-block; margin-right: 15px; margin-bottom: 5px;">
              <input type="checkbox" name="days" value="wednesday" {% if 'wednesday' in app.days or not app.days %} checked {% endif %} data-default="{{ 'true' if 'wednesday' in app.days or not app.days else 'false' }}"> {{ _('Wednesday') }}
            </label>
            <label style="display: inline-block; margin-right: 15px; margin-bottom: 5px;">
              <input type="checkbox" name="days" value="thursday" {% if 'thursday' in app.days or not app.days %} checked {% endif %} data-default="{{ 'true' if 'thursday' in app.days or not app.days else 'false' }}"> {{ _('Thursday') }}
            </label>
            <label style="display: inline-block; margin-right: 15px; margin-bottom: 5px;">
              <input type="checkbox" name="days" value="friday" {% if 'friday' in app.days or not app.days %} checked {% endif %} data-default="{{ 'true' if 'friday' in app.days or not app.days else 'false' }}"> {{ _('Friday') }}
            </label>
            <label style="display: inline-block; margin-right: 15px; margin-bottom: 5px;">
              <input type="checkbox" name="days" value="saturday" {% if 'saturday' in app.days or not app.days %} checked {% endif %} data-default="{{ 'true' if 'saturday' in app.days or not app.days else 'false' }}"> {{ _('Saturday') }}
            </label>
            <label style="display: inline-block; margin-right: 15px; margin-bottom: 5px;">
              <input type="checkbox" name="days" value="sunday" {% if 'sunday' in app.days or not app.days %} checked {% endif %} data-default="{{ 'true' if 'sunday' in app.days or not app.days else 'false' }}"> {{ _('Sunday') }}
            </label>
          </div>
        </div>
      </div>

      <!-- Custom Recurrence Toggle -->
      <div style="margin: 20px 0;">
        <label for="use_custom_recurrence" style="display: flex; align-items: center; gap: 10px;">
          <input type="checkbox" name="use_custom_recurrence" id="use_custom_recurrence" {% if
            app.use_custom_recurrence %} checked {% endif %} data-default="{{ 'true' if app.use_custom_recurrence else 'false' }}"
            onchange="toggleCustomRecurrence()">
          <div>
            <strong>{{ _('Use Custom Recurrence') }}</strong>
            <small style="display: block; color: var(--post-about-text); margin-top: 5px;">
              {{ _('Enable advanced scheduling options (bi-weekly, monthly, yearly, etc.)') }}
            </small>
          </div>
        </label>
      </div>

      <!-- Custom Recurrence Section -->
      <div id="custom_recurrence" class="custom-recurrence-section" style="display: none;">
        <h3>{{ _('Custom Recurrence') }}</h3>

        <table class="form-table">
          <!-- Frequency -->
          <tr>
            <td>
              <label for="recurrence_type">{{ _('Frequency') }}</label>
              <small>{{ _('How often the app should run') }}</small>
            </td>
            <td>
              <select name="recurrence_type" id="recurrence_type" class="form-control" onchange="toggleRecurrenceOptions()">
                <option value="daily" {% if app.recurrence_type == 'daily' %} selected {% endif %}>{{ _('Daily') }}</option>
                <option value="weekly" {% if app.recurrence_type == 'weekly' %} selected {% endif %}>{{ _('Weekly') }}</option>
                <option value="monthly" {% if app.recurrence_type == 'monthly' %} selected {% endif %}>{{ _('Monthly') }}</option>
                <option value="yearly" {% if app.recurrence_type == 'yearly' %} selected {% endif %}>{{ _('Yearly') }}</option>
              </select>
            </td>
          </tr>

          <!-- Repeat Interval -->
          <tr>
            <td>
              <label for="recurrence_interval">{{ _('Repeat Every') }}</label>
              <small>{{ _('Interval between occurrences') }}</small>
            </td>
            <td>
              <div style="display: flex; align-items: center; gap: 10px;">
                <input type="number" name="recurrence_interval" id="recurrence_interval" min="1" max="52" class="form-control"
                  value="{{ app.recurrence_interval or 1 }}" style="width: 100px;">
                <span id="interval_unit">{{ _('days') }}</span>
              </div>
            </td>
          </tr>

          <!-- Start Date -->
          <tr>
            <td>
              <label for="recurrence_start_date">{{ _('Start Date') }}</label>
              <small>{{ _('When the recurrence should begin') }}</small>
            </td>
            <td>
              <input type="date" name="recurrence_start_date" id="recurrence_start_date" class="form-control"
                value="{{ app.recurrence_start_date or '' }}">
            </td>
          </tr>

          <!-- End Date -->
          <tr>
            <td>
              <label for="recurrence_end_date">{{ _('End Date (optional)') }}</label>
              <small>{{ _('When the recurrence should stop') }}</small>
            </td>
            <td>
              <input type="date" name="recurrence_end_date" id="recurrence_end_date" class="form-control"
                value="{{ app.recurrence_end_date or '' }}">
            </td>
          </tr>
        </table>

        <!-- Weekly Options -->
        <div id="weekly_options" style="display: none; margin-top: 20px;">
          <h4>{{ _('Weekly Options') }}</h4>
          <label for="weekdays">{{ _('Active Days') }}</label>
          <small>{{ _('(none selected is ALL selected)') }}</small>
          <div style="margin-top: 10px;">
            {% set selected_weekdays = app.recurrence_pattern.weekdays or app.days or [] %}
            <label style="display: inline-block; margin-right: 15px; margin-bottom: 5px;">
              <input type="checkbox" name="weekdays" value="monday" {% if 'monday' in selected_weekdays or not
                selected_weekdays %} checked {% endif %}> {{ _('Monday') }}
            </label>
            <label style="display: inline-block; margin-right: 15px; margin-bottom: 5px;">
              <input type="checkbox" name="weekdays" value="tuesday" {% if 'tuesday' in selected_weekdays or not
                selected_weekdays %} checked {% endif %}> {{ _('Tuesday') }}
            </label>
            <label style="display: inline-block; margin-right: 15px; margin-bottom: 5px;">
              <input type="checkbox" name="weekdays" value="wednesday" {% if 'wednesday' in selected_weekdays or not
                selected_weekdays %} checked {% endif %}> {{ _('Wednesday') }}
            </label>
            <label style="display: inline-block; margin-right: 15px; margin-bottom: 5px;">
              <input type="checkbox" name="weekdays" value="thursday" {% if 'thursday' in selected_weekdays or not
                selected_weekdays %} checked {% endif %}> {{ _('Thursday') }}
            </label>
            <label style="display: inline-block; margin-right: 15px; margin-bottom: 5px;">
              <input type="checkbox" name="weekdays" value="friday" {% if 'friday' in selected_weekdays or not
                selected_weekdays %} checked {% endif %}> {{ _('Friday') }}
            </label>
            <label style="display: inline-block; margin-right: 15px; margin-bottom: 5px;">
              <input type="checkbox" name="weekdays" value="saturday" {% if 'saturday' in selected_weekdays or not
                selected_weekdays %} checked {% endif %}> {{ _('Saturday') }}
            </label>
            <label style="display: inline-block; margin-right: 15px; margin-bottom: 5px;">
              <input type="checkbox" name="weekdays" value="sunday" {% if 'sunday' in selected_weekdays or not
                selected_weekdays %} checked {% endif %}> {{ _('Sunday') }}
            </label>
          </div>
        </div>

        <!-- Monthly Options -->
        <div id="monthly_options" style="display: none; margin-top: 20px;">
          <h4>{{ _('Monthly Options') }}</h4>

          <table class="form-table">
            <!-- Monthly Pattern -->
            <tr>
              <td>
                <label for="monthly_pattern">{{ _('Monthly Pattern') }}</label>
                <small>{{ _('Choose how to specify the monthly occurrence') }}</small>
              </td>
              <td>
                <select name="monthly_pattern" id="monthly_pattern" class="form-control">
                  {% set current_pattern = (app.recurrence_pattern.day_of_month and 'day_of_month') or (app.recurrence_pattern.day_of_week and 'day_of_week') or 'day_of_month' %}
                  <option value="day_of_month" {% if current_pattern=='day_of_month' %} selected {% endif %}>{{ _('Day of
                    Month') }}</option>
                  <option value="day_of_week" {% if current_pattern=='day_of_week' %} selected {% endif %}>{{ _('Day of Week')
                    }}</option>
                </select>
              </td>
            </tr>
          </table>

          <!-- Day of Month Option -->
          <div id="day_of_month_option">
            <table class="form-table">
              <tr>
                <td>
                  <label for="day_of_month">{{ _('Day of Month') }}</label>
                  <small>{{ _('Which day of the month (1-31)') }}</small>
                </td>
                <td>
                  <input type="number" name="day_of_month" id="day_of_month" min="1" max="31" class="form-control"
                    value="{{ app.recurrence_pattern.day_of_month or 1 }}">
                </td>
              </tr>
            </table>
          </div>

          <!-- Day of Week Option -->
          <div id="day_of_week_option" style="display: none;">
            <table class="form-table">
              <tr>
                <td>
                  <label for="day_of_week_pattern">{{ _('Day of Week Pattern') }}</label>
                  <small>{{ _('Which occurrence of which day') }}</small>
                </td>
                <td>
                  <div style="display: flex; gap: 10px; align-items: center;">
                    <select name="week_occurrence" id="week_occurrence" class="form-control">
                      {% set current_occurrence = (app.recurrence_pattern.day_of_week or 'first_monday').split('_')[0] %}
                      <option value="first" {% if current_occurrence=='first' %} selected {% endif %}>{{ _('First') }}</option>
                      <option value="second" {% if current_occurrence=='second' %} selected {% endif %}>{{ _('Second') }}</option>
                      <option value="third" {% if current_occurrence=='third' %} selected {% endif %}>{{ _('Third') }}</option>
                      <option value="fourth" {% if current_occurrence=='fourth' %} selected {% endif %}>{{ _('Fourth') }}</option>
                      <option value="last" {% if current_occurrence=='last' %} selected {% endif %}>{{ _('Last') }}</option>
                    </select>
                    <select name="week_day" id="week_day" class="form-control">
                      {% set current_day = (app.recurrence_pattern.day_of_week or 'first_monday').split('_')[1] %}
                      <option value="monday" {% if current_day=='monday' %} selected {% endif %}>{{ _('Monday') }}</option>
                      <option value="tuesday" {% if current_day=='tuesday' %} selected {% endif %}>{{ _('Tuesday') }}</option>
                      <option value="wednesday" {% if current_day=='wednesday' %} selected {% endif %}>{{ _('Wednesday') }}
                      </option>
                      <option value="thursday" {% if current_day=='thursday' %} selected {% endif %}>{{ _('Thursday') }}</option>
                      <option value="friday" {% if current_day=='friday' %} selected {% endif %}>{{ _('Friday') }}</option>
                      <option value="saturday" {% if current_day=='saturday' %} selected {% endif %}>{{ _('Saturday') }}</option>
                      <option value="sunday" {% if current_day=='sunday' %} selected {% endif %}>{{ _('Sunday') }}</option>
                    </select>
                    <!-- Hidden input to combine the values for form submission -->
                    <input type="hidden" name="day_of_week_pattern" id="day_of_week_pattern" value="">
                  </div>
                </td>
              </tr>
            </table>
          </div>
        </div>
      </div>

    <div class="button-container">
        <button type="submit" class="w3-button w3-green w3-round"><i class="fa-solid fa-floppy-disk" aria-hidden="true"></i> {{ _('Save') }}</button>
        <button type="button" class="w3-button w3-blue w3-round" id="resetButton"><i class="fa-solid fa-rotate-left"></i> {{ _('Reset') }}</button>
        <button type="button" class="w3-button w3-blue w3-round" id="previewButton"><i class="fa-solid fa-eye"></i> {{ _('Preview') }}</button>
        <button type="button" class="w3-button w3-red w3-round" id="cancelButton"><i class="fa-solid fa-circle-xmark"></i> {{ _('Cancel') }}</button>
        <button type="button" class="w3-button w3-red w3-round" id="deleteButton" onclick="if(confirm('{{ _('Delete App?') }}')) deleteApp('{{ device.id }}', '{{ app.iname }}', true)"><i class="fa-solid fa-trash"></i> {{ _('Delete') }}</button>
    </div>
</form>

<!-- API Examples Section -->
<div id="apiUsageContent">
  <div class="api-section">
    <div style="display: flex; align-items: center; gap: 10px;">
        <h2>{{ _('API Usage') }}</h2>
        <button id="toggleApiUsageBtn" class="w3-button" style="background-color: var(--primary-color); color: white;"><i class="fa-solid fa-code" aria-hidden="true"></i> <span class="button-label">{{ _('Show API Usage') }}</span></button>
    </div>
    <div class="api-usage-details collapsed">
        <p>{{ _('Use these curl commands to control this app via the API:') }}</p>

    <!-- Enable App -->
    <div style="margin-bottom: 20px;">
      <h3>{{ _('Enable App') }}</h3>
      <pre>curl -X PATCH \
  -H "Authorization: Bearer {{ device.api_key or 'YOUR_API_KEY' }}" \
  -H "Content-Type: application/json" \
  -d '{"enabled": true}' \
  {{ url_for('handle_patch_device_app', device_id=device.id, installation_id=app.iname) }}</pre>
    </div>

    <!-- Disable App -->
    <div style="margin-bottom: 20px;">
      <h3 style="color: var(--danger-text);">{{ _('Disable App') }}</h3>
      <pre>curl -X PATCH \
  -H "Authorization: Bearer {{ device.api_key or 'YOUR_API_KEY' }}" \
  -H "Content-Type: application/json" \
  -d '{"enabled": false}' \
  {{ url_for('handle_patch_device_app', device_id=device.id, installation_id=app.iname) }}</pre>
    </div>

    <!-- Pin App -->
    <div style="margin-bottom: 20px;">
      <h3>{{ _('Pin App') }}</h3>
      <pre>curl -X PATCH \
  -H "Authorization: Bearer {{ device.api_key or 'YOUR_API_KEY' }}" \
  -H "Content-Type: application/json" \
  -d '{"pinnedApp": "{{ app.iname }}"}' \
  {{ url_for('update_device', device_id=device.id) }}</pre>
    </div>

    <!-- Unpin App -->
    <div style="margin-bottom: 20px;">
      <h3 style="color: var(--danger-text);">{{ _('Unpin App') }}</h3>
      <pre>curl -X PATCH \
  -H "Authorization: Bearer {{ device.api_key or 'YOUR_API_KEY' }}" \
  -H "Content-Type: application/json" \
  -d '{"pinnedApp": ""}' \
  {{ url_for('update_device', device_id=device.id) }}</pre>
    </div>

    <small>
      <strong>{{ _('Note:') }}</strong> {{ _('Replace YOUR_API_KEY with your device API key if not using the one shown above.') }}
    </small>
  </div>
</div>

<script>
  // Make the schema and config objects available to JavaScript
  const schema = {{ schema | tojson }};
  const config = {{ config | tojson }};
  {% if "location" in device %}
  const deviceLocation = JSON.stringify({{ device.location | tojson }});
  {% else %}
  const deviceLocation = null;
  {% endif %}

  // Initialize toggle buttons for config and debug content
  function initializeToggleButtons() {
    const toggleConfigBtn = document.getElementById("toggleConfigBtn");
    const configContent = document.getElementById("configContent");
    const toggleDebugBtn = document.getElementById("toggleDebugBtn");
    const debugContent = document.getElementById("debugContent");

    if (toggleConfigBtn && configContent) {
      toggleConfigBtn.addEventListener("click", function () {
        toggleContent(configContent, toggleConfigBtn,
          "{{ _('Hide App Config') }}", "{{ _('Show App Config') }}", 'hidden');
      });
    }

    if (toggleDebugBtn && debugContent) {
      toggleDebugBtn.addEventListener("click", function () {
        toggleContent(debugContent, toggleDebugBtn,
          "{{ _('Hide Render Debug') }}", "{{ _('Show Render Debug') }}", 'hidden');
      });
    }

    const toggleApiUsageBtn = document.getElementById("toggleApiUsageBtn");
    const apiUsageDetails = document.querySelector("#apiUsageContent .api-usage-details");

    if (toggleApiUsageBtn && apiUsageDetails) {
      // Set initial button text based on initial collapsed state
      const label = toggleApiUsageBtn.querySelector(".button-label");
      if (apiUsageDetails.classList.contains("collapsed")) {
        label.textContent = "{{ _('Show API Usage') }}";
      } else {
        label.textContent = "{{ _('Hide API Usage') }}";
      }

      toggleApiUsageBtn.addEventListener("click", function () {
        toggleContent(apiUsageDetails, toggleApiUsageBtn,
          "{{ _('Hide API Usage') }}", "{{ _('Show API Usage') }}", 'collapsed');
      });
    }
  }

  // Generic function to toggle content visibility
  function toggleContent(content, button, hideText, showText, className) {
    const label = button.querySelector(".button-label");
    const target = label || button;
    if (content.classList.contains(className)) {
      content.classList.remove(className);
      target.textContent = hideText;
    } else {
      content.classList.add(className);
      target.textContent = showText;
    }
  }

  function debounce(func, wait) {
    let timeout;
    return function (...args) {
      clearTimeout(timeout);
      timeout = setTimeout(() => {
        func.apply(this, args);
      }, wait);
    };
  }

  // Function to update the config text and preview image
  const updateConfigAndPreview = debounce(() => {
    const configContent = document.getElementById("configContent").querySelector("pre");
    const previewImage = document.getElementById("previewImage");
    configContent.textContent = JSON.stringify(config, null, 2);
    // Reload the preview image to reflect updated config
    const url = new URL(previewImage.src);
    url.searchParams.set("config", JSON.stringify(config));
    previewImage.src = url.toString();
    setTimeout(() => {
        if (!previewImage.complete) previewImage.classList.remove('loaded');
    }, 500);
  }, 100);

  // Centralized config update handler
  function handleConfigUpdate(event) {
    const target = event.target;
    // We expect dataset.configId for schema fields
    const configId = target.dataset.configId;

    if (!configId) {
        // Not a schema config field
        return;
    }

    if (target.hasAttribute("data-ignore-config")) {
      return;
    }
    if (target.type === "checkbox") {
      config[configId] = target.checked ? "true" : "false";
    } else if (target.type === "select-one") {
      config[configId] = target.value;
    } else if (target.type === "datetime-local") {
      config[configId] = new Date(target.value).toISOString();
    } else {
      config[configId] = target.value;
    }
    updateConfigAndPreview();
  }

  // Function to create form fields dynamically
  function createFormFields(schema, config) {
    const rows = [];

    if (!schema || !schema.schema) {
      return rows;
    }

    schema.schema.filter(field => field.type !== "generated").forEach(field => {
      const row = document.createElement("tr");
      // Create label and description
      const labelCell = document.createElement("td");
      const label = document.createElement("label");
      // Namespace IDs to avoid conflict with settings fields
      const inputId = "schema_" + field.id;
      label.htmlFor = inputId;
      if (field.icon) {
        const icon = document.createElement("i");
        icon.className = `fa fa-${field.icon.replace(/[A-Z]/g, match => `-${match.toLowerCase()}`)}`;
        label.appendChild(icon);
        label.appendChild(document.createTextNode(" "));
      }
      label.appendChild(document.createTextNode(field.name));
      labelCell.appendChild(label);
      labelCell.appendChild(document.createElement("br"));

      const description = document.createElement("small");
      description.textContent = field.description;
      labelCell.appendChild(description);
      row.appendChild(labelCell);

      // Create input field
      const inputCell = document.createElement("td");
      let inputElement;

      switch (field.type) {
        case "text":
          inputElement = document.createElement("input");
          inputElement.type = field.secret ? "password" : "text";
          inputElement.value = config[field.id] || field.default || "";
          // Set initial config value if using default
          if (!config[field.id] && field.default) {
            config[field.id] = field.default;
          }
          break;

        case "onoff":
          inputElement = document.createElement("input");
          inputElement.type = "checkbox";
          inputElement.checked = config[field.id] === "true" || (config[field.id] === undefined && field.default === "true");
          // Set initial config value for the checkbox
          config[field.id] = inputElement.checked ? "true" : "false";
          break;

        case "datetime":
          inputElement = document.createElement("input");
          inputElement.type = "datetime-local";
          inputElement.value = (config[field.id] || field.default || "").replace("Z", "");
          // Set initial config value if using default
          if (!config[field.id] && field.default) {
            config[field.id] = field.default;
          }
          break;

        case "dropdown":
          inputElement = document.createElement("select");
          if (field.options) {
            field.options.forEach(option => {
              const opt = document.createElement("option");
              opt.value = option.value;
              opt.textContent = option.display;
              // Select option if it matches config value, or if no config value exists, match against field.default
              opt.selected = config[field.id] === option.value || (!config[field.id] && field.default === option.value);
              inputElement.appendChild(opt);
            });
          }

          // Set initial config value for the dropdown
          if (inputElement.selectedIndex >= 0 && inputElement.options[inputElement.selectedIndex]) {
            const initialValue = inputElement.options[inputElement.selectedIndex].value;
            config[field.id] = initialValue;
            // Note: updateConfigAndPreview() will be called once after all fields are processed
          }
          break;

        case "location":
          inputElement = createLocationField(field, config);
          break;

        case "locationbased":
          inputElement = createLocationBasedField(field, config);
          break;

        case "color":
          inputElement = document.createElement("input");
          inputElement.type = "color";
          inputElement.value = config[field.id] || field.default || "#000000";
          // Set initial config value if using default
          if (!config[field.id]) {
            config[field.id] = field.default || "#000000";
          }
          if (field.palette) {
              const div = createColorPaletteButtons(field, inputElement);
              inputCell.appendChild(div);
          }
          break;

        case "png":
          inputElement = createImageUploadField(field, config);
          break;

        case "typeahead":
          inputElement = createTypeaheadField(field, config);
          break;

        default:
          console.warn(`Unknown field type "${field.type}" for field "${field.id}".`);
          break;
      };
      if (inputElement) {
        inputElement.id = inputId; // Use namespaced ID
        inputElement.name = field.id; // Keep original name? Or namespaced?
        inputElement.dataset.configId = field.id; // Store original config ID for JS
        inputElement.className = "form-control";
        inputElement.setAttribute("data-default", config[field.id] || field.default || "");

        // Add event listeners directly to ensure they work for generated fields
        if (!inputElement.hasAttribute("data-ignore-config")) {
          if (inputElement.type === "select-one") {
            inputElement.addEventListener("change", handleConfigUpdate);
          } else {
            inputElement.addEventListener("input", handleConfigUpdate);
          }
        }

        let elementToAppend = inputElement;

        if (field.type === "text" && field.secret) {
          const secretContainer = document.createElement("div");
          secretContainer.className = "secret-input-container";

          const toggleButton = document.createElement("button");
          toggleButton.type = "button";
          toggleButton.className = "secret-toggle-button";
          toggleButton.setAttribute("aria-label", "{{ _('Toggle password visibility') }}");

          const icon = document.createElement("i");
          icon.setAttribute("aria-hidden", "true");
          toggleButton.appendChild(icon);

          const updateToggleIcon = () => {
            icon.className = inputElement.type === "password" ? "fa fa-eye-slash" : "fa fa-eye";
          };

          toggleButton.addEventListener("click", () => {
            inputElement.type = inputElement.type === "password" ? "text" : "password";
            updateToggleIcon();
          });

          updateToggleIcon();

          secretContainer.appendChild(inputElement);
          secretContainer.appendChild(toggleButton);
          elementToAppend = secretContainer;
        }

        inputCell.appendChild(elementToAppend);
      }

      row.appendChild(inputCell);
      rows.push(row);
    });

    // Update config and preview once after all fields are processed
    updateConfigAndPreview();

    return rows;
  }

  function createGeneratedFormFields(schema, config) {
    if (!schema || !schema.schema) {
      return;
    }

    schema.schema
      .filter(field => field.type === "generated")
      .forEach(field => createGeneratedField(field, config));
  }

  function createLocationSearchElements(field, config) {
    const container = document.createElement("div");

    const searchInput = document.createElement("input");
    searchInput.type = "text";
    searchInput.id = `${field.id}_search`;
    searchInput.placeholder = "{{ _('Enter a location') }}";
    searchInput.setAttribute("data-ignore-config", "true");

    container.appendChild(searchInput);

    const resultsList = document.createElement("ul");
    resultsList.id = `${field.id}_results`;
    resultsList.style.listStyleType = "none";
    resultsList.style.padding = "0";
    container.appendChild(resultsList);

    return { container, searchInput, resultsList };
  }

  function createLocationField(field, config) {
    const { container, searchInput, resultsList } = createLocationSearchElements(field);

    let initialLocationJsonString = config[field.id] || (deviceLocation !== null ? deviceLocation : undefined) || field.default || "{}";
    if (typeof initialLocationJsonString !== 'string') {
      initialLocationJsonString = "{}";
    }

    try {
      const parsedLoc = JSON.parse(initialLocationJsonString);
      if (parsedLoc && parsedLoc.description) {
        searchInput.value = parsedLoc.description;
      } else {
        searchInput.value = "";
      }
    } catch (e) {
      console.warn("Could not parse initial location", e);
      searchInput.value = "";
    }

    const hiddenInput = document.createElement("input");
    hiddenInput.type = "hidden";
    hiddenInput.id = "schema_" + field.id;
    hiddenInput.dataset.configId = field.id;
    hiddenInput.name = field.id;
    hiddenInput.value = initialLocationJsonString;
    hiddenInput.setAttribute("data-default", initialLocationJsonString);
    container.appendChild(hiddenInput);

    enableLocationSearch(searchInput, resultsList, hiddenInput, location => {
      config[field.id] = location;
      updateConfigAndPreview();
    });

    return container;
  }

  function createLocationBasedField(field, config) {
    const { container, searchInput, resultsList } = createLocationSearchElements(field);

    if (deviceLocation && typeof deviceLocation === 'string') {
      try {
        const parsedDevLoc = JSON.parse(deviceLocation);
        if (parsedDevLoc && parsedDevLoc.description) {
          searchInput.value = parsedDevLoc.description;
        } else {
          searchInput.value = "";
        }
      } catch (e) {
        console.warn("Could not parse deviceLocation for search input in createLocationBasedField:", deviceLocation, e);
        searchInput.value = "";
      }
    } else {
      searchInput.value = "";
    }

    const hiddenInput = document.createElement("input");
    hiddenInput.type = "hidden";
    hiddenInput.id = `${field.id}_location`;
    hiddenInput.name = `${field.id}_location`;
    hiddenInput.value = deviceLocation;
    hiddenInput.setAttribute("data-default", deviceLocation);
    hiddenInput.setAttribute("data-ignore-config", "true");
    container.appendChild(hiddenInput);

    const dropdown = document.createElement("select");
    dropdown.id = "schema_" + field.id;
    dropdown.dataset.configId = field.id;
    dropdown.name = field.id;
    dropdown.className = "form-control";
    container.appendChild(dropdown);

    dropdown.addEventListener("change", handleConfigUpdate);

    enableLocationSearch(searchInput, resultsList, hiddenInput, async locationQueryJson => {
      const currentOptionJsonString = config[field.id];
      await fetchOptionsForLocation(field, locationQueryJson, dropdown, currentOptionJsonString);
    });

    if (deviceLocation && deviceLocation !== "{}") {
      const currentOptionJsonString = config[field.id];
      fetchOptionsForLocation(field, deviceLocation, dropdown, currentOptionJsonString);
    }

    return container;
  }

  function createImageUploadField(field, config) {
    const container = document.createElement("div");

    const uploadLabel = document.createElement("label");
    uploadLabel.htmlFor = `${field.id}_upload`;
    uploadLabel.textContent = "{{ _('Upload Image') }}";
    container.appendChild(uploadLabel);

    const uploadInput = document.createElement("input");
    uploadInput.type = "file";
    uploadInput.id = `${field.id}_upload`;
    uploadInput.setAttribute("data-ignore-config", "true");
    uploadInput.accept = "image/png, image/jpeg, image/gif, image/svg+xml, image/webp";
    container.appendChild(uploadInput);

    const hiddenInput = document.createElement("input");
    hiddenInput.type = "hidden";
    hiddenInput.id = "schema_" + field.id;
    hiddenInput.dataset.configId = field.id;
    hiddenInput.name = field.id;
    hiddenInput.value = config[field.id] || "";
    hiddenInput.setAttribute("data-default", field.default || "");
    container.appendChild(hiddenInput);

    const previewImage = document.createElement("img");
    previewImage.id = `${field.id}_preview`;
    previewImage.src = config[field.id] ? `data:image/png;base64,${config[field.id]}` : "";
    previewImage.alt = "{{ _('Preview') }}";
    previewImage.style.maxWidth = "100%";
    previewImage.style.height = "auto";
    previewImage.style.marginTop = "10px";
    previewImage.style.display = config[field.id] ? "inline" : "none";
    container.appendChild(previewImage);

    uploadInput.addEventListener("change", event => {
      const file = event.target.files[0];
      if (!file) return;

      if (!(file.type === "image/png" || file.type === "image/jpeg" || file.type === "image/gif" || file.type === "image/svg+xml" || file.type === "image/webp")) {
        alert("{{ _('Please upload a valid image file (PNG, JPEG, GIF, SVG, or WebP).') }}");
        uploadInput.value = "";
        return;
      }

      const maxSize = 500 * 1024;
      if (file.size > maxSize) {
        alert("{{ _('File size exceeds 500KB limit. Please upload a smaller image.') }}");
        uploadInput.value = "";
        return;
      }

      const reader = new FileReader();
      reader.onload = e => {
        const base64Data = e.target.result.split(",")[1];
        hiddenInput.value = base64Data;
        previewImage.src = e.target.result;
        previewImage.style.display = "inline";
        config[field.id] = base64Data;
        updateConfigAndPreview();
      };
      reader.readAsDataURL(file);
    });

    return container;
  }

  function createTypeaheadField(field, config) {
    let inputElement = document.createElement("div");

    const typeaheadInput = document.createElement("input");
    typeaheadInput.type = "text";
    typeaheadInput.id = `${field.id}_typeahead`;
    typeaheadInput.setAttribute("data-ignore-config", "true");
    typeaheadInput.placeholder = "{{ _('Start typing...') }}";
    typeaheadInput.className = "form-control";
    inputElement.appendChild(typeaheadInput);

    const hiddenTypeaheadInput = document.createElement("input");
    hiddenTypeaheadInput.type = "hidden";
    hiddenTypeaheadInput.id = "schema_" + field.id;
    hiddenTypeaheadInput.dataset.configId = field.id;
    hiddenTypeaheadInput.name = field.id;
    hiddenTypeaheadInput.value = JSON.stringify(config[field.id] || {});
    hiddenTypeaheadInput.setAttribute("data-default", JSON.stringify(field.default || {}));
    inputElement.appendChild(hiddenTypeaheadInput);

    const typeaheadResults = document.createElement("ul");
    typeaheadResults.id = `${field.id}_results`;
    typeaheadResults.style.listStyleType = "none";
    typeaheadResults.style.padding = "0";
    typeaheadResults.style.margin = "0";
    typeaheadResults.style.border = "1px solid #ccc";
    typeaheadResults.style.maxHeight = "150px";
    typeaheadResults.style.overflowY = "auto";
    typeaheadResults.style.display = "none";
    inputElement.appendChild(typeaheadResults);

    typeaheadInput.addEventListener("input", async function () {
      const query = typeaheadInput.value.trim();
      if (!query) {
        typeaheadResults.style.display = "none";
        typeaheadResults.innerHTML = "";
        return;
      }

      try {
        const handlerUrl = "{{ url_for('schema_handler', device_id=device.id, iname=app.iname, handler='HANDLER_PLACEHOLDER') }}".replace('HANDLER_PLACEHOLDER', field.handler);
        const response = await fetch(handlerUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ id: field.id, param: query, config: config })
        });

        if (!response.ok) {
          throw new Error("Failed to fetch typeahead options");
        }

        const options = await response.json();
        typeaheadResults.innerHTML = "";

        options.forEach(option => {
          const listItem = document.createElement("li");
          listItem.textContent = option.display;
          listItem.style.cursor = "pointer";
          listItem.style.padding = "5px";
          listItem.addEventListener("click", () => {
            typeaheadInput.value = option.display;
            hiddenTypeaheadInput.value = JSON.stringify(option);
            typeaheadResults.style.display = "none";
            typeaheadResults.innerHTML = "";
            config[field.id] = JSON.stringify(option);
            updateConfigAndPreview();
          });
          typeaheadResults.appendChild(listItem);
        });
        typeaheadResults.style.display = "block";
      } catch (error) {
        console.error("Error fetching typeahead options:", error);
      }
    });

    document.addEventListener("click", function (event) {
      if (!inputElement.contains(event.target)) {
        typeaheadResults.style.display = "none";
      }
    });
    return inputElement;
  }

  function createGeneratedField(field, config) {
    const sourceField = document.getElementById("schema_" + field.source);
    if (!sourceField) {
      console.warn(`Source field with id "schema_${field.source}" not found for generated field "${field.id}"`);
      return;
    }

    const updateGeneratedFields = async () => {
      const sourceValue = sourceField.value;
      try {
        const handlerUrl = "{{ url_for('schema_handler', device_id=device.id, iname=app.iname, handler='HANDLER_PLACEHOLDER') }}".replace('HANDLER_PLACEHOLDER', field.handler);
        const response = await fetch(handlerUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ id: field.id, param: sourceValue, config: config })
        });

        if (!response.ok) {
          throw new Error("Failed to fetch generated fields");
        }

        const generatedFields = await response.json();

        // Clear existing rows
        const existingRows = document.querySelectorAll(`[data-generated-field="${field.id}"]`);
        existingRows.forEach(row => row.remove());

        const generatedInput = createFormFields(generatedFields, config);
        const formTable = document.getElementById("schemaConfigContainer");
        generatedInput.forEach(row => {
          row.setAttribute("data-generated-field", field.id);
          formTable.appendChild(row);
        });
      } catch (error) {
        console.error("Error fetching generated fields:", error);
      }
    };

    sourceField.addEventListener("input", updateGeneratedFields);

    updateGeneratedFields();
  }

  function createColorPaletteButtons(field, inputElement) {
    const hexColorRegex = /^#([0-9a-f]{3}){1,2}$/i;
    const div = document.createElement('div');
    div.className = 'palette';
    field.palette?.forEach(color => {
      if (!hexColorRegex.test(color)) {
        console.warn(`Skipping invalid color from palette: ${color}`);
        return;
      }
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'w3-button';
      btn.style.setProperty('--color', color);
      btn.setAttribute('aria-label', `Set color to ${color}`);
      btn.addEventListener('click', () => {
          if (color.length === 4) {
            color = '#' + [...color.slice(1)].map(c => c + c).join('');
          }
          inputElement.value = color;
          inputElement.dispatchEvent(new Event('input'));
      })
      div.appendChild(btn);
    })
    return div;
  }

  async function fetchOptionsForLocation(field, locationQueryJson, dropdown, currentOptionJsonString) {
    try {
      const handlerUrl = "{{ url_for('schema_handler', device_id=device.id, iname=app.iname, handler='HANDLER_PLACEHOLDER') }}".replace('HANDLER_PLACEHOLDER', field.handler);
      const response = await fetch(handlerUrl, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id: field.id, param: locationQueryJson, config: config })
      });

      if (!response.ok) {
        throw new Error(`Failed to fetch options for ${field.id}: ${response.statusText}`);
      }

      const options = await response.json();
      dropdown.innerHTML = "";

      let selectedIndex = 0;
      let currentOptionFromConfig = null;

      if (typeof currentOptionJsonString === 'string' && currentOptionJsonString !== 'undefined' && currentOptionJsonString !== 'null') {
        try {
          currentOptionFromConfig = JSON.parse(currentOptionJsonString);
        } catch (e) {
          console.warn(`Could not parse currentOptionJsonString for field ${field.id}:`, currentOptionJsonString, e);
        }
      }

      if (options && options.length > 0) {
        options.forEach((option, index) => {
          const opt = document.createElement("option");
          const optionValueString = JSON.stringify(option);
          opt.value = optionValueString;
          opt.textContent = option.display;
          dropdown.appendChild(opt);

          if (currentOptionFromConfig && typeof currentOptionFromConfig === 'object' && typeof option === 'object') {
            if (JSON.stringify(option) === JSON.stringify(currentOptionFromConfig)) {
              selectedIndex = index;
            }
          }
        });
        dropdown.selectedIndex = selectedIndex;
      } else {
        const noOpt = document.createElement("option");
        noOpt.textContent = "{{ _('No options available for this location') }}";
        noOpt.value = "";
        noOpt.disabled = true;
        dropdown.appendChild(noOpt);
        dropdown.selectedIndex = 0;
      }
      dropdown.dispatchEvent(new Event("change"));
    } catch (error) {
      console.error(`Error fetching options for field ${field.id}:`, error);
      dropdown.innerHTML = "";
      const errOpt = document.createElement("option");
      errOpt.textContent = "{{ _('Error loading options') }}";
      errOpt.value = "";
      errOpt.disabled = true;
      dropdown.appendChild(errOpt);
      if (dropdown.options.length > 0) dropdown.selectedIndex = 0;
      dropdown.dispatchEvent(new Event("change"));
    }
  }

  // Recurrence Logic (from updateapp.html)
  function initializeRecurrenceOptions() {
    toggleCustomRecurrence();

    const monthlyPatternSelect = document.getElementById("monthly_pattern");
    if (monthlyPatternSelect) {
      monthlyPatternSelect.addEventListener("change", toggleMonthlyPatternOptions);
      toggleMonthlyPatternOptions();
    }

    const weekOccurrenceSelect = document.getElementById("week_occurrence");
    const weekDaySelect = document.getElementById("week_day");
    if (weekOccurrenceSelect && weekDaySelect) {
      weekOccurrenceSelect.addEventListener("change", updateDayOfWeekPattern);
      weekDaySelect.addEventListener("change", updateDayOfWeekPattern);
      updateDayOfWeekPattern();
    }
  }

  function toggleCustomRecurrence() {
    const useCustom = document.getElementById("use_custom_recurrence").checked;
    const legacySchedule = document.getElementById("legacy_schedule");
    const customRecurrence = document.getElementById("custom_recurrence");

    if (useCustom) {
      legacySchedule.style.display = "none";
      customRecurrence.style.display = "block";
      toggleRecurrenceOptions();
    } else {
      legacySchedule.style.display = "block";
      customRecurrence.style.display = "none";
    }
  }

  function toggleRecurrenceOptions() {
    const recurrenceType = document.getElementById("recurrence_type").value;
    const intervalUnit = document.getElementById("interval_unit");
    const weeklyOptions = document.getElementById("weekly_options");
    const monthlyOptions = document.getElementById("monthly_options");

    switch (recurrenceType) {
      case "daily":
        intervalUnit.textContent = "{{ _('days') }}";
        break;
      case "weekly":
        intervalUnit.textContent = "{{ _('weeks') }}";
        break;
      case "monthly":
        intervalUnit.textContent = "{{ _('months') }}";
        break;
      case "yearly":
        intervalUnit.textContent = "{{ _('years') }}";
        break;
    }

    weeklyOptions.style.display = (recurrenceType === "weekly") ? "block" : "none";
    monthlyOptions.style.display = (recurrenceType === "monthly") ? "block" : "none";
  }

  function toggleMonthlyPatternOptions() {
    const monthlyPattern = document.getElementById("monthly_pattern").value;
    const dayOfMonthOption = document.getElementById("day_of_month_option");
    const dayOfWeekOption = document.getElementById("day_of_week_option");

    if (monthlyPattern === "day_of_month") {
      dayOfMonthOption.style.display = "block";
      dayOfWeekOption.style.display = "none";
    } else {
      dayOfMonthOption.style.display = "none";
      dayOfWeekOption.style.display = "block";
    }
  }

  function updateDayOfWeekPattern() {
    const occurrence = document.getElementById("week_occurrence").value;
    const day = document.getElementById("week_day").value;
    const hiddenField = document.getElementById("day_of_week_pattern");

    if (occurrence && day) {
      hiddenField.value = occurrence + "_" + day;
    }
  }

  function deleteApp(deviceId, iname, deleteOnCancel) {
      fetch("{{ url_for('deleteapp', device_id=device.id, iname=app.iname) }}", {
        method: 'POST'
      }).then(() => {
        if (window.opener && deleteOnCancel) {
           window.close();
        } else {
           window.location.href = "{{ url_for('index') }}";
        }
      }).catch(() => {
        alert("{{ _('Error deleting app.') }}");
        window.location.href = "{{ url_for('index') }}";
      });
  }


  // Initialize the form on page load
  document.addEventListener("DOMContentLoaded", function () {
    const previewImage = document.getElementById('previewImage');
    previewImage.addEventListener('load', () => {
      previewImage.classList.add('loaded');
    });

    const form = document.getElementById("dynamicForm");
    const formTable = document.getElementById("schemaConfigContainer");

    // Generate schema fields
    const formFields = createFormFields(schema, config);
    formFields.forEach(row => {
      formTable.appendChild(row);
    });

    // Create generated fields
    createGeneratedFormFields(schema, config);

    // Initialize toggles and recurrence
    initializeToggleButtons();
    initializeRecurrenceOptions();

    form.addEventListener("submit", function (event) {
      event.preventDefault();

      // Collect settings data
      const formData = new FormData(form);
      const settings = Object.fromEntries(formData.entries());

      // Handle checkboxes manually (if unchecked, they aren't in FormData)
      settings.enabled = document.getElementById('enabled').checked;
      settings.autopin = document.getElementById('autopin').checked;
      settings.use_custom_recurrence = document.getElementById('use_custom_recurrence').checked;

      // Handle multi-select checkboxes (days/weekdays)
      const days = Array.from(document.querySelectorAll('input[name="days"]:checked')).map(cb => cb.value);
      settings.days = days;
      const weekdays = Array.from(document.querySelectorAll('input[name="weekdays"]:checked')).map(cb => cb.value);
      settings.weekdays = weekdays;

      // Combine with config
      const payload = {
          ...settings,
          config: config
      };

      fetch(form.action, {
        method: form.method,
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(payload),
      }).then(response => {
        if (response.ok) {
          console.log("Form submitted successfully");
          {% if delete_on_cancel == 1 %}
          if (window.opener) {
            window.close();
          } else {
            window.location.href = "{{ url_for('index') }}";
          }
          {% else %}
          window.location.href = response.url;
          {% endif %}
        } else {
          console.error("Form submission failed");
          // Optionally show error message
        }
      }).catch(error => {
        console.error("Error submitting form:", error);
      });
    });

    // Reset button
    const resetButton = document.getElementById("resetButton");
    if(resetButton) {
        resetButton.addEventListener("click", function () {
            // Reset schema inputs
            const inputs = document.querySelectorAll("[data-default]");
            inputs.forEach(input => {
                const defaultValue = input.getAttribute("data-default");
                if (input.type === "checkbox") {
                    input.checked = defaultValue === "true";
                } else if (input.type === "select-one") {
                    input.value = defaultValue;
                } else {
                    input.value = defaultValue;
                }

                if (input.dataset.configId) {
                    let valueToSet = defaultValue;
                    try {
                        // For fields like 'location', the default value is a JSON string.
                        // We need to parse it to store it as an object in the config.
                        const parsed = JSON.parse(defaultValue);
                        valueToSet = parsed;
                    } catch (e) {
                        // Not a JSON string, use as is.
                    }
                    config[input.dataset.configId] = valueToSet;
                }
            });
            updateConfigAndPreview();
        });
    }

    // Preview Button (manual trigger)
    const previewButton = document.getElementById("previewButton");
    if(previewButton) {
        previewButton.addEventListener("click", (event) => {
            // Use previewApp to push to device
            previewApp('{{ device.id }}', '{{ app.iname }}', config, event.currentTarget, { previewing: '{{ _('Previewing...') }}', sent: '{{ _('Sent') }}', failed: '{{ _('Failed') }}' });
        });
    }

    // Top Cancel Button
    const cancelButtonTop = document.getElementById("cancelButtonTop");
    if (cancelButtonTop) {
      cancelButtonTop.addEventListener("click", function() {
        {% if delete_on_cancel == 1 %}
            deleteApp('{{ device.id }}', '{{ app.iname }}', true);
        {% else %}
        if (window.opener) {
          window.close();
        } else {
          window.location.href = "{{ url_for('index') }}";
        }
        {% endif %}
      });
    }

    // Bottom Cancel Button
    const cancelButton = document.getElementById("cancelButton");
    if (cancelButton) {
        cancelButton.addEventListener("click", function() {
             {% if delete_on_cancel == 1 %}
                deleteApp('{{ device.id }}', '{{ app.iname }}', true);
            {% else %}
            if (window.opener) {
              window.close();
            } else {
              window.location.href = "{{ url_for('index') }}";
            }
            {% endif %}
        });
    }

    // Save Button (Top)
    const saveButtonTop = document.getElementById("saveButton");
    if(saveButtonTop) {
        saveButtonTop.addEventListener("click", () => {
             form.dispatchEvent(new Event('submit'));
        });
    }
  });
</script>
{% endblock %}
