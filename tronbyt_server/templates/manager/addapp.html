{% extends 'base.html' %}
{% block header %}
<h1>{% block title %}{{ _('Add App') }}{% endblock %}</h1>
{% endblock %}
{% block content %}
<script>
  function searchApps(searchId) {
    // Simply call applyFilters which now handles both search and installed filtering
    applyFilters();
  }

  function toggleInstalledApps(searchId) {
    applyFilters();
  }

  function toggleBrokenApps(searchId) {
    applyFilters();
  }

  function sortApps(searchId) {
    const sortType = document.getElementById('sort_' + searchId).value;
    const gridId = searchId.replace('_search', '_app_grid');
    const grid = document.getElementById(gridId);

    if (grid) {
      const items = Array.from(grid.getElementsByClassName('app-item'));

      items.sort((a, b) => {
        switch (sortType) {
          case 'alphabetical':
            return a.getAttribute('data-name').localeCompare(b.getAttribute('data-name'));
          case 'rev-alphabetical':
            return b.getAttribute('data-name').localeCompare(a.getAttribute('data-name'));
          case 'newest':
            const dateA = a.getAttribute('data-date') || '';
            const dateB = b.getAttribute('data-date') || '';
            const dateComparison = dateB.localeCompare(dateA); // Newest first
            if (dateComparison === 0) {
              // If dates are the same, sort alphabetically
              return a.getAttribute('data-name').localeCompare(b.getAttribute('data-name'));
            }
            return dateComparison;
          case 'system':
          default:
            // System sort: Installed apps first, then alphabetical A-Z
            const installedA = a.getAttribute('data-installed') === 'true';
            const installedB = b.getAttribute('data-installed') === 'true';
            if (installedA && !installedB) return -1;
            if (!installedA && installedB) return 1;
            // If both have same installed status, sort alphabetically
            return a.getAttribute('data-name').localeCompare(b.getAttribute('data-name'));
        }
      });

      // Re-append items in sorted order
      items.forEach(item => grid.appendChild(item));
    }

    applyFilters();
  }

  function applyFilters() {
    const items = document.querySelectorAll('.app-item');

    items.forEach(item => {
      const isInstalled = item.getAttribute('data-installed') === 'true';
      const isBroken = item.getAttribute('data-broken') === 'true';
      const name = item.getAttribute('data-value');
      const grid = item.closest('.app-grid');

      if (!grid) return;

      const gridId = grid.id;
      const searchId = gridId.replace('_app_grid', '_search');

      // Check if item should be hidden by search
      let shouldHideBySearch = false;
      const searchInput = document.getElementById(searchId);
      if (searchInput && searchInput.value) {
        const filter = searchInput.value.toUpperCase();
        if (name.toUpperCase().indexOf(filter) === -1) {
          shouldHideBySearch = true;
        }
      }

      // Check if item should be hidden by installed filter
      let shouldHideByInstalled = false;
      const hideInstalledCheckbox = document.getElementById('hide_installed_' + searchId);
      if (hideInstalledCheckbox && hideInstalledCheckbox.checked && isInstalled) {
        shouldHideByInstalled = true;
      }

      // Check if item should be hidden by broken filter
      let shouldHideByBroken = false;
      const hideBrokenCheckbox = document.getElementById('hide_broken_' + searchId);
      if (hideBrokenCheckbox && hideBrokenCheckbox.checked && isBroken) {
        shouldHideByBroken = true;
      }

      // Apply visibility logic
      if (shouldHideBySearch || shouldHideByInstalled || shouldHideByBroken) {
        item.style.display = 'none';
      } else {
        item.style.display = '';
      }

      // Add visual indicator for installed apps
      if (isInstalled) {
        item.classList.add('installed');
      }
    });
  }
</script>
<a class="w3-button w3-purple w3-round w3-padding" href="{{ url_for('manager.uploadapp', device_id=device['id']) }}">{{
  _('Upload .star file') }}</a>
<form method="post" id="main_form">
  <label for="name">{{ _('App Selection') }}</label>

  {% macro render_app_list(title, search_id, grid_id, app_list, show_controls=true) %}
  <div class="app-group">
    <h3>{{ title }}</h3>

    {% if show_controls %}
    <!-- Filter and Sort Controls -->
    <div class="filter-sort-controls">
      <div class="filter-sort-controls-inner">

        <input type="search" id="{{ search_id }}" placeholder="{{ _('Search apps') }}"
          onkeyup="searchApps('{{ search_id }}', '{{ grid_id }}')" />

        <label class="control-label">
          <input type="checkbox" id="hide_installed_{{ search_id }}" onchange="toggleInstalledApps('{{ search_id }}')"
            class="control-checkbox">
          {{ _('Hide installed apps') }}
        </label>

        <label class="control-label">
          <input type="checkbox" id="hide_broken_{{ search_id }}" onchange="toggleBrokenApps('{{ search_id }}')"
            class="control-checkbox" checked>
          {{ _('Hide broken apps') }}
        </label>

        <label for="sort_{{ search_id }}" class="control-label">
          {{ _('Sort by:') }}
          <select id="sort_{{ search_id }}" onchange="sortApps('{{ search_id }}')">
            <option value="system" selected>{{ _('Default') }}</option>
            <option value="newest">{{ _('Newest') }}</option>
            <option value="alphabetical">{{ _('Alphabetical (A-Z)') }}</option>
            <option value="rev-alphabetical">{{ _('Alphabetical (Z-A)') }}</option>
          </select>
        </label>
      </div>
    </div>
    {% endif %}

    <div id="{{ grid_id }}" class="app-grid">
      {% for app in app_list %}
      <div class="app-item {% if app.get('broken') %}broken-app{% endif %}" data-value="{{ app['name'] }}" data-installed="{{ app.get('is_installed', false) | lower }}"
        data-date="{{ app.get('date', '') }}" data-name="{{ app['name'] }}" data-broken="{{ app.get('broken', false) | lower }}">
        {% if app.get('is_installed', false) %}
        <div class="installed-badge">{{ _('Installed') }}</div>
        {% endif %}
        {% if 'preview' in app %}
        <div class="app-img">
          <img loading="lazy" width="400px" src="{{ url_for('manager.app_preview', filename=app['preview']) }}" alt="{{ app['name'] }}" {% if app.get('broken') %}style="opacity: 0.4;"{% endif %}>
        </div>
        {% else %}
        <div>
          <img loading="lazy" width="400px" src="{{ url_for('static', filename='images/not_found.jpg') }}" alt="{{ app['name'] }}" {% if app.get('broken') %}style="opacity: 0.4;"{% endif %}>
        </div>
        {% endif %}
        <p {% if app.get('broken') %}style="opacity: 0.5;"{% endif %}>{{ app['name'] }} - {{ app['summary'] }}</p>
        {% if 'author' in app %}
        <p {% if app.get('broken') %}style="opacity: 0.5;"{% endif %}>{{ _('From') }} {{ app['author'] }}</p>
        {% endif %}
        {% if app.get('broken') %}
        <div style="background-color: #f44336; color: white; padding: 5px 10px; font-weight: bold; border-radius: 3px; font-size: 12px; text-align: center; line-height: 1.3; margin-top: 5px;">
          ‚ùå {{ _('BROKEN') }}<br>
          <span style="font-size: 10px; font-weight: normal;">{{ app.get('brokenReason', 'Unknown') }}</span>
        </div>
        {% endif %}
        {% if app.get('path', '').startswith("users/") %}
        <a href="{{ url_for('manager.deleteupload', filename=app['path'].split('/')[-1], device_id=device['id']) }}">{{ _('Delete') }}</a>
        {% endif %}
        {% if config['PRODUCTION'] == '0' and not app.get('path', '').startswith("users/") %}
          {% if app.get('broken') %}
          <button class="unmark-broken-btn" onclick="unmarkAppAsBroken('{{ app.get('fileName', app['name']) }}', event);" style="background-color: #4CAF50; color: white; border: none; padding: 5px 10px; cursor: pointer; margin-top: 5px; font-size: 12px;">{{ _('Unmark Broken') }}</button>
          {% else %}
          <button class="mark-broken-btn" onclick="markAppAsBroken('{{ app.get('fileName', app['name']) }}', event);" style="background-color: #f44336; color: white; border: none; padding: 5px 10px; cursor: pointer; margin-top: 5px; font-size: 12px;">{{ _('Mark Broken') }}</button>
          {% endif %}
        {% endif %}
      </div>
      {% endfor %}
    </div>
  </div>
  {% endmacro %}

  {% if custom_apps_list %}
  {{ render_app_list(_('Custom Apps'), 'custom_search', 'custom_app_grid', custom_apps_list, show_controls=false) }}

  <hr>
  {% endif %}

  {{ render_app_list(_('System Apps'), 'system_search', 'system_app_grid', apps_list) }}

  <input type="hidden" name="name" id="selected_app">
  <br>
  <label for="uinterval">{{ _('Render Interval (minutes)') }}</label>
  <input name="uinterval" type="number" id="uinterval" min="0" value="{{ request.form['uinterval'] or 10 }}" required>
  <label for="display_time">{{ _('Display Time (seconds)') }}</label>
  <input name="display_time" type="number" id="display_time" min="0" value="{{ request.form['display_time'] or 0 }}"
    required>

  <label for="notes">{{ _('Notes') }}</label>
  <textarea name="notes" id="notes">{{ request.form['notes'] }}</textarea>

  <input type="submit" value="{{ _('Configure') }}" class="w3-button w3-green" onclick="move()"></input>
</form>

<style>
  .app-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 10px;
  }

  .app-item {
    border: 1px solid #d8d8d8;
    padding: 10px;
    text-align: center;
    cursor: pointer;
    position: relative;
  }

  .app-item img {
    max-width: 100%;
    height: auto;
  }

  .app-item.selected {
    border-color: #4CAF50;
  }

  .app-item.installed {
    border-color: #ffa500;
  }

  .installed-badge {
    position: absolute;
    top: 5px;
    right: 5px;
    background-color: #ff9800;
    color: white;
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 10px;
    font-weight: bold;
    z-index: 10;
  }

  .app-item.broken-app {
    border: 2px solid #f44336;
    background-color: rgba(244, 67, 54, 0.05);
    cursor: not-allowed;
  }

  .app-item.broken-app:hover {
    background-color: rgba(244, 67, 54, 0.1);
  }

  .filter-sort-controls select {
    padding: 2px;
    border: 1px solid #ddd;
    border-radius: 3px;
  }

  .filter-sort-container {
    padding: 15px;
    border: 1px solid #ddd;
    border-radius: 5px;
  }

  .filter-sort-wrapper {
    display: flex;
    gap: 20px;
    align-items: center;
    flex-wrap: wrap;
  }

  .filter-label {
    display: flex;
    align-items: center;
    gap: 5px;
  }

  .filter-checkbox {
    margin: 0 !important;
  }

  .filter-sort-controls {
    margin-bottom: 20px;
    padding: 15px;
    border: 1px solid #ddd;
    border-radius: 5px;
  }

  .filter-sort-controls-inner {
    display: flex;
    gap: 20px;
    align-items: center;
    flex-wrap: wrap;
  }

  .control-label {
    display: flex;
    align-items: center;
    gap: 5px;
  }

  .filter-sort-controls input[type="search"] {
    margin-bottom: 0;
    border: 1px solid #ddd;
    border-radius: 3px;
  }

  .filter-sort-controls .control-checkbox {
    margin: 0;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Initialize filters and sorting for each list
    const searchIds = ['system_search', 'custom_search'];
    searchIds.forEach(searchId => {
      if (document.getElementById(searchId)) {
        sortApps(searchId);
      }
    });

    document.querySelectorAll('.app-item').forEach(item => {
      item.addEventListener('click', function () {
        // Don't allow clicking on broken apps
        if (this.classList.contains('broken-app')) {
          return;
        }
        document.querySelectorAll('.app-item').forEach(i => i.classList.remove('selected'));
        this.classList.add('selected');
        document.getElementById('selected_app').value = this.getAttribute('data-value');
        // Open the form submission in a new tab
        const form = document.getElementById('main_form');
        form.target = '_blank';
        form.submit();
        // Reset target so future submissions work normally
        form.target = '';
      });
    });
  });

  // Function to mark app as broken (development mode only)
  function markAppAsBroken(appName, event) {
    // Stop the event from bubbling up to the parent div
    event.stopPropagation();
    event.preventDefault();

    if (!confirm("Mark '" + appName + "' as broken? This will add it to broken_apps.txt and prevent it from being installed.")) {
      return;
    }

    fetch("{{ url_for('manager.mark_app_broken', app_name='PLACEHOLDER') }}".replace('PLACEHOLDER', encodeURIComponent(appName)), {
      method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        alert("App marked as broken successfully!");
        location.reload();
      } else {
        alert("Error: " + data.message);
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert("Failed to mark app as broken");
    });
  }

  // Function to unmark app as broken (development mode only)
  function unmarkAppAsBroken(appName, event) {
    // Stop the event from bubbling up to the parent div
    event.stopPropagation();
    event.preventDefault();

    if (!confirm("Unmark '" + appName + "' as broken? This will remove it from broken_apps.txt and allow it to be installed.")) {
      return;
    }

    fetch("{{ url_for('manager.unmark_app_broken', app_name='PLACEHOLDER') }}".replace('PLACEHOLDER', encodeURIComponent(appName)), {
      method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        alert("App unmarked successfully!");
        location.reload();
      } else {
        alert("Error: " + data.message);
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert("Failed to unmark app");
    });
  }
</script>
{% endblock %}
