{% extends 'base.html' %}
{% block header %}
{% endblock %}
{% block content %}
{% if user.username == "admin" %}
<h1>{{ _('System Administration') }}</h1>

<h2>{{ _('System Apps Repository') }}</h2>

<div style="border: 1px solid #333; border-radius: 4px; padding: 20px; margin-bottom: 20px;">
    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
        <div style="flex: 1;">
            <strong>{{ _('Current Repository') }}</strong>
            {% if system_repo_info and system_repo_info.commit_hash %}
            <div style="margin-top: 8px;">
                <div style="margin-bottom: 5px;">
                    <a href="{{ system_repo_info.repo_url }}" target="_blank" style="color: #4CAF50; text-decoration: none;">
                        {{ system_repo_info.repo_url }}
                    </a>
                </div>
                <div style="margin-bottom: 5px; color: #888; font-size: 0.9em;">
                    {{ _('Branch') }}: {{ system_repo_info.branch }}
                </div>
                <div style="color: #888; font-size: 0.9em;">
                    {{ _('Commit') }}:
                    <a href="{{ system_repo_info.commit_url }}" target="_blank" style="color: #4CAF50; text-decoration: none;" title="{{ system_repo_info.commit_hash }}">
                        {% if system_repo_info.commit_message %}
                            {{ system_repo_info.commit_message }}
                        {% else %}
                            {{ system_repo_info.commit_hash[:8] }}
                        {% endif %}
                    </a>
                    {% if system_repo_info.commit_date %}
                    <span style="margin-left: 8px; color: #666;">{{ system_repo_info.commit_date }}</span>
                    {% endif %}
                </div>
            </div>
            {% else %}
            <div style="margin-top: 8px; color: #888;">{{ _('No system repository configured.') }}</div>
            {% endif %}
        </div>
        <form method="post" action="{{ url_for('refresh_system_repo') }}" style="margin-left: 15px;" onsubmit="var btn = this.querySelector('button'); btn.disabled = true; btn.style.opacity = '0.6'; btn.innerHTML = '<i class=\'fa-solid fa-spinner fa-spin\'></i> {{ _('Refreshing...') }}';">
            <button type="submit" class="w3-button w3-blue" style="padding: 8px 16px; font-size: 14px;">
                <i class="fa-solid fa-arrows-rotate" aria-hidden="true"></i> {{ _('Refresh') }}
            </button>
        </form>
    </div>

    <div style="border-top: 1px solid #333; padding-top: 15px;">
        <strong>{{ _('Change Repository') }}</strong>
        <form method="post" action="{{ url_for('set_system_repo') }}" style="margin-top: 10px;">
            <div style="display: flex; gap: 10px; align-items: flex-end;">
                <div style="flex: 1;">
                    <label for="app_repo_url" style="display: block; margin-bottom: 5px; font-size: 0.9em;">{{ _('Repository URL') }}</label>
                    <input name="app_repo_url" id="app_repo_url" required value="{{ user.system_repo_url }}" style="width: 100%; padding: 8px;">
                </div>
                <button type="submit" class="w3-button w3-green" style="padding: 8px 16px; font-size: 14px;">
                    <i class="fa-solid fa-floppy-disk" aria-hidden="true"></i> {{ _('Save') }}
                </button>
            </div>
            <p style="color: #888; font-size: 0.8em; margin-top: 8px;">{{ _('Replacing the existing system repo will delete the previous repo and break any apps using that repo.') }}</p>
        </form>
    </div>
</div>

<h2>{{ _('Firmware Management') }}</h2>

<div style="border: 1px solid #333; border-radius: 4px; padding: 20px; margin-bottom: 20px;">
    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
        <div style="flex: 1;">
            <strong>{{ _('Current Firmware') }}</strong>
            {% if firmware_version %}
            <div style="margin-top: 8px;">
                <div style="margin-bottom: 5px;">
                    <strong>{{ _('Version') }}:</strong> {{ firmware_version }}
                </div>
                <div style="color: #888; font-size: 0.9em;">
                    {{ _('Firmware is automatically updated when the server starts.') }}
                </div>
            </div>
            {% else %}
            <div style="margin-top: 8px; color: #888;">{{ _('No firmware version information available') }}</div>
            {% endif %}
        </div>
        <form method="post" action="{{ url_for('update_firmware') }}" style="margin-left: 15px;" onsubmit="var btn = this.querySelector('button'); btn.disabled = true; btn.style.opacity = '0.6'; btn.innerHTML = '<i class=\'fa-solid fa-spinner fa-spin\'></i> {{ _('Updating...') }}';">
            <button type="submit" class="w3-button w3-blue" style="padding: 8px 16px; font-size: 14px;">
                <i class="fa-solid {% if firmware_version %}fa-arrows-rotate{% else %}fa-download{% endif %}" aria-hidden="true"></i> {% if firmware_version %}{{ _('Update') }}{% else %}{{ _('Download') }}{% endif %}
            </button>
        </form>
    </div>

    <div style="border-top: 1px solid #333; padding-top: 15px;">
        <p style="color: #888; font-size: 0.8em; margin: 0;">
            <i class="fa-solid fa-circle-info" aria-hidden="true"></i> {{ _('Note: This updates the firmware files available for flashing, not the firmware on existing devices. Devices must be manually reflashed to use the new firmware.') }}
        </p>
    </div>
</div>
{% endif %}
<h1>{{ _('User Settings') }}</h1>

<h2>{{ _('Custom Apps Repository') }}</h2>

<div style="border: 1px solid #333; border-radius: 4px; padding: 20px; margin-bottom: 20px;">
    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
        <div style="flex: 1;">
            <strong>{{ _('Current Repository') }}</strong>
            {% if user.app_repo_url %}
            <div style="margin-top: 8px;">
                <div style="margin-bottom: 5px;">
                    <a href="{{ user.app_repo_url }}" target="_blank" style="color: #4CAF50; text-decoration: none;">
                        {{ user.app_repo_url }}
                    </a>
                </div>
                <div style="color: #888; font-size: 0.9em;">
                    {{ _('Custom apps repository configured') }}
                </div>
            </div>
            {% else %}
            <div style="margin-top: 8px; color: #888;">{{ _('No custom repository configured.') }}</div>
            {% endif %}
        </div>
        {% if user.app_repo_url %}
        <div style="margin-left: 15px; display: flex; gap: 8px;">
            <form method="post" action="{{ url_for('refresh_user_repo') }}" onsubmit="var btn = this.querySelector('button'); btn.disabled = true; btn.style.opacity = '0.6'; btn.innerHTML = '<i class=\'fa-solid fa-spinner fa-spin\'></i> {{ _('Refreshing...') }}';">
                <button type="submit" class="w3-button w3-blue" style="padding: 8px 16px; font-size: 14px;">
                    <i class="fa-solid fa-arrows-rotate" aria-hidden="true"></i> {{ _('Refresh') }}
                </button>
            </form>
            <form method="post" action="{{ url_for('set_user_repo') }}" onsubmit="return confirm('{{ _('Remove custom repository? This will delete the repo and break any apps using it.') }}');">
                <input type="hidden" name="app_repo_url" value="">
                <button type="submit" class="w3-button w3-red" style="padding: 8px 16px; font-size: 14px;">
                    <i class="fa-solid fa-trash" aria-hidden="true"></i> {{ _('Remove') }}
                </button>
            </form>
        </div>
        {% endif %}
    </div>

    <div style="border-top: 1px solid #333; padding-top: 15px;">
        <strong>{{ _('Change Repository') }}</strong>
        <form method="post" action="{{ url_for('set_user_repo') }}" style="margin-top: 10px;">
            <div style="display: flex; gap: 10px; align-items: flex-end;">
                <div style="flex: 1;">
                    <label for="app_repo_url" style="display: block; margin-bottom: 5px; font-size: 0.9em;">{{ _('Repository URL') }}</label>
                    <input name="app_repo_url" id="app_repo_url" required value="{{ user.app_repo_url }}" style="width: 100%; padding: 8px;">
                </div>
                <button type="submit" class="w3-button w3-green" style="padding: 8px 16px; font-size: 14px;">
                    <i class="fa-solid fa-floppy-disk" aria-hidden="true"></i> {{ _('Save') }}
                </button>
            </div>
            <p style="color: #888; font-size: 0.8em; margin-top: 8px;">{{ _('Replacing an existing custom repo will delete the previous repo and break any apps using that repo.') }}</p>
        </form>
    </div>
</div>

<h2>{{ _('Security Settings') }}</h2>

<div style="border: 1px solid #333; border-radius: 4px; padding: 20px; margin-bottom: 20px;">
    <div style="margin-bottom: 20px;">
        <strong>{{ _('Change Password') }}</strong>
        <form method="post" style="margin-top: 10px;">
            <div style="display: flex; gap: 10px; align-items: flex-end;">
                <div style="flex: 1;">
                    <label for="old_password" style="display: block; margin-bottom: 5px; font-size: 0.9em;">{{ _('Old Password') }}</label>
                    <input type="password" name="old_password" id="old_password" required style="width: 100%; padding: 8px;">
                </div>
                <div style="flex: 1;">
                    <label for="password" style="display: block; margin-bottom: 5px; font-size: 0.9em;">{{ _('New Password') }}</label>
                    <input type="password" name="password" id="password" required style="width: 100%; padding: 8px;">
                </div>
                <button type="submit" class="w3-button w3-green" style="padding: 8px 16px; font-size: 14px;">
                    <i class="fa-solid fa-floppy-disk" aria-hidden="true"></i> {{ _('Save') }}
                </button>
            </div>
        </form>
    </div>

    <div style="border-top: 1px solid #333; padding-top: 15px;">
        <form method="post" action="{{ url_for('set_api_key') }}" style="display: flex; gap: 10px; align-items: flex-end;">
            <div style="flex: 1;">
                <label for="api_key" style="display: block; margin-bottom: 5px; font-size: 0.9em;">{{ _('User API Key') }}</label>
                <input type="text" name="api_key" id="api_key" required value="{{ user.api_key or '' }}" style="width: 100%; padding: 8px;">
            </div>
            <button type="submit" class="w3-button w3-green" style="padding: 8px 16px; font-size: 14px;" onclick="return confirm('{{ _('Update API key?') }}');">
                <i class="fa-solid fa-floppy-disk" aria-hidden="true"></i> {{ _('Save') }}
            </button>
        </form>
        <form method="post" action="{{ url_for('generate_api_key') }}" style="margin-top: 10px;">
            <button type="submit" class="w3-button w3-blue" style="padding: 8px 16px; font-size: 14px;" onclick="return confirm('{{ _('Generate a new API key? This will replace your current API key.') }}');">
                <i class="fa-solid fa-arrows-rotate" aria-hidden="true"></i> {{ _('Generate New') }}
            </button>
        </form>
    </div>
</div>

<h2>{{ _('Data Management') }}</h2>

<div style="border: 1px solid #333; border-radius: 4px; padding: 20px; margin-bottom: 20px;">
    <p style="color: #888; font-size: 0.9em; margin-bottom: 20px;">{{ _('Use the export and import features to backup your user account or to move your devices to a new server. The export function creates a JSON file with all your settings, devices, and apps. You can then import this file on another server to restore your configuration. Note that your password is not included in the export for security reasons, so you will need to remember your password when importing to a new server.') }}</p>

    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
        <div style="flex: 1;">
            <strong>{{ _('Export Configuration') }}</strong>
            <div style="margin-top: 8px; color: #888; font-size: 0.9em;">
                {{ _('Download your entire user configuration as a JSON file.') }}
            </div>
        </div>
        <a href="{{ url_for('export_user_config') }}" class="w3-button w3-blue" style="padding: 8px 16px; font-size: 14px; margin-left: 15px;">
            <i class="fa-solid fa-download" aria-hidden="true"></i> {{ _('Export') }}
        </a>
    </div>

    <div style="border-top: 1px solid #333; padding-top: 15px;">
        <strong>{{ _('Import Configuration') }}</strong>
        <div style="margin-top: 8px; color: #888; font-size: 0.9em; margin-bottom: 10px;">
            {{ _('Import your user configuration from a JSON file. This will replace your current configuration, but preserve your username and password.') }}
        </div>
        <form method="post" action="{{ url_for('import_user_config') }}" enctype="multipart/form-data">
            <div style="display: flex; gap: 10px; align-items: flex-end;">
                <div style="flex: 1;">
                    <label for="file" style="display: block; margin-bottom: 5px; font-size: 0.9em;">{{ _('Select JSON File') }}</label>
                    <input type="file" name="file" id="file" accept=".json" required style="width: 100%; padding: 8px;">
                </div>
                <button type="submit" class="w3-button w3-blue" style="padding: 8px 16px; font-size: 14px;">
                    <i class="fa-solid fa-upload" aria-hidden="true"></i> {{ _('Import') }}
                </button>
            </div>
        </form>
    </div>
</div>

<hr style="margin-top: 40px; border: none; border-top: 1px solid #333;">
<div style="font-size: 12px; color: #888; text-align: center; margin-top: 20px;">
    {{ _('Server') }} {{ server_version_info.version }}{% if server_version_info.commit_hash %} (<a href="https://github.com/tronbyt/tronbyt-server/tree/{{ server_version_info.commit_hash }}" target="_blank" style="color: #4CAF50; text-decoration: none; font-family: monospace;">{{ server_version_info.commit_hash[:7] }}</a>){% endif %}
</div>

{% endblock %}
