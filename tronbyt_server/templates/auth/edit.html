{% extends 'base.html' %}
{% block header %}
<h1>{% block title %}{{ _('Edit Settings') }}{% endblock %}</h1>
{% endblock %}
{% block content %}
{% if g.user['username'] == "admin" %}
<h1>{{ _('System Apps Repository') }}</h1>
{% if system_repo_info and system_repo_info.commit_hash %}
<div style="background-color: #2a2a2a; padding: 15px; margin-bottom: 15px; border-radius: 4px; border-left: 4px solid #4CAF50;">
    <div style="margin-bottom: 10px;">
        <strong>{{ _('Installed Commit') }}:</strong>
        <a href="{{ system_repo_info.commit_url }}" target="_blank" style="color: #4CAF50; text-decoration: none;">
            {{ system_repo_info.commit_hash }}
        </a>
    </div>
    <div style="margin-bottom: 10px;">
        <strong>{{ _('Repository') }}:</strong>
        <a href="{{ system_repo_info.repo_url }}" target="_blank" style="color: #4CAF50; text-decoration: none;">
            {{ system_repo_info.repo_url }}
        </a>
    </div>
    <div>
        <strong>{{ _('Branch') }}:</strong> {{ system_repo_info.branch }}
    </div>
</div>
{% endif %}
<form method="post" action="{{ url_for('manager.refresh_system_repo') }}" style="margin-bottom: 20px;">
    <button type="submit" class="w3-button w3-blue" style="font-size: 16px; padding: 12px 24px;">
        üîÑ {{ _('Refresh System Apps') }}
    </button>
</form>
<form method="post" action="{{ url_for('manager.set_system_repo') }}">
    <label for="app_repo_url">{{ _('System Apps Repo URL (Public Github Only!)') }}</label>
    <input name="app_repo_url" id="app_repo_url" required value="{{ user['system_repo_url'] }}">
    {{ _('Replacing the existing system repo will delete the previous repo and break any apps using that repo.') }}
    <input type="submit" value="{{ _('Save') }}" class="w3-button w3-green"></input>
</form>

<h1 id="firmware-management">{{ _('Firmware Management') }}</h1>
{% if firmware_version %}
<div style="background-color: #2a2a2a; padding: 15px; margin-bottom: 15px; border-radius: 4px; border-left: 4px solid #4CAF50;">
    <div style="margin-bottom: 10px;">
        <strong>{{ _('Firmware Image Version') }}:</strong> {{ firmware_version }}
    </div>
    <p style="margin-bottom: 15px; color: #b0b0b0; font-size: 0.9em;">
        {{ _('Firmware is automatically updated when the server starts. You can manually check for and download firmware updates using the button below.') }}
    </p>
    <form method="post" action="{{ url_for('manager.update_firmware') }}" onsubmit="this.querySelector('button').innerHTML='{{ _('Updating...') }}'; this.querySelector('button').disabled=true;">
        <button type="submit" class="w3-button w3-blue" onclick="return confirm('{{ _('Check for firmware updates and download if available?') }}');">
            {{ _('Update Firmware') }}
        </button>
    </form>
    <p style="margin-top: 10px; color: #888; font-size: 0.85em; font-style: italic;">
        ‚ÑπÔ∏è {{ _('Note: This updates the firmware files available for flashing, not the firmware on existing devices. Devices must be manually reflashed to use the new firmware.') }}
    </p>
</div>
{% else %}
<div style="background-color: #2a2a2a; padding: 15px; margin-bottom: 15px; border-radius: 4px; border-left: 4px solid #ff9800;">
    <div style="margin-bottom: 10px;">
        <strong>{{ _('Firmware Status') }}:</strong> {{ _('No firmware version information available') }}
    </div>
    <p style="margin-bottom: 15px; color: #b0b0b0; font-size: 0.9em;">
        {{ _('Click the button below to download the latest firmware files.') }}
    </p>
    <form method="post" action="{{ url_for('manager.update_firmware') }}" onsubmit="this.querySelector('button').innerHTML='{{ _('Downloading...') }}'; this.querySelector('button').disabled=true;">
        <button type="submit" class="w3-button w3-blue" onclick="return confirm('{{ _('Download the latest firmware files?') }}');">
            {{ _('Download Firmware') }}
        </button>
    </form>
    <p style="margin-top: 10px; color: #888; font-size: 0.85em; font-style: italic;">
        ‚ÑπÔ∏è {{ _('Note: This updates the firmware files available for flashing, not the firmware on existing devices. Devices must be manually reflashed to use the new firmware.') }}
    </p>
</div>
{% endif %}
{% endif %}
<form method="post" action="{{ url_for('manager.set_user_repo') }}" >
    <label for="app_repo_url">{{ _('Custom Apps Repo URL (Public Github Only!)') }}</label>
    <input name="app_repo_url" id="app_repo_url" required value="{{ user['app_repo_url'] }}">
    {{ _('Replacing an existing custom repo will delete the previous repo and break any apps using that repo.') }}

    <input type="submit" value="{{ _('Save') }}" class="w3-button w3-green"></input>
</form>
<form method="post" action="{{ url_for('manager.refresh_user_repo') }}">
    <input type="submit" value="{{ _('Refresh') }}" class="w3-button w3-green"></input>
</form>

<h1>{{ _('Edit Password') }}</h1>
<form method="post">
    <label for="old_password">{{ _('Old Password') }}</label>
    <input type="password" name="old_password" id="old_password" required>
    <label for="password">{{ _('New Password') }}</label>
    <input type="password" name="password" id="password" required>
    <input type="submit" value="{{ _('Save') }}" class="w3-button w3-green"></input>
</form>

<h1>{{ _('Edit API Key') }}</h1>
<form method="post" action="{{ url_for('manager.set_api_key') }}">
    <label for="api_key">{{ _('API Key') }}</label>
    <input type="text" name="api_key" id="api_key" required value="{{ user.get('api_key', '') }}">
    <input type="submit" value="{{ _('Save') }}" class="w3-button w3-green"></input>
</form>

<p>{{ _('Use the export and import features to backup your user account or to move your devices to a new server. The export function creates a JSON file with all your settings, devices, and apps. You can then import this file on another server to restore your configuration. Note that your password is not included in the export for security reasons, so you will need to remember your password when importing to a new server.') }}</p>

<h1>{{ _('Export User Data') }}</h1>
<p>{{ _('Export your entire user configuration as a JSON file.') }}</p>
<a href="{{ url_for('manager.export_user_config') }}" class="w3-button w3-blue">{{ _('Export User Data') }}</a>

<h1>{{ _('Import User Data') }}</h1>
<p>{{ _('Import your user configuration from a JSON file. This will replace your current configuration, but preserve your username and password.') }}</p>
<form method="post" action="{{ url_for('manager.import_user_config') }}" enctype="multipart/form-data">
    <input type="file" name="file" accept=".json" required>
    <input type="submit" value="{{ _('Import User Data') }}" class="w3-button w3-blue">
</form>

<hr style="margin-top: 40px; border: none; border-top: 1px solid #333;">
<div style="font-size: 12px; color: #888; text-align: center; margin-top: 20px;">
    {{ _('Server') }} {{ server_version_info.version }}{% if server_version_info.commit_hash %} (<a href="https://github.com/tronbyt/tronbyt-server/tree/{{ server_version_info.commit_hash }}" target="_blank" style="color: #4CAF50; text-decoration: none; font-family: monospace;">{{ server_version_info.commit_hash[:7] }}</a>){% endif %}
</div>

{% endblock %}
