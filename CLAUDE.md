# CLAUDE.md

## Project Overview

This project is the **Tronbyt Server**, a Go-based application which manages Tronbyt devices (flashed Tidbyts) locally, providing a web UI and API for app management and rendering.

The core functionality involves serving WebP images to devices, generated by rendering Pixlet apps (Starlark scripts). The server integrates with the native Go `pixlet` library.

## Key Technologies

*   **Language:** Go 1.25+
*   **Web Framework:** Standard Library `net/http` with `ServeMux` (Go 1.22+ routing features).
*   **Database:** SQLite/Postgres/MySQL with **GORM** (ORM). Data is stored in a relational schema (Users, Devices, Apps).
*   **Templating:** `html/template` (standard library).
*   **Rendering:** Native Go integration with `github.com/tronbyt/pixlet`.
*   **Authentication:** Session-based (secure cookies via `gorilla/sessions`) with Argon2id password hashing.
*   **Internationalization:** `go-i18n` (JSON translation files).

## Project Structure

*   `cmd/boot/`: Entry point for containers.
*   `cmd/server/`: Main entry point for the server binary.
*   `cmd/migrate/`: Tool to migrate legacy SQLite databases to the new schema.
*   `internal/apps/`: App metadata and discovery.
*   `internal/auth/`: Authentication logic (password hashing).
*   `internal/config/`: Configuration loading (env vars).
*   `internal/data/`: Data models and GORM setup.
*   `internal/firmware/`: Device firmware generation.
*   `internal/gitutils/`: Utilities for git operations (apps repositories).
*   `internal/legacy/`: Helpers for reading legacy Python-based data structures.
*   `internal/migration/`: Migration tooling from earlier versions.
*   `internal/renderer/`: Pixlet rendering integration.
*   `internal/server/`: HTTP handlers, middleware, routing, and business logic.
*   `internal/sync/`: Event hub for websockets.
*   `internal/version/`: Version information.
*   `web/i18n/`: Translation files (e.g., `de.json`).
*   `web/static/`: Static assets (CSS, JS, images).
*   `web/templates/`: HTML templates.

## Building and Running

### Local Development

1.  **Dependencies:** Ensure Go 1.25+ and C build tools (gcc) are installed.
2.  **Run with `go run` (for development):**
    ```bash
    go run ./cmd/server -db data/tronbyt.db -data .
    ```
3.  **Build and Run (for production/deployment):**
    ```bash
    go build -o tronbyt-server ./cmd/server
    ./tronbyt-server -db users/new.db -data .
    ```

### Testing

1.  `go test ./...`

### Docker

1.  **Build:**
    ```bash
    docker build -t tronbyt-server .
    ```
2.  **Run:**
    ```bash
    docker run -p 8000:8000 -v $(pwd)/data:/app/data tronbyt-server
    ```

## Development Conventions

*   **Formatting:** Use `go fmt ./...` for Go and `djlint --profile=golang --reformat` for HTML templates.
*   **Linting:** Use `golangci-lint run` for Go and `djlint --profile=golang --lint` for HTML templates.
*   **Logging:** Use `log/slog` for structured logging.
*   **Templates:** Use `{{ t .Localizer "MessageID" }}` for translated strings.
*   **Database:** Use GORM for DB interactions. Ensure migrations are updated in `cmd/migrate` or auto-migrated in `server.go` if appropriate.
    *   **Updates Pattern:** When updating single columns or a subset of fields on a model that has preloaded associations (like `Device.Apps`), ALWAYS use a lightweight struct with only the ID: `s.DB.Model(&data.Device{ID: device.ID}).Update(...)`. Passing the fully populated struct `s.DB.Model(&device)` can trigger GORM to unintentionally re-save preloaded associations, potentially causing race conditions (e.g., deleted apps reappearing).
*   **Testing**: Use the `testify` library (`assert` and `require`) in unit tests.

## Design System

**Inspiration**: Teenage Engineering  
**Aesthetic**: Sharp & Clean, Instrument-Like Precision

### Core Principles

1. **Sharp & Clean**: No rounded corners (`border-radius: 0`), crisp rectangular borders
2. **Focused Palette**: High-contrast monochrome (black/white/grays) with monospace fonts
3. **Instrument Feel**: ALL CAPS labels, precise spacing, functional focus
4. **Mobile Friendly**: Natural vertical stacking on mobile (`@media max-width: 640px`)

### Key Files

*   **CSS**: `/web/static/css/design-system.css` - All design tokens and component styles
*   **Reference**: `/web/templates/partials/app_card.html` - Completed migration example
*   **Guides**: `/INTEGRATION_GUIDE.md` and `/MIGRATION_GUIDE.md`

### Quick Reference

```css
/* Typography */
font-family: var(--font-mono);  /* ui-monospace, SFMono-Regular, etc. */

/* Colors */
--white: #ffffff (light) / #171717 (dark)
--neutral-900: #171717 (light) / #fafafa (dark)
--orange-500: #f97316 (accent for enabled/active states)

/* Borders */
border: 1px solid var(--neutral-700);
border-radius: 0 !important;  /* Always sharp corners */

/* Mobile Stacking */
@media (max-width: 640px) {
    /* Stack vertically, actions at bottom */
}
```

### Button Hierarchy

**Actions are visually coded by semantic color:**

```
Create â”€â”€â†’ Save â”€â”€â†’ Cancel â”€â”€â†’ Delete
  ðŸŸ         â¬›       â¬œ          ðŸ”´
  New!      Keep    Nevermind   Gone!
```

- **Orange** (`.btn-create`) - CREATE, ENABLE, START - Generative actions that create new items
- **Black** (`.btn-save`, `.btn-primary`) - SAVE, CONFIRM, SUBMIT - Finalizing actions that preserve changes
- **Gray** (`.btn-secondary`, `.btn-cancel`) - CANCEL, IMPORT, SECONDARY - Neutral or alternate actions
- **Red** (`.btn-delete`) - DELETE, DISABLE, STOP - Destructive actions that remove items

**Examples:**
- "Create Device" â†’ `.btn-create` (orange)
- "Save Changes" â†’ `.btn-save` (black)
- "Reset" â†’ `.btn-secondary` (gray)
- "Cancel" â†’ `.btn-secondary` (gray)
- "Delete" â†’ `.btn-delete` (red)

### Migration Checklist

When creating/updating UI components:
- [ ] Remove all `border-radius` (set to `0`)
- [ ] Use `var(--font-mono)` for typography
- [ ] Apply sharp `1px solid` borders
- [ ] Use CSS variables for colors (dark mode support)
- [ ] ALL CAPS for status labels (ENABLED, DISABLED, PINNED)
- [ ] Choose correct button class based on action type (see Button Hierarchy above)
- [ ] Use Lucide icons (`data-lucide="icon-name"`)
- [ ] Test mobile layout (`<640px` width)
- [ ] Verify dark mode (`prefers-color-scheme: dark`)

**See**: `MIGRATION_GUIDE.md` for detailed component migration template.