{{ define "edit" }}
{{ template "base" . }}
{{ end }}
{{ define "title" }}{{ t .Localizer "Edit User" }}{{ end }}
{{ define "header" }}
<div class="page-header">
    <h1 class="page-title">{{ t .Localizer "User Settings" }}</h1>
</div>
{{ end }}
{{ define "content" }}
<div class="dashboard-container">

    <!-- System Administration (Admins Only) -->
    {{ if .User.IsAdmin }}
    <div class="form-section">
        <h2 class="section-title">{{ t .Localizer "System Administration" }}</h2>
        
        <div class="form-grid gap-y-8">
            <!-- System Apps Repo -->
            <div class="form-field col-span-full">
                <h3 class="field-label text-sm mb-4">{{ t .Localizer "System Apps Repository" }}</h3>
                <div class="inset-panel">
                    <div class="grid-repo items-start">
                         <div class="form-field">
                            <label class="field-label text-xs">{{ t .Localizer "Current Repository" }}</label>
                            {{ if .SystemRepoInfo }}
                            <div class="mt-1">
                                <div>
                                    <a href="{{ .SystemRepoInfo.URL }}" target="_blank" class="text-link font-bold" id="system-repo-url-link">{{ .SystemRepoInfo.URL }}</a>
                                </div>
                                <div class="field-hint text-xs mt-1" id="system-repo-branch"><strong>{{ t .Localizer "Branch" }}:</strong> {{ .SystemRepoInfo.Branch }}</div>
                                <div class="field-hint text-xs">
                                    <strong>{{ t .Localizer "Commit" }}:</strong>
                                    <a href="{{ .SystemRepoInfo.CommitURL }}" target="_blank" class="text-link font-mono" title="{{ .SystemRepoInfo.CommitHash }}" id="system-repo-commit-link">
                                        {{ if .SystemRepoInfo.CommitMessage }}{{ .SystemRepoInfo.CommitMessage }}{{ else }}{{ substr .SystemRepoInfo.CommitHash 0 8 }}{{ end }}
                                    </a>
                                    {{ if .SystemRepoInfo.CommitDate }}
                                    <span id="system-repo-commit-date" class="ml-2 opacity-70">{{ .SystemRepoInfo.CommitDate }}</span>
                                    {{ end }}
                                </div>
                            </div>
                            {{ else }}
                            <div class="field-hint">{{ t .Localizer "No system repository configured." }}</div>
                            {{ end }}
                         </div>
                         
                        <form method="post" action="/refresh_system_repo" onsubmit="event.preventDefault(); refreshSystemRepo(this);">
                            <button type="submit" class="btn-secondary">
                                <i data-lucide="rotate-cw"></i> {{ t .Localizer "Refresh" }}
                            </button>
                        </form>
                    </div>

                    <div class="mt-6 pt-6 border-t">
                        <form method="post" action="/set_system_repo" class="grid-repo items-end">
                            <div class="form-field">
                                <label for="app_repo_url" class="field-label text-xs">{{ t .Localizer "Change Repository URL" }}</label>
                                <input name="app_repo_url" id="app_repo_url" required value="{{ .GlobalSystemRepoURL }}" class="field-input field-mono">
                                <span class="field-hint mt-2">{{ t .Localizer "Replacing existing system repo will delete the previous repo and break any apps using it." }}</span>
                            </div>
                            <button type="submit" class="btn-create mb-0">
                                <i data-lucide="save"></i> {{ t .Localizer "Save" }}
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Firmware Management -->
            <div class="form-field col-span-full">
                <h3 class="field-label text-sm mb-4">{{ t .Localizer "Firmware Management" }}</h3>
                <div class="inset-panel">
                    <div class="grid-repo items-start">
                        <div class="form-field">
                            <label class="field-label text-xs">{{ t .Localizer "Current Firmware" }}</label>
                            {{ if .FirmwareVersion }}
                            <div class="mt-1">
                                <div id="firmware-version" class="font-mono text-sm"><strong>{{ t .Localizer "Version" }}:</strong> {{ .FirmwareVersion }}</div>
                                <div class="field-hint text-xs mt-1">{{ t .Localizer "Firmware is automatically updated when the server starts." }}</div>
                            </div>
                            {{ else }}
                            <div class="field-hint">{{ t .Localizer "No firmware version information available" }}</div>
                            {{ end }}
                        </div>

                        <form method="post" action="/update_firmware" onsubmit="event.preventDefault(); updateFirmware(this);">
                            <button type="submit" class="btn-secondary">
                                <i {{ if .FirmwareVersion }}data-lucide="rotate-cw"{{ else }}data-lucide="download"{{ end }}></i> 
                                {{ if .FirmwareVersion }}{{ t .Localizer "Update" }}{{ else }}{{ t .Localizer "Download" }}{{ end }}
                            </button>
                        </form>
                    </div>
                    
                    <div class="alert alert-info mt-6 bg-secondary border-neutral-200">
                        <i data-lucide="info" class="text-muted"></i>
                        <div class="alert-content">
                            <p class="text-xs">{{ t .Localizer "Note: This updates the firmware files available for flashing, not the firmware on existing devices. Devices must be manually reflashed to use the new firmware." }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {{ end }}

    <!-- User Custom Repo -->
    <div class="form-section">
        <h2 class="section-title">{{ t .Localizer "Custom Apps Repository" }}</h2>
        <div class="inset-panel">
            <div class="grid-repo items-start">
                <div class="form-field">
                    <label class="field-label text-xs">{{ t .Localizer "Current Repository" }}</label>
                    {{ if .UserRepoInfo }}
                    <div class="mt-1">
                         <div>
                            <a href="{{ .UserRepoInfo.URL }}" target="_blank" class="text-link font-bold">{{ .UserRepoInfo.URL }}</a>
                        </div>
                        <div class="field-hint text-xs mt-1"><strong>{{ t .Localizer "Branch" }}:</strong> {{ .UserRepoInfo.Branch }}</div>
                        <div class="field-hint text-xs">
                            <strong>{{ t .Localizer "Commit" }}:</strong>
                            <a href="{{ .UserRepoInfo.CommitURL }}" target="_blank" class="text-link font-mono" title="{{ .UserRepoInfo.CommitHash }}">
                                {{ if .UserRepoInfo.CommitMessage }}{{ .UserRepoInfo.CommitMessage }}{{ else }}{{ substr .UserRepoInfo.CommitHash 0 8 }}{{ end }}
                            </a>
                            {{ if .UserRepoInfo.CommitDate }}
                            <span class="ml-2 opacity-70">{{ .UserRepoInfo.CommitDate }}</span>
                            {{ end }}
                        </div>
                    </div>
                    {{ else }}
                    <div class="field-hint">{{ t .Localizer "No custom repository configured." }}</div>
                    {{ end }}
                </div>

                {{ if .User.AppRepoURL }}
                <div class="flex gap-2 flex-wrap">
                    <form method="post" action="/refresh_user_repo" onsubmit="var btn = this.querySelector('button'); btn.disabled = true; btn.innerHTML = '<i data-lucide=loader-2></i>'; ">
                        <button type="submit" class="btn-secondary">
                            <i data-lucide="rotate-cw"></i> {{ t .Localizer "Refresh" }}
                        </button>
                    </form>
                    <form method="post" action="/set_user_repo" onsubmit="return confirm('{{ t .Localizer "Remove custom repository? This will delete the repo and break any apps using it." }}');">
                        <input type="hidden" name="app_repo_url" value="">
                        <button type="submit" class="btn-delete">
                            <i data-lucide="trash-2"></i> {{ t .Localizer "Remove" }}
                        </button>
                    </form>
                </div>
                {{ end }}
            </div>

            <div class="mt-6 pt-6 border-t">
                 <form method="post" action="/set_user_repo" class="grid-repo items-end">
                     <div class="form-field">
                        <label for="user_repo_url" class="field-label text-xs">{{ t .Localizer "Change Repository URL" }}</label>
                        <input name="app_repo_url" id="user_repo_url" required value="{{ .User.AppRepoURL }}" class="field-input field-mono">
                        <span class="field-hint mt-2">{{ t .Localizer "Replacing an existing custom repo will delete the previous repo and break any apps using it." }}</span>
                     </div>
                     <button type="submit" class="btn-create mb-0">
                        <i data-lucide="save"></i> {{ t .Localizer "Save" }}
                     </button>
                 </form>
            </div>
        </div>
    </div>

    <!-- Security Settings -->
    <div class="form-section">
        <h2 class="section-title">{{ t .Localizer "Security Settings" }}</h2>
        
        <div class="form-grid gap-y-10">
            <!-- Profile Info -->
            <div class="form-field col-span-full">
                <h3 class="field-label text-sm mb-4">{{ t .Localizer "Profile Information" }}</h3>
                <form method="post" class="inset-panel">
                    <div class="form-grid">
                        <div class="form-field">
                            <label for="email" class="field-label text-xs">{{ t .Localizer "Email Address" }}</label>
                            <input type="email" name="email" id="email" value="{{ if .User.Email }}{{ .User.Email }}{{ end }}" class="field-input">
                        </div>
                    </div>

                    <h4 class="field-label text-xs mt-8 mb-4">{{ t .Localizer "Change Password" }}</h4>
                    <div class="form-grid">
                        <div class="form-field">
                            <label for="old_password" class="field-label text-xs">{{ t .Localizer "Old Password" }}</label>
                            <input type="password" name="old_password" id="old_password" class="field-input">
                        </div>
                        <div class="form-field">
                            <label for="password" class="field-label text-xs">{{ t .Localizer "New Password" }}</label>
                            <input type="password" name="password" id="password" class="field-input">
                        </div>
                    </div>

                    <div class="form-actions mt-8 flex justify-end">
                        <button type="submit" class="btn-create">
                            <i data-lucide="save"></i> {{ t .Localizer "Save Changes" }}
                        </button>
                    </div>
                </form>
            </div>

            <!-- API Key -->
            <div class="form-field col-span-full">
                <h3 class="field-label text-sm mb-4">{{ t .Localizer "API Key" }}</h3>
                <div class="inset-panel">
                    <div class="grid-repo items-end">
                        <form method="post" action="/auth/set_api_key" style="display: contents;">
                            <div class="form-field">
                                <label for="api_key" class="field-label text-xs">{{ t .Localizer "User API Key" }}</label>
                                <input type="text" name="api_key" id="api_key" required value="{{ .User.APIKey }}" class="field-input field-mono">
                            </div>
                            <button type="submit" class="btn-create mb-0" onclick="return confirm('{{ t .Localizer "Update API key?" }}');">
                                <i data-lucide="save"></i> {{ t .Localizer "Update" }}
                            </button>
                        </form>
                    </div>
                    
                    <div class="mt-4 pt-4 border-t flex justify-start">
                        <form method="post" action="/auth/generate_api_key">
                            <button type="submit" class="btn-secondary" onclick="return confirm('{{ t .Localizer "Generate a new API key? This will replace your current API key." }}');">
                                <i data-lucide="rotate-cw"></i> {{ t .Localizer "Generate New API Key" }}
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Passkeys -->
    <div class="form-section">
        <h2 class="section-title">{{ t .Localizer "Passkeys" }}</h2>
        <div class="inset-panel" id="webauthn-settings-container">
            <div class="card-list mb-6">
                {{ range .User.Credentials }}
                <div class="card-item flex justify-between items-center p-4 border border-neutral-200 bg-secondary mb-2">
                    <div class="flex items-center gap-3">
                        <div class="flex items-center justify-center w-8 h-8 border border-neutral-300 bg-tertiary">
                            {{ $iconLight := webauthn_icon .Authenticator false }}
                            {{ $iconDark := webauthn_icon .Authenticator true }}
                            {{ if and $iconLight $iconDark (ne $iconLight $iconDark) }}
                                <img src="{{ $iconLight }}" alt="Auth Icon" class="auth-icon-light authenticator-icon">
                                <img src="{{ $iconDark }}" alt="Auth Icon" class="auth-icon-dark authenticator-icon">
                            {{ else if or $iconLight $iconDark }}
                                <img src="{{ or $iconLight $iconDark }}" alt="Auth Icon" class="authenticator-icon">
                            {{ else }}
                                <i data-lucide="key" class="icon-sm"></i>
                            {{ end }}
                        </div>
                        <span class="font-mono text-sm font-bold">{{ or .Name .Authenticator }}{{ if ne .AttestationType "none" }} <span class="opacity-60 font-normal">({{ .AttestationType }})</span>{{ end }}</span>
                    </div>
                    <button onclick="deletePasskey('{{ .ID }}')" class="btn-delete px-3 py-2" title="{{ t $.Localizer "Delete Passkey" }}">
                        <i data-lucide="trash-2" class="icon-sm mr-0"></i>
                    </button>
                </div>
                {{ else }}
                <p class="field-hint mb-4">{{ t .Localizer "No passkeys registered." }}</p>
                {{ end }}
            </div>
            
            <div class="flex flex-col gap-3">
                <button onclick="registerPasskey()" class="btn-secondary w-fit" {{ if gt (len .User.Credentials) 0 }}disabled title="{{ t .Localizer "Only one passkey allowed" }}"{{ end }}>
                    <i data-lucide="fingerprint"></i> {{ t .Localizer "Register New Passkey" }}
                </button>
                {{ if gt (len .User.Credentials) 0 }}
                <p class="text-xs text-secondary font-mono">
                    <i data-lucide="info" class="icon-sm inline align-text-bottom mr-1"></i> 
                    {{ t .Localizer "Only one passkey can be registered at a time. Delete the existing one to add a new device." }}
                </p>
                {{ end }}
            </div>
        </div>
    </div>

    <!-- Data Management -->
    <div class="form-section">
        <h2 class="section-title">{{ t .Localizer "Data Management" }}</h2>
        
        <div class="form-grid gap-y-10">
            <div class="form-field col-span-full">
                <h3 class="field-label text-sm mb-4">{{ t .Localizer "Export Configuration" }}</h3>
                <div class="inset-panel flex flex-wrap justify-between items-center gap-4 bg-secondary">
                    <div class="flex-1 min-w-0">
                         <p class="text-sm font-bold">{{ t .Localizer "Export Settings" }}</p>
                         <p class="field-hint mt-1">{{ t .Localizer "Download your entire user configuration as a JSON file." }}</p>
                    </div>
                     <a href="/export_user_config" class="btn-secondary flex-shrink-0">
                        <i data-lucide="download"></i> {{ t .Localizer "Export" }}
                    </a>
                </div>
            </div>

            <div class="form-field col-span-full">
                <h3 class="field-label text-sm mb-4">{{ t .Localizer "Import Configuration" }}</h3>
                <div class="inset-panel border-warning bg-tertiary">
                     <p class="text-sm font-bold mb-2">{{ t .Localizer "Important Note" }}</p>
                     <p class="field-hint mb-6 flex items-start gap-2">
                        <i data-lucide="alert-triangle" class="icon-sm text-orange-500 flex-shrink-0 mt-0.5"></i>
                        {{ t .Localizer "Importing a configuration will replace your current settings, but preserve your login credentials." }}
                     </p>
                    
                    <form method="post" action="/import_user_config" enctype="multipart/form-data" class="grid-repo items-end">
                        <div class="form-field">
                            <label for="file" class="field-label text-xs">{{ t .Localizer "Select JSON File" }}</label>
                            <input type="file" name="file" id="file" accept=".json" required class="field-input p-2 font-mono text-xs">
                        </div>
                        <button type="submit" class="btn-secondary mb-0">
                            <i data-lucide="upload"></i> {{ t .Localizer "Import" }}
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- About Server -->
    <div class="text-center mt-12 pb-12 text-neutral-500">
        {{ if .UpdateAvailable }}
        <div class="mb-6">
            <a href="{{ .LatestReleaseURL }}" target="_blank" class="inline-flex items-center gap-2 px-4 py-2 border border-orange-500 text-orange-500 font-bold text-xs uppercase tracking-widest no-underline hover:bg-orange-500 hover:text-white transition-all">
                <i data-lucide="arrow-up-circle" class="icon-sm"></i> {{ t .Localizer "Update available!" }}
            </a>
        </div>
        {{ end }}
        <div class="font-mono text-[10px] uppercase tracking-widest opacity-60">
            {{ t .Localizer "Tronbyt Server" }} â€” v{{ .ServerVersion }}
            {{ if .CommitHash }} 
                // <a href="https://github.com/tronbyt/server/tree/{{ .CommitHash }}" target="_blank" class="text-link">{{ substr .CommitHash 0 7 }}</a>
            {{ end }}
        </div>
    </div>

</div>

<script>
    // JS functions reused from original but cleaner
     function refreshSystemRepo(form) {
        const btn = form.querySelector('button');
        const originalContent = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i data-lucide="loader-2"></i> {{ t .Localizer "Refreshing..." }}';
        if(typeof lucide !== 'undefined') lucide.createIcons({ root: btn });

        fetch(form.action, {
                method: 'POST',
                headers: { 'Accept': 'application/json' }
            })
            .then(r => r.json())
            .then(data => {
                if (data.CommitHash) {
                    const branchEl = document.getElementById('system-repo-branch');
                    if (branchEl) branchEl.innerText = '{{ t .Localizer "Branch" }}: ' + data.Branch;
                    const commitLink = document.getElementById('system-repo-commit-link');
                    if (commitLink) {
                        commitLink.href = data.CommitURL;
                        commitLink.title = data.CommitHash;
                        commitLink.innerText = data.CommitMessage || data.CommitHash.substring(0, 8);
                    }
                    const dateEl = document.getElementById('system-repo-commit-date');
                    if (dateEl) dateEl.innerText = data.CommitDate;
                }
                btn.innerHTML = '<i data-lucide="check"></i> {{ t .Localizer "Success" }}';
            })
            .catch(() => {
                btn.innerHTML = '<i data-lucide="x"></i> {{ t .Localizer "Failed" }}';
            })
            .finally(() => {
                if(typeof lucide !== 'undefined') lucide.createIcons({ root: btn });
                setTimeout(() => {
                    btn.innerHTML = originalContent;
                    btn.disabled = false;
                     if(typeof lucide !== 'undefined') lucide.createIcons({ root: btn });
                }, 2000);
            });
    }

    function updateFirmware(form) {
        const btn = form.querySelector('button');
        const originalContent = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i data-lucide="loader-2"></i> {{ t .Localizer "Updating..." }}';
        if(typeof lucide !== 'undefined') lucide.createIcons({ root: btn });

        fetch(form.action, {
                method: 'POST',
                headers: { 'Accept': 'application/json' }
            })
            .then(r => r.json())
            .then(data => {
                if (data.version) {
                    const el = document.getElementById('firmware-version');
                    if (el) el.innerHTML = '<strong>{{ t .Localizer "Version" }}:</strong> ' + data.version;
                }
                if (data.success) {
                    btn.innerHTML = '<i data-lucide="check"></i> {{ t .Localizer "Success" }}';
                } else {
                    btn.innerHTML = '<i data-lucide="x"></i> {{ t .Localizer "Failed" }}';
                }
            })
            .catch(() => {
                btn.innerHTML = '<i data-lucide="x"></i> {{ t .Localizer "Failed" }}';
            })
            .finally(() => {
                 if(typeof lucide !== 'undefined') lucide.createIcons({ root: btn });
                setTimeout(() => {
                    btn.innerHTML = originalContent;
                    btn.disabled = false;
                     if(typeof lucide !== 'undefined') lucide.createIcons({ root: btn });
                }, 2000);
            });
    }

    // WebAuthn functions (same as before)
     document.addEventListener("DOMContentLoaded", function() {
        if (typeof lucide !== 'undefined') lucide.createIcons();
        
        if (!window.PublicKeyCredential || !navigator.credentials) {
            const el = document.getElementById('webauthn-settings-container');
            if (el) el.style.display = 'none';
        }
    });

    function bufferDecode(value) {
        return Uint8Array.from(atob(value.replace(/-/g, "+").replace(/_/g, "/")), c => c.charCodeAt(0));
    }

    function bufferEncode(value) {
        return btoa(String.fromCharCode.apply(null, new Uint8Array(value)))
            .replace(/\+/g, "-")
            .replace(/\//g, "_")
            .replace(/=/g, "");
    }
    
    // ... deletePasskey and registerPasskey functions (copying logic from original) ...
    async function deletePasskey(id) {
        if (!confirm('{{ t .Localizer "Delete this passkey?" }}')) return;
        try {
            const resp = await fetch('/auth/webauthn/delete/' + encodeURIComponent(id), { method: 'POST' });
            if (resp.ok) location.reload();
            else alert("{{ t .Localizer "Failed to delete passkey" }}");
        } catch (e) {
            console.error(e);
            alert("Error: " + e.message);
        }
    }

    async function registerPasskey() {
        if (!window.PublicKeyCredential || !navigator.credentials) {
            alert("{{ t .Localizer "WebAuthn is not supported in this browser." }}");
            return;
        }
        try {
            const resp = await fetch('/auth/webauthn/register/begin');
            if (!resp.ok) throw new Error("Failed to begin registration");
            const options = await resp.json();
            options.publicKey.challenge = bufferDecode(options.publicKey.challenge);
            options.publicKey.user.id = bufferDecode(options.publicKey.user.id);
            if (options.publicKey.excludeCredentials) {
                options.publicKey.excludeCredentials.forEach(c => { c.id = bufferDecode(c.id); });
            }
            const credential = await navigator.credentials.create({ publicKey: options.publicKey });
            const body = {
                id: credential.id,
                rawId: bufferEncode(credential.rawId),
                type: credential.type,
                response: {
                    attestationObject: bufferEncode(credential.response.attestationObject),
                    clientDataJSON: bufferEncode(credential.response.clientDataJSON),
                }
            };
            const finishResp = await fetch('/auth/webauthn/register/finish', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            if (finishResp.ok) location.reload();
            else alert("Registration failed");
        } catch (e) {
            console.error(e);
            alert("Error: " + e.message);
        }
    }
</script>
{{ end }}
