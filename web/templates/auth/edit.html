{{ define "edit" }}
{{ template "base" . }}
{{ end }}
{{ define "extra_css" }}<link rel="stylesheet" href="/static/css/pages/dashboard.css">{{ end }}
{{ define "title" }}{{ t .Localizer "Edit User" }}{{ end }}
{{ define "header" }}
<div class="page-header">
    <h1 class="page-title">{{ t .Localizer "User Settings" }}</h1>
</div>
{{ end }}
{{ define "content" }}
<div class="dashboard-container">

    <!-- System Administration (Admins Only) -->
    {{ if .User.IsAdmin }}
    <div class="form-section">
        <h2 class="section-title">{{ t .Localizer "System Administration" }}</h2>
        
        <div class="form-grid">
            <!-- System Apps Repo -->
            <div class="form-field col-span-full">
                <label class="field-label">{{ t .Localizer "System Apps Repository" }}</label>
                {{ if .SystemRepoInfo }}
                <div class="flex flex-col gap-3 mb-4 p-3 bg-tertiary rounded border border-neutral-200">
                     <div class="flex flex-col md:flex-row md:items-center justify-between gap-3">
                        <a href="{{ .SystemRepoInfo.URL }}" target="_blank" class="text-sm font-bold break-all hover:text-orange-500 transition-colors">{{ .SystemRepoInfo.URL }}</a>
                        <form method="post" action="/refresh_system_repo" onsubmit="event.preventDefault(); refreshSystemRepo(this);">
                            <button type="submit" class="btn-secondary btn-sm w-full md:w-auto justify-center">
                                <i data-lucide="rotate-cw" class="icon-sm"></i> {{ t .Localizer "Refresh" }}
                            </button>
                        </form>
                    </div>
                    <div class="text-xs text-secondary font-mono flex flex-wrap gap-3 pt-2 border-t border-neutral-200">
                        <span><strong>{{ t .Localizer "Branch" }}:</strong> {{ .SystemRepoInfo.Branch }}</span>
                         <span>
                            <strong>{{ t .Localizer "Commit" }}:</strong>
                            <a href="{{ .SystemRepoInfo.CommitURL }}" target="_blank" class="text-link" title="{{ .SystemRepoInfo.CommitHash }}">
                                {{ if .SystemRepoInfo.CommitMessage }}{{ .SystemRepoInfo.CommitMessage }}{{ else }}{{ substr .SystemRepoInfo.CommitHash 0 8 }}{{ end }}
                            </a>
                        </span>
                    </div>
                </div>
                {{ else }}
                 <div class="text-sm text-secondary italic mb-3">{{ t .Localizer "No system repository configured." }}</div>
                {{ end }}
                
                <form method="post" action="/set_system_repo" class="flex flex-col md:flex-row gap-2 items-end">
                    <div class="flex-1 w-full">
                        <label for="app_repo_url" class="field-label text-xs mb-1.5">{{ t .Localizer "Change Repository URL" }}</label>
                        <input name="app_repo_url" id="app_repo_url" required value="{{ .GlobalSystemRepoURL }}" class="field-input field-mono w-full">
                    </div>
                    <button type="submit" class="btn-secondary w-full md:w-auto justify-center mb-[1px]">
                        <i data-lucide="save"></i> {{ t .Localizer "Save URL" }}
                    </button>
                </form>
                 <p class="field-hint mt-1 text-warning">
                    <i data-lucide="alert-triangle" class="icon-xs inline mr-1"></i>
                    {{ t .Localizer "Replacing existing system repo will delete the previous repo and break any apps using it." }}
                </p>
            </div>

            <!-- Firmware Management -->
            <div class="form-field col-span-full mt-6 pt-6 border-t border-dashed border-neutral-200">
                <label class="field-label">{{ t .Localizer "Firmware Management" }}</label>
                <div class="flex flex-col gap-3">
                     <div class="flex flex-col md:flex-row md:items-center justify-between gap-3 p-3 bg-tertiary rounded border border-neutral-200">
                         <div class="text-sm">
                            {{ if .FirmwareVersion }}
                            <strong>{{ t .Localizer "Current Version" }}:</strong> <span class="font-mono">{{ .FirmwareVersion }}</span>
                            {{ else }}
                            <span class="text-secondary italic">{{ t .Localizer "Unknown version" }}</span>
                            {{ end }}
                        </div>
                        <form method="post" action="/update_firmware" onsubmit="event.preventDefault(); updateFirmware(this);">
                            <button type="submit" class="btn-secondary btn-sm w-full md:w-auto justify-center">
                                <i {{ if .FirmwareVersion }}data-lucide="rotate-cw"{{ else }}data-lucide="download"{{ end }}></i> 
                                {{ if .FirmwareVersion }}{{ t .Localizer "Update Firmware" }}{{ else }}{{ t .Localizer "Download Firmware" }}{{ end }}
                            </button>
                        </form>
                    </div>
                    <p class="text-xs text-secondary flex items-start gap-2">
                        <i data-lucide="info" class="icon-sm mt-0.5 flex-shrink-0"></i>
                         {{ t .Localizer "This updates the firmware available for flashing, not the firmware on existing devices." }}
                    </p>
                </div>
            </div>
        </div>
    </div>
    {{ end }}

    <!-- User Custom Repo -->
    <div class="form-section">
        <h2 class="section-title">{{ t .Localizer "Custom Apps Repository" }}</h2>
        <div class="form-grid">
            <div class="form-field col-span-full">
                 {{ if .UserRepoInfo }}
                <div class="flex flex-col gap-3 mb-4 p-3 bg-tertiary rounded border border-neutral-200">
                     <div class="flex flex-col md:flex-row md:items-center justify-between gap-3">
                        <a href="{{ .UserRepoInfo.URL }}" target="_blank" class="text-sm font-bold break-all hover:text-orange-500 transition-colors">{{ .UserRepoInfo.URL }}</a>
                         {{ if .User.AppRepoURL }}
                        <div class="flex gap-2 w-full md:w-auto">
                             <form method="post" action="/refresh_user_repo" class="flex-1 md:flex-none" onsubmit="var btn = this.querySelector('button'); btn.disabled = true; btn.innerHTML = '<i data-lucide=loader-2 class=icon-sm></i>'; ">
                                <button type="submit" class="btn-secondary btn-sm w-full justify-center px-3">
                                    <i data-lucide="rotate-cw" class="icon-sm"></i> {{ t .Localizer "Refresh" }}
                                </button>
                            </form>
                            <form method="post" action="/set_user_repo" class="flex-1 md:flex-none" onsubmit="return confirm('{{ t .Localizer "Remove custom repository? This will delete the repo and break any apps using it." }}');">
                                <input type="hidden" name="app_repo_url" value="">
                                <button type="submit" class="btn-delete btn-sm w-full justify-center px-3">
                                    <i data-lucide="trash-2" class="icon-sm mr-0"></i> {{ t .Localizer "Remove" }}
                                </button>
                            </form>
                        </div>
                        {{ end }}
                    </div>
                    <div class="text-xs text-secondary font-mono flex flex-wrap gap-3 pt-2 border-t border-neutral-200">
                        <span><strong>{{ t .Localizer "Branch" }}:</strong> {{ .UserRepoInfo.Branch }}</span>
                         <span>
                            <strong>{{ t .Localizer "Commit" }}:</strong>
                            <a href="{{ .UserRepoInfo.CommitURL }}" target="_blank" class="text-link" title="{{ .UserRepoInfo.CommitHash }}">
                                {{ if .UserRepoInfo.CommitMessage }}{{ .UserRepoInfo.CommitMessage }}{{ else }}{{ substr .UserRepoInfo.CommitHash 0 8 }}{{ end }}
                            </a>
                        </span>
                    </div>
                </div>
                {{ else }}
                 <div class="text-sm text-secondary italic mb-3">{{ t .Localizer "No custom repository configured." }}</div>
                {{ end }}

                <form method="post" action="/set_user_repo" class="flex flex-col md:flex-row gap-2 items-end">
                    <div class="flex-1 w-full">
                        <label for="user_repo_url" class="field-label text-xs mb-1.5">{{ t .Localizer "Set Repository URL" }}</label>
                        <input name="app_repo_url" id="user_repo_url" required value="{{ .User.AppRepoURL }}" class="field-input field-mono w-full">
                    </div>
                    <button type="submit" class="btn-secondary w-full md:w-auto justify-center mb-[1px]">
                        <i data-lucide="save"></i> {{ t .Localizer "Save URL" }}
                    </button>
                </form>
                 <p class="field-hint mt-1 text-warning">
                    <i data-lucide="alert-triangle" class="icon-xs inline mr-1"></i>
                    {{ t .Localizer "Replacing an existing custom repo will delete the previous repo and break any apps using it." }}
                </p>
            </div>
        </div>
    </div>

    <!-- Security Settings -->
    <div class="form-section">
        <h2 class="section-title">{{ t .Localizer "Security Settings" }}</h2>
        
        <form method="post">
            <div class="form-grid">
                <div class="form-field col-span-full">
                    <label for="email" class="field-label">{{ t .Localizer "Email Address" }}</label>
                    <input type="email" name="email" id="email" value="{{ if .User.Email }}{{ .User.Email }}{{ end }}" class="field-input max-w-lg">
                </div>
            </div>
             <div class="mt-6 pt-6 border-t border-neutral-200">
                <h3 class="font-bold text-sm mb-4">{{ t .Localizer "Change Password" }}</h3>
                <div class="form-grid">
                    <div class="form-field">
                        <label for="old_password" class="field-label">{{ t .Localizer "Old Password" }}</label>
                        <input type="password" name="old_password" id="old_password" class="field-input">
                    </div>
                    
                    <div class="form-field">
                        <label for="password" class="field-label">{{ t .Localizer "New Password" }}</label>
                        <input type="password" name="password" id="password" class="field-input">
                    </div>

                    <div class="form-actions col-span-full mt-2 flex justify-end">
                        <button type="submit" class="btn-primary">
                            <i data-lucide="save"></i> {{ t .Localizer "Save Changes" }}
                        </button>
                    </div>
                </div>
             </div>
        </form>

        <!-- API Key Separated -->
        <div class="mt-8 pt-8 border-t border-neutral-200">
             <div class="form-grid">
                <div class="form-field col-span-full">
                     <label class="field-label">{{ t .Localizer "API Access" }}</label>
                     <div class="flex flex-col gap-4">
                        <form method="post" action="/auth/set_api_key" class="flex flex-col md:flex-row gap-2 md:items-end">
                            <div class="flex-1 w-full">
                                <label for="api_key" class="field-label text-xs mb-1.5">{{ t .Localizer "Your API Key" }}</label>
                                <input type="text" name="api_key" id="api_key" required value="{{ .User.APIKey }}" class="field-input field-mono w-full">
                            </div>
                            <button type="submit" class="btn-primary w-full md:w-auto" onclick="return confirm('{{ t .Localizer "Update API key?" }}');">
                                <i data-lucide="save"></i> {{ t .Localizer "Update" }}
                            </button>
                        </form>
                        
                        <div class="flex justify-end">
                            <form method="post" action="/auth/generate_api_key">
                                <button type="submit" class="btn-secondary btn-sm" onclick="return confirm('{{ t .Localizer "Generate a new API key? This will replace your current API key." }}');">
                                    <i data-lucide="refresh-cw"></i> {{ t .Localizer "Generate New Random Key" }}
                                </button>
                            </form>
                        </div>
                     </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Passkeys -->
    <div class="form-section">
        <h2 class="section-title">{{ t .Localizer "Passkeys" }}</h2>
        <div class="form-grid">
            <div class="form-field col-span-full">
                <div class="flex flex-col gap-2 mb-4">
                    {{ range .User.Credentials }}
                    <div class="flex justify-between items-center p-3 border border-neutral-200 bg-white">
                        <div class="flex items-center gap-3">
                            <div class="flex items-center justify-center w-8 h-8 rounded bg-neutral-100 text-neutral-500">
                                {{ $iconLight := webauthn_icon .Authenticator false }}
                                {{ $iconDark := webauthn_icon .Authenticator true }}
                                {{ if and $iconLight $iconDark (ne $iconLight $iconDark) }}
                                    <img src="{{ $iconLight }}" alt="Auth Icon" class="auth-icon-light authenticator-icon">
                                    <img src="{{ $iconDark }}" alt="Auth Icon" class="auth-icon-dark authenticator-icon">
                                {{ else if or $iconLight $iconDark }}
                                    <img src="{{ or $iconLight $iconDark }}" alt="Auth Icon" class="authenticator-icon">
                                {{ else }}
                                    <i data-lucide="key" class="icon-sm"></i>
                                {{ end }}
                            </div>
                            <div>
                                <div class="font-bold text-sm">{{ or .Name .Authenticator }}</div>
                                {{ if ne .AttestationType "none" }}
                                <div class="text-xs text-secondary font-mono">{{ .AttestationType }}</div>
                                {{ end }}
                            </div>
                        </div>
                        <button onclick="deletePasskey('{{ .ID }}')" class="btn-delete btn-sm px-2" title="{{ t $.Localizer "Delete Passkey" }}">
                            <i data-lucide="trash-2" class="icon-sm mr-0"></i>
                        </button>
                    </div>
                    {{ else }}
                    <p class="text-sm text-secondary italic text-center py-4 border border-neutral-200">{{ t .Localizer "No passkeys registered." }}</p>
                    {{ end }}
                </div>
                
                <div class="flex flex-col items-start gap-2">
                    <button onclick="registerPasskey()" class="btn-secondary" {{ if gt (len .User.Credentials) 0 }}disabled{{ end }}>
                        <i data-lucide="fingerprint"></i> {{ t .Localizer "Register New Passkey" }}
                    </button>
                    {{ if gt (len .User.Credentials) 0 }}
                    <p class="text-xs text-secondary flex items-center gap-1">
                        <i data-lucide="info" class="icon-xs"></i> 
                        {{ t .Localizer "Only one passkey can be registered at a time." }}
                    </p>
                    {{ end }}
                </div>
            </div>
        </div>
    </div>

    <!-- Configuration Management -->
    <div class="form-section">
        <h2 class="section-title">{{ t .Localizer "Configuration Management" }}</h2>
        
        <div class="flex flex-col md:flex-row gap-3">
            <div class="flex-1 p-3 border border-neutral-200 flex flex-col md:flex-row md:items-center justify-between gap-3">
                <div class="text-sm">
                    <strong>{{ t .Localizer "Export Configuration" }}</strong>
                    <div class="text-xs text-secondary">{{ t .Localizer "Download your entire user configuration as a JSON file." }}</div>
                </div>
                <a href="/export_user_config" class="btn-secondary whitespace-nowrap justify-center">
                    <i data-lucide="download"></i> {{ t .Localizer "Export" }}
                </a>
            </div>

            <div class="flex-1 p-3 border border-neutral-200 flex flex-col md:flex-row md:items-center justify-between gap-3">
                <div class="text-sm">
                    <strong>{{ t .Localizer "Import Configuration" }}</strong>
                    <div class="text-xs text-secondary">{{ t .Localizer "Restore settings from backup." }}</div>
                </div>
                 <form method="post" action="/import_user_config" enctype="multipart/form-data" class="flex items-center">
                    <input type="file" name="file" id="import_file" accept=".json" required class="hidden" onchange="if(confirm('{{ t .Localizer "Importing will replace current settings. Continue?" }}')) this.form.submit();">
                    <button type="button" class="btn-secondary whitespace-nowrap justify-center w-full" onclick="document.getElementById('import_file').click();">
                        <i data-lucide="upload"></i> {{ t .Localizer "Import" }}
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- About Server -->
    <div class="text-center mt-12 pb-12 text-neutral-500">
        {{ if .UpdateAvailable }}
        <div class="mb-6">
            <a href="{{ .LatestReleaseURL }}" target="_blank" class="inline-flex items-center gap-2 px-4 py-2 border border-orange-500 text-orange-500 font-bold text-xs uppercase tracking-widest no-underline hover:bg-orange-500 hover:text-white transition-all">
                <i data-lucide="arrow-up-circle" class="icon-sm"></i> {{ t .Localizer "Update available!" }}
            </a>
        </div>
        {{ end }}
        <div class="font-mono text-[10px] uppercase tracking-widest opacity-60">
            {{ t .Localizer "Tronbyt Server" }} â€” v{{ .ServerVersion }}
            {{ if .CommitHash }} 
                // <a href="https://github.com/tronbyt/server/tree/{{ .CommitHash }}" target="_blank" class="hover:text-primary transition-colors">{{ substr .CommitHash 0 7 }}</a>
            {{ end }}
        </div>
    </div>

</div>

<script>
    // JS functions reused from original but cleaner
     function refreshSystemRepo(form) {
        const btn = form.querySelector('button');
        const originalContent = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i data-lucide=loader-2 class=icon-sm></i>';
        if(typeof lucide !== 'undefined') lucide.createIcons({ root: btn });

        fetch(form.action, {
                method: 'POST',
                headers: { 'Accept': 'application/json' }
            })
            .then(r => r.json())
            .then(data => {
                if (data.CommitHash) {
                    const branchEl = document.getElementById('system-repo-branch');
                    if (branchEl) branchEl.innerText = '{{ t .Localizer "Branch" }}: ' + data.Branch;
                    const commitLink = document.getElementById('system-repo-commit-link');
                    if (commitLink) {
                        commitLink.href = data.CommitURL;
                        commitLink.title = data.CommitHash;
                        commitLink.innerText = data.CommitMessage || data.CommitHash.substring(0, 8);
                    }
                    const dateEl = document.getElementById('system-repo-commit-date');
                    if (dateEl) dateEl.innerText = data.CommitDate;
                }
                btn.innerHTML = '<i data-lucide=check class=icon-sm></i>';
            })
            .catch(() => {
                btn.innerHTML = '<i data-lucide=x class=icon-sm></i>';
            })
            .finally(() => {
                if(typeof lucide !== 'undefined') lucide.createIcons({ root: btn });
                setTimeout(() => {
                    btn.innerHTML = originalContent;
                    btn.disabled = false;
                     if(typeof lucide !== 'undefined') lucide.createIcons({ root: btn });
                }, 2000);
            });
    }

    function updateFirmware(form) {
        const btn = form.querySelector('button');
        const originalContent = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i data-lucide="loader-2"></i> {{ t .Localizer "Updating..." }}';
        if(typeof lucide !== 'undefined') lucide.createIcons({ root: btn });

        fetch(form.action, {
                method: 'POST',
                headers: { 'Accept': 'application/json' }
            })
            .then(r => r.json())
            .then(data => {
                if (data.version) {
                    const el = document.getElementById('firmware-version');
                    if (el) el.innerHTML = '<strong>{{ t .Localizer "Version" }}:</strong> ' + data.version;
                }
                if (data.success) {
                    btn.innerHTML = '<i data-lucide="check"></i> {{ t .Localizer "Success" }}';
                } else {
                    btn.innerHTML = '<i data-lucide="x"></i> {{ t .Localizer "Failed" }}';
                }
            })
            .catch(() => {
                btn.innerHTML = '<i data-lucide="x"></i> {{ t .Localizer "Failed" }}';
            })
            .finally(() => {
                 if(typeof lucide !== 'undefined') lucide.createIcons({ root: btn });
                setTimeout(() => {
                    btn.innerHTML = originalContent;
                    btn.disabled = false;
                     if(typeof lucide !== 'undefined') lucide.createIcons({ root: btn });
                }, 2000);
            });
    }

    // WebAuthn functions (same as before)
     document.addEventListener("DOMContentLoaded", function() {
        if (typeof lucide !== 'undefined') lucide.createIcons();
        
        if (!window.PublicKeyCredential || !navigator.credentials) {
            const el = document.getElementById('webauthn-settings-container');
            if (el) el.style.display = 'none';
        }
    });

    function bufferDecode(value) {
        return Uint8Array.from(atob(value.replace(/-/g, "+").replace(/_/g, "/")), c => c.charCodeAt(0));
    }

    function bufferEncode(value) {
        return btoa(String.fromCharCode.apply(null, new Uint8Array(value)))
            .replace(/\+/g, "-")
            .replace(/\//g, "_")
            .replace(/=/g, "");
    }
    
    // ... deletePasskey and registerPasskey functions ...
    async function deletePasskey(id) {
        if (!confirm('{{ t .Localizer "Delete this passkey?" }}')) return;
        try {
            const resp = await fetch('/auth/webauthn/delete/' + encodeURIComponent(id), { method: 'POST' });
            if (resp.ok) location.reload();
            else alert("{{ t .Localizer "Failed to delete passkey" }}");
        } catch (e) {
            console.error(e);
            alert("Error: " + e.message);
        }
    }

    async function registerPasskey() {
        if (!window.PublicKeyCredential || !navigator.credentials) {
            alert("{{ t .Localizer "WebAuthn is not supported in this browser." }}");
            return;
        }
        try {
            const resp = await fetch('/auth/webauthn/register/begin');
            if (!resp.ok) throw new Error("Failed to begin registration");
            const options = await resp.json();
            options.publicKey.challenge = bufferDecode(options.publicKey.challenge);
            options.publicKey.user.id = bufferDecode(options.publicKey.user.id);
            if (options.publicKey.excludeCredentials) {
                options.publicKey.excludeCredentials.forEach(c => { c.id = bufferDecode(c.id); });
            }
            const credential = await navigator.credentials.create({ publicKey: options.publicKey });
            const body = {
                id: credential.id,
                rawId: bufferEncode(credential.rawId),
                type: credential.type,
                response: {
                    attestationObject: bufferEncode(credential.response.attestationObject),
                    clientDataJSON: bufferEncode(credential.response.clientDataJSON),
                }
            };
            const finishResp = await fetch('/auth/webauthn/register/finish', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            if (finishResp.ok) location.reload();
            else alert("Registration failed");
        } catch (e) {
            console.error(e);
            alert("Error: " + e.message);
        }
    }
</script>
{{ end }}
