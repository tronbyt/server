{{ define "login" }}
{{ template "base" . }}
{{ end }}
{{ define "title" }}{{ t .Localizer "Log In" }}{{ end }}
{{ define "header" }}
<div class="page-header">
    <h1 class="page-title">{{ t .Localizer "LOG IN" }}</h1>
</div>
{{ end }}
{{ define "content" }}
<div class="form-panel auth-panel">

    <form method="post" class="auth-form">
        <!-- Username -->
        <div class="form-field">
            <label for="username" class="field-label field-required">{{ t .Localizer "USERNAME" }}</label>
            <input name="username"
                   id="username"
                   type="text"
                   required
                   class="field-input">
        </div>

        <!-- Password -->
        <div class="form-field">
            <label for="password" class="field-label field-required">{{ t .Localizer "PASSWORD" }}</label>
            <input name="password"
                   id="password"
                   type="password"
                   required
                   class="field-input">
        </div>

        <!-- Remember Me -->
        <div class="form-field-checkbox">
            <label class="checkbox-label">
                <input type="checkbox" name="remember" id="remember">
                <span>{{ t .Localizer "Remember Me" }}</span>
            </label>
        </div>

        <!-- Submit Button -->
        <div class="form-actions">
            <button type="submit" class="btn-save">
                <i data-lucide="log-in" style="width: 18px; height: 18px;"></i>
                <span>{{ t .Localizer "Log In" }}</span>
            </button>
        </div>
    </form>

    <!-- WebAuthn / Passkey Login -->
    <div id="webauthn-login-container">
        <div class="auth-divider">
            <span>{{ t .Localizer "OR" }}</span>
        </div>
        <button onclick="loginWebAuthn()" class="btn-secondary" style="width: 100%;">
            <i data-lucide="fingerprint" style="width: 18px; height: 18px;"></i>
            <span>{{ t .Localizer "Sign in with Passkey" }}</span>
        </button>
    </div>

</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize Lucide icons
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
        
        // Hide WebAuthn container if not supported
        if (!window.PublicKeyCredential || !navigator.credentials) {
            const el = document.getElementById('webauthn-login-container');
            if (el) el.style.display = 'none';
        }
    });

    function bufferDecode(value) {
        return Uint8Array.from(atob(value.replace(/-/g, "+").replace(/_/g, "/")), c => c.charCodeAt(0));
    }

    function bufferEncode(value) {
        return btoa(String.fromCharCode.apply(null, new Uint8Array(value)))
            .replace(/\+/g, "-")
            .replace(/\//g, "_")
            .replace(/=/g, "");
    }

    async function loginWebAuthn() {
        if (!window.PublicKeyCredential || !navigator.credentials) {
            alert("{{ t .Localizer "WebAuthn is not supported in this browser." }}");
            return;
        }
        try {
            const resp = await fetch('/auth/webauthn/login/begin');
            if (!resp.ok) throw new Error("Failed to begin login");

            const options = await resp.json();

            // Fix options
            options.publicKey.challenge = bufferDecode(options.publicKey.challenge);
            if (options.publicKey.allowCredentials) {
                options.publicKey.allowCredentials.forEach(c => {
                    c.id = bufferDecode(c.id);
                });
            }

            const credential = await navigator.credentials.get({
                publicKey: options.publicKey
            });

            const body = {
                id: credential.id,
                rawId: bufferEncode(credential.rawId),
                type: credential.type,
                response: {
                    authenticatorData: bufferEncode(credential.response.authenticatorData),
                    clientDataJSON: bufferEncode(credential.response.clientDataJSON),
                    signature: bufferEncode(credential.response.signature),
                    userHandle: credential.response.userHandle ? bufferEncode(credential.response.userHandle) : null,
                }
            };

            const finishResp = await fetch('/auth/webauthn/login/finish', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(body)
            });

            if (finishResp.ok) {
                window.location.href = '/';
            } else {
                alert("Login failed");
            }
        } catch (e) {
            console.error(e);
            alert("Error: " + e.message);
        }
    }
</script>
{{ end }}
