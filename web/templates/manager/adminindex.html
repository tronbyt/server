{{ define "adminindex" }}
{{ template "base" . }}
{{ end }}
{{ define "title" }}{{ t .Localizer "Tronbyt Manager" }}{{ end }}
{{ define "header" }}
<div class="page-header">
    <div class="flex justify-between items-center gap-4 flex-wrap">
        <h1 class="page-title">{{ t .Localizer "Admin Dashboard" }}</h1>
        {{ if .User }}
        <a class="btn-create" href="/devices/create">
            <i data-lucide="plus-circle"></i> 
            {{ t .Localizer "New Tronbyt" }}
        </a>
        {{ end }}
    </div>
</div>
{{ end }}
{{ define "content" }}
<div class="dashboard-container">
    {{ range .Users }}
    <div class="form-panel mb-8">
        <div class="flex justify-between items-center pb-4 mb-4 border-b">
            <h2 class="section-title m-0 text-xl">{{ .Username }}</h2>
            {{ if ne .Username $.User.Username }}
            <button class="btn-delete w-auto" onclick="deleteUser('{{ .Username }}')">
                <i data-lucide="trash-2"></i> {{ t $.Localizer "Delete User" }}
            </button>
            {{ end }}
        </div>

        {{ if .Devices }}
            {{ $userDevices := .Devices }}
            {{ range .Devices }}
                {{ template "device_card" (dict "Item" . "Localizer" $.Localizer "Devices" $userDevices "ReadOnly" true) }}
            {{ end }}
        {{ else }}
            <div class="alert alert-info">
                <i data-lucide="info"></i>
                <div class="alert-content">
                    <p>{{ t $.Localizer "No devices found for this user." }}</p>
                </div>
            </div>
        {{ end }}
    </div>
    {{ end }}
</div>

<script>
    function deleteUser(username) {
        if (!confirm('{{ t .Localizer "Delete User?" }}')) return;

        fetch('/admin/users/' + username, {
            method: 'DELETE'
        }).then(response => {
            if (response.ok || response.redirected) {
                window.location.reload();
            } else {
                alert('{{ t .Localizer "Failed to delete user" }}');
            }
        }).catch(err => {
            console.error(err);
            alert('{{ t .Localizer "Error deleting user" }}');
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
    });
</script>
{{ end }}
