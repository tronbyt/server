{{ define "configapp" }}
{{ template "base" . }}
{{ end }}
{{ define "title" }}{{ t .Localizer "Configuring" }} {{ .App.Name }}{{ end }}
{{ define "header" }}
<script src="/static/js/location.js"></script>
<div class="page-header">
    <div class="flex justify-between items-center gap-4" style="flex-wrap: wrap;">
        <h1 class="page-title">{{ t .Localizer "Configuring" }} {{ .App.Iname }} ({{ .App.Name }})</h1>
        <div class="flex items-center gap-2">
            <button id="toggleConfigBtn" type="button" class="btn-secondary">
                <i data-lucide="file-code"></i> <span class="button-label">{{ t .Localizer "Show App Config" }}</span>
            </button>
            <button id="toggleDebugBtn" type="button" class="btn-secondary">
                <i data-lucide="bug"></i> <span class="button-label">{{ t .Localizer "Show Render Debug" }}</span>
            </button>
        </div>
    </div>
</div>
{{ end }}
{{ define "content" }}
<div class="form-panel">
    
    <div class="form-actions" style="margin-bottom: 2rem; justify-content: flex-end;">
        <button type="submit" form="dynamicForm" class="btn-save" id="saveButton">
            <i data-lucide="save"></i> {{ t .Localizer "Save" }}
        </button>
        <button type="button" class="btn-secondary" id="cancelButtonTop">
            <i data-lucide="x-circle"></i> {{ t .Localizer "Cancel" }}
        </button>
    </div>

    <div id="configContent" class="hidden" style="margin-bottom: 1rem;">
        <pre class="flash" id="configContentPre" style="max-height: 300px; overflow: auto;"></pre>
    </div>
    <div id="debugContent" class="hidden" style="margin-bottom: 1rem;">
        <pre class="flash" style="max-height: 300px; overflow: auto;">{{ range .App.RenderMessages }}{{ . }}
{{ end }}</pre>
    </div>

    <div class="form-section">
        <div class="flex gap-4 items-start flex-wrap">
            <div style="flex: 0 0 auto;">
                <div class="led-panel" style="width: fit-content;">
                    <img id="previewImage"
                         src="/devices/{{ .Device.ID }}/installations/{{ .App.Iname }}/preview"
                         alt="{{ t .Localizer "Preview" }}"
                         width="128"
                         height="64"
                         style="image-rendering: pixelated; display: block;">
                    <div class="skeleton-loader"></div>
                </div>
            </div>
            <div style="flex: 1; min-width: 200px;">
                {{ if .AppMetadata }}
                <div class="app-metadata">
                    <h3 class="section-title" style="margin-bottom: 0.5rem;">{{ t .Localizer "About" }}</h3>
                    {{ if .AppMetadata.Summary }}
                    <p class="font-bold" style="margin-bottom: 0.5rem;">{{ .AppMetadata.Summary }}</p>
                    {{ end }}
                    {{ if .AppMetadata.Desc }}
                    <div class="text-secondary text-sm">{{ .AppMetadata.Desc }}</div>
                    {{ end }}
                </div>
                {{ end }}
            </div>
        </div>
    </div>

    <form method="post" id="dynamicForm">
        <div class="form-section">
            <h3 class="section-title">{{ t .Localizer "App Configuration" }}</h3>
            <div id="schemaConfigContainer" class="form-grid">
                <!-- Schema fields injected here -->
            </div>
        </div>

        <div class="form-section">
            <h3 class="section-title">{{ t .Localizer "Settings" }}</h3>
            <div class="form-grid">
                <div class="form-field">
                    <label class="field-label">{{ t .Localizer "Name" }}</label>
                    <input type="text" id="name" name="name" class="field-input" value="{{ .App.Name }}" readonly>
                </div>

                <div class="form-field">
                    <label class="field-label" for="uinterval">{{ t .Localizer "Render Interval (Minutes)" }} <span class="field-required"></span></label>
                    <input type="number" name="uinterval" id="uinterval" min="0" class="field-input" value="{{ .App.UInterval }}" data-default="{{ .App.UInterval }}" required>
                    <span class="field-hint">{{ t .Localizer "Update every X minutes" }}</span>
                </div>

                <div class="form-field">
                    <label class="field-label" for="display_time">{{ t .Localizer "Display Time (Seconds)" }}</label>
                    <input type="number" name="display_time" id="display_time" min="0" class="field-input" value="{{ .App.DisplayTime }}" data-default="{{ .App.DisplayTime }}">
                    <span class="field-hint">{{ t .Localizer "0 for device default" }}</span>
                </div>

                <div class="form-field">
                    <label class="field-label" for="color_filter">{{ t .Localizer "Color Filter" }}</label>
                    <select name="color_filter" id="color_filter" class="field-select field-input">
                        {{ range .ColorFilterOptions }}
                        <option value="{{ .Value }}" {{ if eq (derefOr $.App.ColorFilter "inherit") .Value }}selected{{ end }}>{{ t $.Localizer .Name }}</option>
                        {{ end }}
                    </select>
                </div>

                <div class="form-field" style="grid-column: 1 / -1;">
                    <label class="field-label" for="notes">{{ t .Localizer "Notes" }}</label>
                    <input name="notes" id="notes" class="field-input" value="{{ .App.Notes }}" data-default="{{ .App.Notes }}">
                </div>

                <div class="form-field-checkbox" style="grid-column: 1 / -1;">
                    <label class="checkbox-label" for="enabled">
                        <input name="enabled" type="checkbox" id="enabled" {{ if .App.Enabled }}checked{{ end }} data-default="{{ if .App.Enabled }}true{{ else }}false{{ end }}">
                        <span>{{ t .Localizer "Enabled" }}</span>
                    </label>
                </div>

                <div class="form-field-checkbox" style="grid-column: 1 / -1;">
                    <label class="checkbox-label" for="autopin">
                        <input name="autopin" type="checkbox" id="autopin" {{ if .App.AutoPin }}checked{{ end }} data-default="{{ if .App.AutoPin }}true{{ else }}false{{ end }}">
                        <span>{{ t .Localizer "Autopin" }}</span>
                    </label>
                    <span class="field-hint" style="margin-left: 1.5rem;">{{ t .Localizer "Automatically pin this app when it renders successfully" }}</span>
                </div>
            </div>
        </div>

        <div class="form-section">
            <h3 class="section-title">{{ t .Localizer "Schedule" }}</h3>
            <div class="form-grid">
                <div class="form-field">
                    <label class="field-label" for="start_time">{{ t .Localizer "Start Time" }}</label>
                    <input type="time" name="start_time" id="start_time" class="field-input" value="{{ deref .App.StartTime }}" data-default="{{ deref .App.StartTime }}">
                </div>
                <div class="form-field">
                    <label class="field-label" for="end_time">{{ t .Localizer "End Time" }}</label>
                    <input type="time" name="end_time" id="end_time" class="field-input" value="{{ deref .App.EndTime }}" data-default="{{ deref .App.EndTime }}">
                </div>
            </div>

            <div id="legacy_schedule" style="margin-top: 1.5rem;">
                <label class="field-label">{{ t .Localizer "Active Days (Weekly)" }}</label>
                <div class="flex flex-wrap gap-4 mt-2">
                    {{ range $day := (slice "monday" "tuesday" "wednesday" "thursday" "friday" "saturday" "sunday") }}
                    <div class="form-field-checkbox" style="margin-bottom: 0;">
                        <label class="checkbox-label">
                            <input type="checkbox" name="days" value="{{ $day }}" {{ if or (contains $.App.Days $day) (eq (len $.App.Days) 0) }}checked{{ end }}>
                            <span style="text-transform: capitalize;">{{ t $.Localizer $day }}</span>
                        </label>
                    </div>
                    {{ end }}
                </div>
                <span class="field-hint">{{ t .Localizer "(none selected is ALL selected)" }}</span>
            </div>

            <div class="form-field-checkbox" style="margin-top: 2rem;">
                 <label class="checkbox-label" for="use_custom_recurrence">
                    <input type="checkbox" name="use_custom_recurrence" id="use_custom_recurrence" {{ if .App.UseCustomRecurrence }}checked{{ end }} onchange="toggleCustomRecurrence()">
                    <span>{{ t .Localizer "Use Custom Recurrence" }}</span>
                </label>
            </div>

             <div id="custom_recurrence" class="custom-recurrence-section" style="display: none; margin-top: 1rem; border-top: 1px solid var(--neutral-200); padding-top: 1rem;">
                <div class="form-grid">
                    <div class="form-field">
                        <label class="field-label" for="recurrence_type">{{ t .Localizer "Frequency" }}</label>
                        <select name="recurrence_type" id="recurrence_type" class="field-select field-input" onchange="toggleRecurrenceOptions()">
                            <option value="daily" {{ if eq (string .App.RecurrenceType) "daily" }}selected{{ end }}>{{ t .Localizer "Daily" }}</option>
                            <option value="weekly" {{ if eq (string .App.RecurrenceType) "weekly" }}selected{{ end }}>{{ t .Localizer "Weekly" }}</option>
                            <option value="monthly" {{ if eq (string .App.RecurrenceType) "monthly" }}selected{{ end }}>{{ t .Localizer "Monthly" }}</option>
                            <option value="yearly" {{ if eq (string .App.RecurrenceType) "yearly" }}selected{{ end }}>{{ t .Localizer "Yearly" }}</option>
                        </select>
                    </div>
                    <div class="form-field">
                        <label class="field-label" for="recurrence_interval">{{ t .Localizer "Repeat Every" }}</label>
                        <div class="flex items-center gap-2">
                            <input type="number" name="recurrence_interval" id="recurrence_interval" min="1" max="52" class="field-input" value="{{ if .App.RecurrenceInterval }}{{ .App.RecurrenceInterval }}{{ else }}1{{ end }}" style="width: 80px;">
                            <span id="interval_unit" class="text-sm">{{ t .Localizer "days" }}</span>
                        </div>
                    </div>
                    <div class="form-field">
                        <label class="field-label" for="recurrence_start_date">{{ t .Localizer "Start Date" }}</label>
                        <input type="date" name="recurrence_start_date" id="recurrence_start_date" class="field-input" value="{{ deref .App.RecurrenceStartDate }}">
                    </div>
                    <div class="form-field">
                         <label class="field-label" for="recurrence_end_date">{{ t .Localizer "End Date" }} <span class="field-optional">({{ t .Localizer "Optional" }})</span></label>
                        <input type="date" name="recurrence_end_date" id="recurrence_end_date" class="field-input" value="{{ deref .App.RecurrenceEndDate }}">
                    </div>
                </div>
            </div>
        </div>

        <div class="form-actions" style="margin-top: 2rem;">
            <button type="submit" class="btn-save">
                <i data-lucide="save"></i> {{ t .Localizer "Save Changes" }}
            </button>
            <button type="button" class="btn-secondary" id="resetButton">
                <i data-lucide="rotate-ccw"></i> {{ t .Localizer "Reset" }}
            </button>
            {{ if eq .Device.Info.ProtocolType "WS" }}
            <button type="button" class="btn-secondary" id="previewButton">
                <i data-lucide="eye"></i> {{ t .Localizer "Preview" }}
            </button>
            {{ end }}
            <button type="button" class="btn-secondary" onclick="exportConfig()">
                <i data-lucide="download"></i> {{ t .Localizer "Export Config" }}
            </button>
            <button type="button" class="btn-secondary" onclick="document.getElementById('importConfigInput').click()">
                <i data-lucide="upload"></i> {{ t .Localizer "Import Config" }}
            </button>
            <button type="button" class="btn-delete" id="deleteButton" onclick="if(confirm('{{ t .Localizer "Delete App?" }}')) deleteApp('{{ .Device.ID }}', '{{ .App.Iname }}', true)">
                <i data-lucide="trash-2"></i> {{ t .Localizer "Delete" }}
            </button>
        </div>
    </form>
</div>

<input type="file" id="importConfigInput" style="display:none" accept=".json" onchange="importConfig(this)">

<div class="form-panel" style="margin-top: 2rem;">
    <div id="apiUsageContent" class="form-section">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3 class="section-title" style="margin-bottom: 0;">{{ t .Localizer "API Usage" }}</h3>
            <button id="toggleApiUsageBtn" class="btn-ghost">
                <i data-lucide="code"></i> <span class="button-label">{{ t .Localizer "Show API Usage" }}</span>
            </button>
        </div>
        <div class="api-usage-details collapsed hidden" style="margin-top: 1rem;">
             <p class="field-hint">{{ t .Localizer "Use these curl commands to control this app via the API:" }}</p>
             <div class="code-block" style="background:#f5f5f5; padding:1rem; border-radius:4px; margin-bottom:1rem; overflow-x:auto;">
                 <strong>{{ t .Localizer "Enable App" }}</strong>
                 <pre style="margin:0;">curl -X PATCH \
  -H "Authorization: Bearer {{ .Device.APIKey }}" \
  -H "Content-Type: application/json" \
  -d '{"enabled": true}' \
  /v0/devices/{{ .Device.ID }}/installations/{{ .App.Iname }}</pre>
             </div>
         </div>
    </div>
</div>

<script>
  const schema = {{ .Schema }};
  const config = {{ .AppConfig | json }};
  const deleteOnCancel = {{ .DeleteOnCancel }};
  const deviceLocation = {{ if .Device.Location }}{{ json .Device.Location }}{{ else }}null{{ end }};

  function createFormFields(schema, config) {
    const container = document.getElementById('schemaConfigContainer');
    container.innerHTML = ''; 
    if (!schema || !schema.schema) return;

    schema.schema.forEach(field => {
      if (field.type === "generated") return;

      const fieldDiv = document.createElement("div");
      
      const label = document.createElement("label");
      label.className = "field-label";
      const inputId = "schema_" + field.id;
      label.htmlFor = inputId;
      
      const labelText = document.createElement("span");
      labelText.style.display = "inline-flex";
      labelText.style.alignItems = "center";
      labelText.style.gap = "0.5rem";

      if (field.icon) {
          const icon = document.createElement("i");
          icon.setAttribute("data-lucide", field.icon.replace(/[A-Z]/g, match => `-${match.toLowerCase()}`));
          labelText.appendChild(icon);
      }
      labelText.appendChild(document.createTextNode(field.name));
      
      let input;
      if (field.type === "boolean" || field.type === "toggle") {
          fieldDiv.className = "form-field-checkbox"; // Corrected class
          const labelWrapper = document.createElement("label");
          labelWrapper.className = "checkbox-label";
          labelWrapper.htmlFor = inputId;

          input = document.createElement("input");
          input.type = "checkbox";
          input.id = inputId;
          input.dataset.configId = field.id; 
          input.checked = config[field.id] === "true" || config[field.id] === true;
          input.addEventListener('change', handleConfigUpdate);

          labelWrapper.appendChild(input);
          labelWrapper.appendChild(labelText); 
          fieldDiv.appendChild(labelWrapper);
          
      } else {
          fieldDiv.className = "form-field";
          label.appendChild(labelText);
          fieldDiv.appendChild(label);
          
          if (field.type === "select") { 
              input = document.createElement("select");
              input.className = "field-select field-input";
              input.id = inputId;
              input.dataset.configId = field.id;
              
              if (field.options) {
                  field.options.forEach(opt => {
                      const option = document.createElement("option");
                      option.value = opt.value;
                      option.textContent = opt.label;
                      if (config[field.id] === opt.value) option.selected = true;
                      input.appendChild(option);
                  });
              }
              input.addEventListener('change', handleConfigUpdate);
          } else {
              input = document.createElement("input");
              input.className = "field-input";
              input.id = inputId;
              input.dataset.configId = field.id; 
              input.value = config[field.id] !== undefined ? config[field.id] : (field.default || "");
              input.addEventListener('input', handleConfigUpdate);

              if (field.type === "text") input.type = "text";
              else if (field.type === "number") input.type = "number";
              else if (field.type === "password") input.type = "password";
              else if (field.type === "color") input.type = "color";
              else if (field.type === "datetime") input.type = "datetime-local";
              else input.type = "text";
          }
          fieldDiv.appendChild(input);
      }
      
      if (field.description) {
         const desc = document.createElement("span");
         desc.className = "field-hint";
         desc.textContent = field.description;
         fieldDiv.appendChild(desc);
      }
      
      container.appendChild(fieldDiv);
      if (typeof lucide !== 'undefined') lucide.createIcons({ root: fieldDiv });
    });
  }
  
  function toggleContent(content, button, hideText, showText, className) {
    if (content.classList.contains(className)) {
        content.classList.remove(className);
    } else {
        content.classList.add(className);
    }
  }

  function initializeToggleButtons() {
       const toggleApiUsageBtn = document.getElementById("toggleApiUsageBtn");
       const apiUsageDetails = document.querySelector("#apiUsageContent .api-usage-details");
       if (toggleApiUsageBtn && apiUsageDetails) {
            toggleApiUsageBtn.addEventListener("click", () => {
                toggleContent(apiUsageDetails, toggleApiUsageBtn, null, null, "hidden");
            });
       }
       const toggleConfigBtn = document.getElementById("toggleConfigBtn");
       const configContent = document.getElementById("configContent");
       if(toggleConfigBtn) toggleConfigBtn.addEventListener("click", () => {
           toggleContent(configContent, toggleConfigBtn, null, null, "hidden");
       });
       const toggleDebugBtn = document.getElementById("toggleDebugBtn");
       const debugContent = document.getElementById("debugContent");
       if(toggleDebugBtn) toggleDebugBtn.addEventListener("click", () => {
           toggleContent(debugContent, toggleDebugBtn, null, null, "hidden");
       });
  }

  function debounce(func, wait) {
    let timeout;
    return function (...args) {
      clearTimeout(timeout);
      timeout = setTimeout(() => {
        func.apply(this, args);
      }, wait);
    };
  }
  
  const updateConfigAndPreview = debounce(() => {
    const configContentPre = document.getElementById("configContentPre");
    const previewImage = document.getElementById("previewImage");
    if (configContentPre) configContentPre.textContent = JSON.stringify(config, null, 2);

    if (typeof previewApp === 'function') {
        previewApp('{{ .Device.ID }}', '{{ .App.Iname }}', config, null, null)
        .then(() => {
             if(previewImage) {
                 const currentSrc = previewImage.src.split('?')[0];
                 const encodedConfig = encodeURIComponent(JSON.stringify(config));
                 previewImage.src = `${currentSrc}?config=${encodedConfig}&t=${new Date().getTime()}`;
             }
        });
    }
  }, 500);

  function handleConfigUpdate(event) {
    const target = event.target;
    const configId = target.dataset.configId;
    if (!configId) return;
    
    if (target.type === "checkbox") {
      config[configId] = target.checked ? "true" : "false";
    } else {
      config[configId] = target.value;
    }
    updateConfigAndPreview();
  }
  
  function toggleCustomRecurrence() {
      const checkbox = document.getElementById('use_custom_recurrence');
      const section = document.getElementById('custom_recurrence');
      const legacy = document.getElementById('legacy_schedule');
      if(checkbox.checked) {
          section.style.display = 'block';
          if(legacy) legacy.style.display = 'none';
      } else {
          section.style.display = 'none';
          if(legacy) legacy.style.display = 'block';
      }
  }
  
  function toggleRecurrenceOptions() {}
  
  window.toggleCustomRecurrence = toggleCustomRecurrence;
  window.toggleRecurrenceOptions = toggleRecurrenceOptions;

  document.addEventListener('DOMContentLoaded', function() {
      createFormFields(schema, config);
      initializeToggleButtons();
      
      const cancelAction = () => {
          if (deleteOnCancel) {
              if(confirm('{{ t .Localizer "Cancel configuration? This will delete the unconfigured app." }}')) {
                   fetch(`/devices/{{ .Device.ID }}/{{ .App.Iname }}/delete`, { method: 'POST' })
                   .then(() => window.location.href = `/`)
                   .catch(e => { console.error(e); window.location.href = `/`; });
              }
          } else {
              window.history.back();
          }
      };
      
      const cancelButton = document.getElementById('cancelButton');
      if (cancelButton) cancelButton.addEventListener('click', cancelAction);
      
      const cancelButtonTop = document.getElementById('cancelButtonTop');
      if (cancelButtonTop) cancelButtonTop.addEventListener('click', cancelAction);
      
      if (typeof lucide !== 'undefined') lucide.createIcons();
  });
</script>
{{ end }}
