{{ define "create" }}
{{ template "base" . }}
{{ end }}
{{ define "title" }}{{ t .Localizer "New Tronbyt Device" }}{{ end }}
{{ define "header" }}
<script src="/static/js/location.js"></script>
<div class="page-header">
    <h1 class="page-title">{{ t .Localizer "NEW TRONBYT DEVICE" }}</h1>
</div>
<script>
    function setBrightnessCreate(brightness) {
        document.getElementById('brightness').value = brightness;
        const buttons = document.querySelectorAll('.brightness-grid .brightness-btn');
        buttons.forEach(btn => {
            if (parseInt(btn.dataset.brightness) === parseInt(brightness)) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        });
    }
</script>
{{ end }}
{{ define "content" }}
<div class="form-panel">
    <form method="post" id="create-device-form">

        <!-- BASIC INFORMATION SECTION -->
        <div class="form-section">
            <h2 class="section-title">{{ t .Localizer "BASIC INFORMATION" }}</h2>
            
            <div class="form-grid">
                <div class="form-field">
                    <label for="name" class="field-label field-required">{{ t .Localizer "NAME" }}</label>
                    <input name="name"
                           id="name"
                           type="text"
                           value="{{ .Form.Name }}"
                           required
                           class="field-input"
                           placeholder="{{ t .Localizer "My Tronbyt" }}">
                    <span class="field-hint">{{ t .Localizer "Descriptive name for this Tronbyt device" }}</span>
                </div>

                <div class="form-field">
                    <label for="device_type" class="field-label">{{ t .Localizer "DEVICE TYPE" }}</label>
                    <select name="device_type" id="device_type" class="field-input field-select">
                        {{ $deviceType := .Form.DeviceType }}
                        {{ range .DeviceTypeChoices }}
                        <option value="{{ .Value.Slug }}"
                                {{ if eq $deviceType .Value.Slug }}selected{{ end }}>
                            {{ .Label }}
                        </option>
                        {{ end }}
                    </select>
                </div>
            </div>

            <div class="form-field">
                <label for="device_id" class="field-label">
                    {{ t .Localizer "DEVICE ID" }}
                    <span class="field-optional">({{ t .Localizer "Optional" }})</span>
                </label>
                <input name="device_id"
                       id="device_id"
                       type="text"
                       value="{{ .Form.DeviceID }}"
                       class="field-input"
                       placeholder="{{ t .Localizer "Auto-generated if blank" }}">
                <span class="field-hint">{{ t .Localizer "Leave blank to auto-generate." }}</span>
            </div>
        </div>

        <!-- CONNECTION URLS SECTION -->
        <div class="form-section">
            <h2 class="section-title">{{ t .Localizer "CONNECTION URLS" }}</h2>
            
            <div class="form-grid">
                <div class="form-field">
                    <label for="img_url" class="field-label">{{ t .Localizer "IMAGE URL" }}</label>
                    <input name="img_url"
                           id="img_url"
                           type="text"
                           value="{{ .Form.ImgURL }}"
                           class="field-input field-mono"
                           placeholder="http://...">
                    <span class="field-hint">{{ t .Localizer "Leave blank unless advanced user." }}</span>
                </div>

                <div class="form-field">
                    <label for="ws_url" class="field-label">{{ t .Localizer "WEBSOCKET URL" }}</label>
                    <input name="ws_url"
                           id="ws_url"
                           type="text"
                           value="{{ .Form.WsURL }}"
                           class="field-input field-mono"
                           placeholder="ws://...">
                    <span class="field-hint">{{ t .Localizer "Leave blank unless advanced user." }}</span>
                </div>
            </div>
        </div>

        <!-- DISPLAY SETTINGS SECTION -->
        <div class="form-section">
            <h2 class="section-title">{{ t .Localizer "DISPLAY SETTINGS" }}</h2>
            
            <div class="form-field">
                <label class="field-label">{{ t .Localizer "BRIGHTNESS" }}</label>
                <input type="hidden"
                       name="brightness"
                       id="brightness"
                       value="{{ if .Form.Brightness }}{{ .Form.Brightness }}{{ else }}3{{ end }}">
                <div class="brightness-grid">
                    {{ range $i := seq 0 5 }}
                    <button type="button"
                            class="brightness-btn {{ if eq $.Form.Brightness $i }}active{{ else if and (not $.Form.Brightness) (eq $i 3) }}active{{ end }}"
                            data-brightness="{{ $i }}"
                            onclick="setBrightnessCreate({{ $i }})">{{ $i }}</button>
                    {{ end }}
                </div>
            </div>
        </div>

        <!-- LOCATION & NOTES SECTION -->
        <div class="form-section">
            <h2 class="section-title">{{ t .Localizer "LOCATION & NOTES" }}</h2>
            
            <div class="form-grid">
                <div class="form-field">
                    <label for="location_search" class="field-label">{{ t .Localizer "LOCATION" }}</label>
                    <input type="text"
                           id="location_search"
                           placeholder="{{ t .Localizer "Enter a location" }}"
                           value="{{ .Form.LocationSearch }}"
                           class="field-input">
                    <ul id="location_results" class="location-results"></ul>
                    <input type="hidden"
                           name="location"
                           id="location"
                           value='{{ .Form.LocationJSON }}'>
                </div>

                <div class="form-field">
                    <label for="notes" class="field-label">{{ t .Localizer "NOTES" }}</label>
                    <input name="notes"
                           id="notes"
                           type="text"
                           value="{{ .Form.Notes }}"
                           class="field-input"
                           placeholder="{{ t .Localizer "Optional notes about this device" }}">
                </div>
            </div>
        </div>

        <!-- HIDDEN FIELDS -->
        <input type="hidden" name="api_key" id="api_key">

        <!-- CONFIGURATION MANAGEMENT SECTION -->
        <div class="form-section">
            <h2 class="section-title">{{ t .Localizer "CONFIGURATION MANAGEMENT" }}</h2>
            <div class="config-management-container">
                <button type="button"
                        class="btn-action-sm"
                        onclick="document.getElementById('import-file').click();">
                    <i data-lucide="upload" style="width: 16px; height: 16px;"></i>
                    {{ t .Localizer "Import Configuration" }}
                </button>
            </div>
            <span class="field-hint">{{ t .Localizer "Import device settings from a previously exported configuration file." }}</span>
        </div>

        <!-- ACTION BUTTONS -->
        <div class="form-actions">
            <button type="submit" class="btn-create">
                <i data-lucide="plus-circle" style="width: 18px; height: 18px;"></i>
                <span>{{ t .Localizer "Create Device" }}</span>
            </button>
            <button type="button" class="btn-secondary" onclick="window.location.href='/';">
                <i data-lucide="x" style="width: 18px; height: 18px;"></i>
                <span>{{ t .Localizer "Cancel" }}</span>
            </button>
        </div>

    </form>

    <!-- Import Form (Hidden) -->
    <form id="import-device-form"
          method="post"
          action="/devices/import"
          enctype="multipart/form-data"
          style="display: none">
        <input type="file"
               name="file"
               id="import-file"
               accept=".json"
               onchange="this.form.submit();">
    </form>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        enableLocationSearch(
            document.getElementById('location_search'),
            document.getElementById('location_results'),
            document.getElementById('location'),
            null
        );
        
        // Initialize Lucide icons
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
    });
</script>
{{ end }}
