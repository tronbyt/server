{{ define "create" }}
{{ template "base" . }}
{{ end }}
{{ define "title" }}{{ t .Localizer "New Tronbyt Device" }}{{ end }}
{{ define "header" }}
<link rel="stylesheet" href="/static/css/update-simple.css">
<script src="/static/js/location.js"></script>
<div class="header-container">
    <h1 class="page-title">{{ t .Localizer "New Tronbyt Device" }}</h1>
</div>
<script>
    function setBrightnessCreate(brightness) {
        document.getElementById('brightness').value = brightness;
        document.getElementById('brightness-output').innerText = brightness;
        const buttons = document.querySelectorAll('#brightness-panel .brightness-btn');
        buttons.forEach(btn => {
            if (parseInt(btn.dataset.brightness) === parseInt(brightness)) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        });
    }
</script>
{{ end }}
{{ define "content" }}
<form method="post" id="create-device-form">
    <div class="device-settings-section">
        <h2>{{ t .Localizer "Basic Information" }}</h2>
        <div class="device-settings-row">
            <div>
                <label for="name" class="device-settings-label">{{ t .Localizer "Name" }}</label>
                <input name="name"
                       id="name"
                       value="{{ .Form.Name }}"
                       required
                       class="device-settings-input">
                <small class="small-text">{{ t .Localizer "Descriptive name for this Tronbyt device" }}</small>
            </div>
            <div>
                <label for="device_type" class="device-settings-label">{{ t .Localizer "Device Type" }}</label>
                <select name="device_type" id="device_type" class="device-settings-input">
                    {{ $deviceType := $.Form.DeviceType }}
                    {{ $choices := .DeviceTypeChoices }}
                    {{ $orderedKeys := slice "tidbyt_gen1" "tidbyt_gen2" "tronbyt_s3" "tronbyt_s3_wide" "matrixportal_s3" "matrixportal_s3_waveshare" "pixoticker" "raspberrypi" "raspberrypi_wide" "other" }}
                    {{ range $key := $orderedKeys }}
                    <option value="{{ $key }}" {{ if eq $deviceType $key }} selected {{ end }}>{{ index $choices $key }}
                    </option>
                    {{ end }}
                </select>
            </div>
        </div>
    </div>
    <div class="device-settings-section">
        <h2>{{ t .Localizer "Connection URLs" }}</h2>
        <div class="device-settings-row">
            <div>
                <label for="img_url" class="device-settings-label">{{ t .Localizer "Image URL" }}</label>
                <input name="img_url"
                       id="img_url"
                       value="{{ .Form.ImgURL }}"
                       class="device-settings-input">
                <small class="small-text">{{ t .Localizer "Leave blank unless advanced user." }}</small>
            </div>
            <div>
                <label for="ws_url" class="device-settings-label">{{ t .Localizer "WebSocket URL" }}</label>
                <input name="ws_url"
                       id="ws_url"
                       value="{{ .Form.WsURL }}"
                       class="device-settings-input">
                <small class="small-text">{{ t .Localizer "Leave blank unless advanced user." }}</small>
            </div>
        </div>
    </div>
    <div class="device-settings-section">
        <h2>{{ t .Localizer "Display Settings" }}</h2>
        <table class="device-settings-table">
            <tr>
                <td>
                    <label class="device-settings-label">{{ t .Localizer "Brightness Level (0 - 5)" }}</label>
                </td>
                <td>
                    <output id="brightness-output">{{ if .Form.Brightness }}{{ .Form.Brightness }}{{ else }}3{{ end }}</output>
                    <input type="hidden"
                           name="brightness"
                           id="brightness"
                           value="{{ if .Form.Brightness }}{{ .Form.Brightness }}{{ else }}3{{ end }}">
                    <div class="brightness-panel" id="brightness-panel">
                        {{ range $i := seq 0 5 }}
                        <button type="button"
                                class="brightness-btn {{ if eq $.Form.Brightness $i }}active{{ end }}"
                                data-brightness="{{ $i }}"
                                onclick="setBrightnessCreate({{ $i }})">{{ $i }}</button>
                        {{ end }}
                    </div>
                </td>
            </tr>
        </table>
    </div>
    <div class="device-settings-section">
        <h2>{{ t .Localizer "Location & Notes" }}</h2>
        <div class="device-settings-row">
            <div>
                <label for="location_search" class="device-settings-label">{{ t .Localizer "Location" }}</label>
                <input type="text"
                       id="location_search"
                       placeholder="{{ t .Localizer "Enter a location" }}"
                       value="{{ .Form.LocationSearch }}"
                       class="device-settings-input">
                <ul id="location_results">
                </ul>
                <input type="hidden"
                       name="location"
                       id="location"
                       value='{{ .Form.LocationJSON }}'>
            </div>
            <div>
                <label for="notes" class="device-settings-label">{{ t .Localizer "Notes" }}</label>
                <input name="notes"
                       id="notes"
                       value="{{ .Form.Notes }}"
                       class="device-settings-input"
                       placeholder="{{ t .Localizer "Optional notes about this device" }}">
            </div>
        </div>
    </div>
    <input type="hidden" name="api_key" id="api_key">
    <div class="device-settings-section">
        <div class="config-management-container"
             style="display:flex;
                    align-items:center;
                    gap:8px">
            <button type="submit" class="w3-button w3-green config-management-btn">
                <i class="fa-solid fa-floppy-disk" aria-hidden="true"></i> {{ t .Localizer "Save" }}
            </button>
            <button type="button"
                    class="w3-button w3-orange config-management-btn"
                    onclick="document.getElementById('import-file').click();">
                <i class="fa-solid fa-file-import" aria-hidden="true"></i> {{ t .Localizer "Import Configuration" }}
            </button>
        </div>
    </div>
</form>
<form id="import-device-form"
      method="post"
      action="/devices/import"
      enctype="multipart/form-data"
      style="display: none">
    <input type="file"
           name="file"
           id="import-file"
           accept=".json"
           onchange="this.form.submit();">
</form>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        enableLocationSearch(document.getElementById('location_search'), document.getElementById('location_results'), document.getElementById('location'), null);
    });
</script>
{{ end }}
