{{ define "update" }}
{{ template "base" . }}
{{ end }}
{{ define "extra_css" }}<link rel="stylesheet" href="/static/css/pages/dashboard.css">{{ end }}
{{ define "title" }}{{ t .Localizer "Edit Device" }}: {{ .Device.Name }}{{ end }}
{{ define "header" }}
<script src="/static/js/location.js"></script>
<div class="page-header">
    <h1 class="page-title">{{ t .Localizer "Edit Device" }}: {{ .Device.Name }}</h1>
</div>
<script>
    function setBrightnessUpdate(brightness) {
        document.getElementById('brightness').value = brightness;
        const buttons = document.querySelectorAll('#brightness-panel .brightness-btn');
        buttons.forEach(btn => {
            if (parseInt(btn.dataset.brightness) === parseInt(brightness)) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        });
    }

    function setNightBrightnessUpdate(brightness) {
        document.getElementById('night_brightness').value = brightness;
        const buttons = document.querySelectorAll('#night-brightness-panel .brightness-btn');
        buttons.forEach(btn => {
            if (parseInt(btn.dataset.brightness) === parseInt(brightness)) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        });
    }

    function setDimBrightnessUpdate(brightness) {
        document.getElementById('dim_brightness').value = brightness;
        const buttons = document.querySelectorAll('#dim-brightness-panel .brightness-btn');
        buttons.forEach(btn => {
            if (parseInt(btn.dataset.brightness) === parseInt(brightness)) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        });
    }
</script>
{{ end }}
{{ define "content" }}
<div class="dashboard-container has-sticky-actions">
    <form method="post" id="device-form">
        
        <!-- Action Bar Top REMOVED -->

        <!-- Basic Information -->
        <div class="form-section">
            <h2 class="section-title">{{ t .Localizer "Basic Information" }}</h2>
            <div class="form-grid">
                <div class="form-field">
                    <label for="name" class="field-label field-required">{{ t .Localizer "Device Name" }}</label>
                    <input name="name" id="name" value="{{ .Device.Name }}" required class="field-input">
                </div>
                <div class="form-field">
                    <label for="device_type" class="field-label">{{ t .Localizer "Device Type" }}</label>
                    <select name="device_type" id="device_type" class="field-select field-input">
                        {{ $deviceType := .Device.Type }}
                        {{ range .DeviceTypeChoices }}
                        <option value="{{ .Value.Slug }}" {{ if eq $deviceType.Slug .Value.Slug }}selected{{ end }}>
                            {{ .Label }}
                        </option>
                        {{ end }}
                    </select>
                </div>
                
                <div class="form-field col-span-full mt-4">
                     <h4 class="field-label text-sm mb-2">{{ t .Localizer "Connection URLs" }}</h4>
                </div>

                <div class="form-field col-span-full">
                    <label for="img_url" class="field-label">{{ t .Localizer "Image URL" }}</label>
                    <div class="flex gap-2 max-w-3xl">
                        <input name="img_url" id="img_url" value="{{ .Device.ImgURL }}" oninput="updateExampleCommands()" class="field-input field-mono flex-1">
                        <button type="button" class="btn-secondary" onclick="resetImgUrl()" title="{{ t .Localizer "Reset to default" }}">
                            <i data-lucide="rotate-ccw" class="icon-sm"></i>
                        </button>
                    </div>
                </div>

                <div class="form-field col-span-full">
                    <label for="ws_url" class="field-label">{{ t .Localizer "WebSocket URL" }}</label>
                    <div class="flex gap-2 max-w-3xl">
                        <input name="ws_url" id="ws_url" value="{{ .Device.WsURL }}" class="field-input field-mono flex-1">
                        <button type="button" class="btn-secondary" onclick="resetWsUrl()" title="{{ t .Localizer "Reset to default" }}">
                            <i data-lucide="rotate-ccw" class="icon-sm"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Display Settings -->
        <div class="form-section">
            <h2 class="section-title">{{ t .Localizer "Display Settings" }}</h2>
            <div class="form-grid">
                <!-- App Cycle Time - Reusing Dashboard Slider Component -->
                <div class="form-field">
                    <label class="field-label" for="default_interval-{{ .Device.ID }}">
                        {{ t .Localizer "App Cycle Time (Seconds)" }}
                    </label>
                    <div class="slider-container">
                        <span class="slider-label-min">1s</span>
                        <input type="range"
                               name="default_interval"
                               class="cycle-time-slider"
                               id="default_interval-{{ .Device.ID }}"
                               min="1"
                               max="30"
                               value="{{ .Device.DefaultInterval }}"
                               oninput="updateIntervalValue('{{ .Device.ID }}', this.value)">
                        <span id="intervalValue-{{ .Device.ID }}" class="slider-value-label">{{ .Device.DefaultInterval }}s</span>
                    </div>
                </div>

                <div class="form-field">
                    <label for="color_filter" class="field-label">
                        {{ t .Localizer "Color Filter" }}
                         <span class="icon-hover-info ml-1" title="{{ t .Localizer "ColorFilterTooltip" }}">
                            <i data-lucide="info" class="icon-sm text-muted"></i>
                         </span>
                    </label>
                    <select name="color_filter" id="color_filter" class="field-select field-input">
                        {{ range .ColorFilterOptions }}
                        <option value="{{ .Value }}" {{ if eq (derefOr $.Device.ColorFilter "none") .Value }}selected{{ end }}>{{ t $.Localizer .Name }}</option>
                        {{ end }}
                    </select>
                </div>
            </div>

            <h3 class="field-label text-sm mt-8 mb-4">{{ t .Localizer "Brightness Settings" }}</h3>
            
            <div class="form-grid">
                <div class="form-field">
                    <label class="field-label">{{ t .Localizer "Brightness" }}</label>
                    <input type="hidden" name="brightness" id="brightness" value="{{ .BrightnessUI }}">
                    <div class="brightness-grid" id="brightness-panel">
                        {{ range seq 0 5 }}
                        <button type="button" class="brightness-btn {{ if eq $.BrightnessUI . }}active{{ end }}" data-brightness="{{ . }}" onclick="setBrightnessUpdate({{ . }})">{{ . }}</button>
                        {{ end }}
                    </div>
                </div>

                <div class="form-field col-span-full">
                    <div class="form-field-checkbox">
                        <label class="checkbox-label" for="use_custom_brightness_scale">
                            <input type="checkbox" name="use_custom_brightness_scale" id="use_custom_brightness_scale" {{ if ne .Device.CustomBrightnessScale "" }}checked{{ end }} onchange="toggleCustomBrightnessInputs()">
                            <span>{{ t .Localizer "Use Custom Brightness Scale" }}</span>
                        </label>
                         <span class="field-hint ml-4">{{ t .Localizer "Override default brightness scale (0-5)" }}</span>
                    </div>

                    <div id="custom_brightness_inputs" class="mt-4 {{ if eq .Device.CustomBrightnessScale "" }}hidden{{ end }}">
                        <div class="grid gap-4 custom-grid-fill">
                            {{ $scaleValues := slice }}
                            {{ if ne .Device.CustomBrightnessScale "" }}
                            {{ $scaleValues = split .Device.CustomBrightnessScale "," }}
                            {{ end }}
                            {{ $defaultScale := slice "0" "3" "5" "12" "35" "100" }}
                            {{ range $i := seq 0 5 }}
                            <div class="form-field">
                                <label class="field-label text-xs">{{ t $.Localizer "Level" }} {{ $i }} (0-100)</label>
                                <input type="number" name="brightness_level_{{ $i }}" id="brightness_level_{{ $i }}"
                                       value="{{ if lt $i (len $scaleValues) }}{{ index $scaleValues $i | trim }}{{ else }}{{ index $defaultScale $i }}{{ end }}"
                                       min="0" max="100" step="1" class="field-input">
                            </div>
                            {{ end }}
                        </div>
                        <input type="hidden" name="custom_brightness_scale" id="custom_brightness_scale_hidden" value="{{ .Device.CustomBrightnessScale }}">
                         <p class="text-secondary text-xs mt-3 font-mono">
                            <i data-lucide="info" class="icon-sm inline align-text-bottom mr-1"></i>
                            <strong>{{ t .Localizer "Default scale" }}:</strong> 0, 3, 5, 12, 35, 100
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Interstitial App Settings -->
        <div class="form-section">
            <h2 class="section-title">{{ t .Localizer "Interstitial App Settings" }}</h2>
            <div class="form-grid">
               <div class="form-field-checkbox col-span-full">
                    <label class="checkbox-label" for="interstitial_enabled">
                        <input type="checkbox" name="interstitial_enabled" id="interstitial_enabled" {{ if .Device.InterstitialEnabled }}checked{{ end }}>
                        <span>{{ t .Localizer "Enable Interstitial App" }}</span>
                    </label>
                    <span class="field-hint ml-4">{{ t .Localizer "Display an app between each regular app in rotation." }}</span>
                </div>

                <div class="form-field">
                    <label for="interstitial_app" class="field-label">{{ t .Localizer "Select App" }}</label>
                    <select name="interstitial_app" id="interstitial_app" class="field-select field-input">
                        <option value="None">{{ t .Localizer "None" }}</option>
                        {{ range .Device.Apps }}
                        <option value="{{ .Iname }}" {{ if and $.Device.InterstitialApp (eq (deref $.Device.InterstitialApp) .Iname) }}selected{{ end }}>
                            {{ .Iname }} {{ .Name }}
                        </option>
                        {{ end }}
                    </select>
                </div>
            </div>
        </div>

        <!-- Night Mode Settings -->
        <div class="form-section">
            <h2 class="section-title">{{ t .Localizer "Night Mode Settings" }}</h2>
            <div class="form-grid">
                 <div class="form-field-checkbox col-span-full">
                    <label class="checkbox-label" for="night_mode_enabled">
                        <input type="checkbox" name="night_mode_enabled" id="night_mode_enabled" {{ if .Device.NightModeEnabled }}checked{{ end }}>
                        <span>{{ t .Localizer "Enable Night Mode" }}</span>
                    </label>
                </div>

                <div class="form-field">
                    <label for="night_start" class="field-label">{{ t .Localizer "Start Time" }}</label>
                    <input type="time" name="night_start" id="night_start" value="{{ if .Device.NightStart }}{{ .Device.NightStart }}{{ else }}22:00{{ end }}" class="field-input">
                </div>

                <div class="form-field">
                    <label for="night_end" class="field-label">{{ t .Localizer "End Time" }}</label>
                    <input type="time" name="night_end" id="night_end" value="{{ if .Device.NightEnd }}{{ .Device.NightEnd }}{{ else }}06:00{{ end }}" class="field-input">
                </div>

                <div class="form-field">
                    <label class="field-label">{{ t .Localizer "Night Brightness" }}</label>
                    <input type="hidden" name="night_brightness" id="night_brightness" value="{{ .NightBrightnessUI }}">
                    <div class="brightness-grid" id="night-brightness-panel">
                        {{ range seq 0 5 }}
                        <button type="button" class="brightness-btn {{ if eq $.NightBrightnessUI . }}active{{ end }}" data-brightness="{{ . }}" onclick="setNightBrightnessUpdate({{ . }})">{{ . }}</button>
                        {{ end }}
                    </div>
                </div>

                <div class="form-field">
                    <label for="night_mode_app" class="field-label">{{ t .Localizer "Night Mode App" }}</label>
                    <select name="night_mode_app" id="night_mode_app" class="field-select field-input">
                        <option value="None">{{ t .Localizer "None" }}</option>
                        {{ range .Device.Apps }}
                        <option value="{{ .Iname }}" {{ if eq $.Device.NightModeApp .Iname }}selected{{ end }}>
                            {{ .Iname }} {{ .Name }}
                        </option>
                        {{ end }}
                    </select>
                </div>

                 <div class="form-field">
                    <label for="night_color_filter" class="field-label">{{ t .Localizer "Night Color Filter" }}</label>
                    <select name="night_color_filter" id="night_color_filter" class="field-select field-input">
                        {{ range .ColorFilterOptions }}
                        <option value="{{ .Value }}" {{ if eq (derefOr $.Device.NightColorFilter "none") .Value }}selected{{ end }}>{{ t $.Localizer .Name }}</option>
                        {{ end }}
                    </select>
                </div>
            </div>
        </div>

        <!-- Dim Mode Settings -->
        <div class="form-section">
            <h2 class="section-title">{{ t .Localizer "Dim Mode Settings" }}</h2>
             <div class="form-grid">
                <div class="form-field">
                    <label for="dim_time" class="field-label">{{ t .Localizer "Dim Start Time" }}</label>
                    <input type="time" name="dim_time" id="dim_time" value="{{ deref .Device.DimTime }}" class="field-input">
                    <span class="field-hint">{{ t .Localizer "Leave empty to disable. Ends at Night End Time or 6:00 AM." }}</span>
                </div>

                <div class="form-field">
                    <label class="field-label">{{ t .Localizer "Dim Brightness" }}</label>
                    <input type="hidden" name="dim_brightness" id="dim_brightness" value="{{ .DimBrightnessUI }}">
                     <div class="brightness-grid" id="dim-brightness-panel">
                        {{ range seq 0 5 }}
                        <button type="button" class="brightness-btn {{ if eq $.DimBrightnessUI . }}active{{ end }}" data-brightness="{{ . }}" onclick="setDimBrightnessUpdate({{ . }})">{{ . }}</button>
                        {{ end }}
                    </div>
                </div>
            </div>
        </div>

        <!-- Location & API Settings -->
        <div class="form-section">
            <h2 class="section-title">{{ t .Localizer "Location & API Settings" }}</h2>
            <div class="form-grid">
                <div class="form-field">
                    <label for="location_search" class="field-label">{{ t .Localizer "Location" }}</label>
                    <input type="text" id="location_search" placeholder="{{ t .Localizer "Enter a location" }}" value="{{ if .Device.Location }}{{ .Device.Location.Description }}{{ end }}" class="field-input">
                    <ul id="location_results" class="location-results"></ul>
                    <input type="hidden" name="location" id="location" value='{{ if .Device.Location }}{{ json .Device.Location }}{{ else }}{{ "{}" }}{{ end }}'>
                </div>

                <div class="form-field">
                    <label for="locale" class="field-label">{{ t .Localizer "Locale" }}</label>
                    <input type="text" name="locale" id="locale" value="{{ deref .Device.Locale }}" class="field-input" placeholder="e.g. en_US" list="locale-list">
                    <datalist id="locale-list">
                        {{ range .AvailableLocales }}
                        <option value="{{ . }}"></option>
                        {{ end }}
                    </datalist>
                </div>
            </div>
            
             <h4 class="field-label font-bold text-sm mt-8 mb-4">{{ t .Localizer "API Configuration" }}</h4>
             <div class="form-grid">
                 <div class="form-field">
                    <label class="field-label">{{ t .Localizer "Device ID" }}</label>
                    <input value="{{ .Device.ID }}" readonly class="field-input bg-tertiary text-secondary">
                </div>
                <div class="form-field">
                    <label for="api_key" class="field-label">{{ t .Localizer "Device API Key" }}</label>
                    <input name="api_key" id="api_key" value="{{ .Device.APIKey }}" oninput="updateExampleCommands()" class="field-input field-mono">
                </div>
                
                 <div class="form-field col-span-full">
                    <label for="curl_example" class="field-label">{{ t .Localizer "Example curl Command" }}</label>
                    <textarea id="curl_example" rows="3" readonly class="field-input field-mono text-xs text-secondary"></textarea>
                </div>
                
                <div class="form-field col-span-full">
                    <label for="pixlet_example" class="field-label">{{ t .Localizer "Example pixlet Command" }}</label>
                    <textarea id="pixlet_example" rows="3" readonly class="field-input field-mono text-xs text-secondary"></textarea>
                </div>
             </div>
        </div>

        <!-- Additional Settings -->
        <div class="form-section">
            <h2 class="section-title">{{ t .Localizer "Additional Settings" }}</h2>
             <div class="form-grid">
                <div class="form-field col-span-full">
                    <label for="notes" class="field-label">{{ t .Localizer "Notes" }}</label>
                    <textarea name="notes" id="notes" class="field-input" rows="3">{{ .Device.Notes }}</textarea>
                </div>
            </div>
        </div>

        <!-- Firmware Update (OTA) -->
    {{ if .Device.OTACapable }}
    <div class="form-section">
        <h2 class="section-title">{{ t .Localizer "Firmware Update" }}</h2>
        <div class="alert alert-info border-primary bg-secondary p-4 mb-4">
            <i data-lucide="info" class="text-secondary"></i>
            <div class="alert-content">
                <div class="text-sm"><strong>{{ t .Localizer "Device Version" }}:</strong> {{ if .Device.Info.FirmwareVersion }}{{ .Device.Info.FirmwareVersion }}{{ else }}{{ t .Localizer "Unknown" }}{{ end }}</div>
                <div class="text-sm"><strong>{{ t .Localizer "Available Version" }}:</strong> {{ if .FirmwareVersion }}{{ .FirmwareVersion }}{{ else }}{{ t .Localizer "Unknown" }}{{ end }}</div>
            </div>
        </div>

        {{ if .FirmwareAvailable }}
             <div class="form-field-checkbox my-4">
                {{ if eq .Device.Type.Slug "tidbyt_gen1" }}
                <label class="checkbox-label" for="swap_colors">
                    <input type="checkbox" name="swap_colors" id="swap_colors" {{ if .Device.SwapColors }}checked{{ end }}>
                    <span>{{ t .Localizer "Swap Colors (Fix for some Tidbyt Gen 1 displays)" }}</span>
                </label>
                 <span class="field-hint ml-4">{{ t .Localizer "Changing this requires saving before updating." }}</span>
                {{ end }}
            </div>

             <div class="flex flex-col gap-4 mt-4">
                 <button type="button" class="btn-create justify-center" onclick="triggerOTA('{{ .Device.ID }}', '{{ t .Localizer "Trigger OTA Update? Device will reboot." }}')">
                    <i data-lucide="cpu"></i> {{ t .Localizer "Install Latest Firmware" }}
                </button>
            </div>
        {{ else }}
            <p class="text-secondary text-sm">{{ t .Localizer "No official firmware builds available on the server." }}</p>
        {{ end }}

        <div class="border-t border-neutral-200 my-4 pt-4">
            <button type="button" class="btn-primary justify-center w-full" onclick="document.getElementById('custom_firmware_file').click();">
                <i data-lucide="square-code"></i> {{ t .Localizer "Install Custom Firmware" }}
            </button>
            <div class="text-xs text-secondary mt-1 text-center">{{ t .Localizer "Upload and install a custom firmware binary (.bin)." }}</div>
        </div>
    </div>
    {{ end }}

    {{ if .Device.SupportsFirmwareFeatures }}
    <div class="form-section">
        <h2 class="section-title">{{ t .Localizer "Firmware Features" }}</h2>
        <div class="form-grid">
             <div class="form-field col-span-full">
                <label class="field-label">{{ t .Localizer "Image URL" }}</label>
                <div class="flex gap-2">
                    <input type="text"
                           id="reported_img_url"
                           value="{{ derefOr .Device.Info.ImageURL "" }}"
                           class="field-input flex-1 hidden-input-override">
                    <button type="button"
                            class="btn-secondary"
                            onclick="updateFirmwareSettings({image_url: document.getElementById('reported_img_url').value})"
                            title="{{ t .Localizer "Sync current Image URL to device via WebSocket" }}">
                        <i data-lucide="refresh-cw"></i>
                    </button>
                </div>
                 <p class="text-danger text-xs mt-1">
                    <i data-lucide="alert-triangle" class="icon-sm inline"></i>
                    {{ t .Localizer "Warning: Entering an incorrect URL can break the device's connection to this server. Fixing this requires re-flashing the device." }}
                </p>
            </div>
        </div>
    </div>
                                           justify-content: center;
                                           height: 35px"
                                    onclick="updateFirmwareSettings({image_url: document.getElementById('reported_img_url').value})"
                                    title="{{ t .Localizer "Sync current Image URL to device via WebSocket" }}">
                                <i class="fa-solid fa-sync"></i>
                            </button>
                        </div>
                        <p class="small-text" style="color: var(--danger-text); margin-top: 5px">
                            <i class="fa-solid fa-triangle-exclamation"></i>
                            {{ t .Localizer "Warning: Entering an incorrect URL can break the device's connection to this server. Fixing this requires re-flashing the device." }}
                        </p>
                    </td>
                </tr>
                <tr>
                    <td>
                        <label class="device-settings-label">{{ t .Localizer "Swap Colors" }}</label>
                    </td>
                    <td>
                        <label class="switch">
                            <input type="checkbox"
                                   {{ if derefOr .Device.Info.SwapColors false }}
                                   checked
                                   {{ end }}
                                   onchange="updateFirmwareSettings({swap_colors: this.checked})">
                            <span class="slider round"></span>
                        </label>
                    </td>
                </tr>
                <tr>
                    <td>
                        <label class="device-settings-label">{{ t .Localizer "WiFi Power Save" }}</label>
                    </td>
                    <td>
                        <select class="device-settings-input"
                                onchange="updateFirmwareSettings({wifi_power_save: this.value})">
                            <option value="0"
                                    {{ if eq (derefOr .Device.Info.WifiPowerSave 0) 0 }}
                                    selected
                                    {{ end }}>{{ t .Localizer "None" }}
                            </option>
                            <option value="1"
                                    {{ if eq (derefOr .Device.Info.WifiPowerSave 0) 1 }}
                                    selected
                                    {{ end }}>{{ t .Localizer "Minimum" }}
                            </option>
                            <option value="2"
                                    {{ if eq (derefOr .Device.Info.WifiPowerSave 0) 2 }}
                                    selected
                                    {{ end }}>{{ t .Localizer "Maximum" }}
                            </option>
                        </select>
                    </td>
                </tr>
                <tr>
                    <td>
                        <label class="device-settings-label">{{ t .Localizer "Skip Display Version" }}</label>
                    </td>
                    <td>
                        <label class="switch">
                            <input type="checkbox"
                                   {{ if derefOr .Device.Info.SkipDisplayVersion false }}
                                   checked
                                   {{ end }}
                                   onchange="updateFirmwareSettings({skip_display_version: this.checked})">
                            <span class="slider round"></span>
                        </label>
                    </td>
                </tr>
                <tr>
                    <td>
                        <label class="device-settings-label">{{ t .Localizer "Prefer IPv6" }}</label>
                    </td>
                    <td>
                        <label class="switch">
                            <input type="checkbox"
                                   {{ if derefOr .Device.Info.PreferIPv6 false }}
                                   checked
                                   {{ end }}
                                   onchange="updateFirmwareSettings({prefer_ipv6: this.checked})">
                            <span class="slider round"></span>
                        </label>
                    </td>
                </tr>
                <tr>
                    <td>
                        <label class="device-settings-label">{{ t .Localizer "AP Mode (Hotspot)" }}</label>
                    </td>
                    <td>
                        <label class="switch">
                            <input type="checkbox"
                                   {{ if derefOr .Device.Info.APMode false }}
                                   checked
                                   {{ end }}
                                   onchange="updateFirmwareSettings({ap_mode: this.checked})">
                            <span class="slider round"></span>
                        </label>
                        <p class="small-text" style="color: var(--danger-text); margin-top: 5px">
                            <i class="fa-solid fa-triangle-exclamation"></i>
                            {{ t .Localizer "Warning: When AP Mode is turned off, the WiFi network cannot be changed without re-flashing the device." }}
                        </p>
                    </td>
                </tr>
            </table>
            <div style="margin-top: 15px;">
                <button type="button"
                        class="w3-button w3-deep-orange config-management-btn"
                        onclick="rebootDevice()">
                    <i class="fa-solid fa-power-off"></i> {{ t .Localizer "Reboot Device" }}
                </button>
            </div>
        </div>
        <script>
            function updateFirmwareSettings(settings) {
                const params = new URLSearchParams();
                for (const [key, value] of Object.entries(settings)) {
                    params.append(key, value);
                }

                fetch(`/devices/{{ .Device.ID }}/update_firmware_settings`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: params.toString()
                }).then(response => {
                    if (response.ok) {
                        console.log("Settings updated");
                    } else {
                        alert("Failed to update settings");
                    }
                });
            }

            function rebootDevice() {
                 if (confirm('{{ t .Localizer "Are you sure you want to reboot the device?" }}')) {
                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = '/devices/{{ .Device.ID }}/reboot';
                    document.body.appendChild(form);
                    form.submit();
                 }
            }
        </script>
        <style>
            /* Simple switch toggle style */
            .switch {
              position: relative;
              display: inline-block;
              width: 40px;
              height: 20px;
            }
            .switch input {
              opacity: 0;
              width: 0;
              height: 0;
            }
            .slider {
              position: absolute;
              cursor: pointer;
              top: 0;
              left: 0;
              right: 0;
              bottom: 0;
              background-color: #ccc;
              transition: .4s;
            }
            .slider:before {
              position: absolute;
              content: "";
              height: 16px;
              width: 16px;
              left: 2px;
              bottom: 2px;
              background-color: white;
              transition: .4s;
            }
            input:checked + .slider {
              background-color: #2196F3;
            }
            input:focus + .slider {
              box-shadow: 0 0 1px #2196F3;
            }
            input:checked + .slider:before {
              transform: translateX(20px);
            }
            .slider.round {
              border-radius: 20px;
            }
            .slider.round:before {
              border-radius: 50%;
            }
        </style>
    </div>
    {{ end }}


        <!-- Configuration Management -->
        <div class="form-section">
             <h2 class="section-title">{{ t .Localizer "Configuration Management" }}</h2>
             <div class="flex flex-col md:flex-row gap-3">
                <div class="flex-1 p-3 border border-neutral-200 flex flex-col md:flex-row md:items-center justify-between gap-3">
                    <div class="text-sm">
                        <strong>{{ t .Localizer "Export Configuration" }}</strong>
                        <div class="text-xs text-secondary">{{ t .Localizer "Backup device settings." }}</div>
                    </div>
                     <button type="button" class="btn-secondary whitespace-nowrap justify-center" onclick="window.location.href='/devices/{{ .Device.ID }}/export_config'">
                        <i data-lucide="download"></i> {{ t .Localizer "Export" }}
                     </button>
                </div>

                <div class="flex-1 p-3 border border-neutral-200 flex flex-col md:flex-row md:items-center justify-between gap-3">
                    <div class="text-sm">
                        <strong>{{ t .Localizer "Import Configuration" }}</strong>
                        <div class="text-xs text-secondary">{{ t .Localizer "Restore device settings." }}</div>
                    </div>
                     <button type="button" class="btn-secondary whitespace-nowrap justify-center" onclick="document.getElementById('import_config_file').click();">
                        <i data-lucide="upload"></i> {{ t .Localizer "Import" }}
                     </button>
                </div>
             </div>
        </div>

        <!-- Danger Zone - separated by divider -->
        <div class="border-t border-neutral-300 my-8"></div>
         <div class="form-section border-danger">
            <h2 class="section-title text-danger">{{ t .Localizer "Danger Zone" }}</h2>
            <div class="form-actions">
                 <button type="button" class="btn-delete" onclick="deleteDevice();">
                    <i data-lucide="trash-2"></i> {{ t .Localizer "Delete Device" }}
                </button>
            </div>
         </div>
    </form>
    
    <!-- Separate delete form to avoid Chrome issues -->
    <form id="delete-device-form" action="/devices/{{ .Device.ID }}/delete" method="post" style="display: none;"></form>
</div>

<!-- Sticky Action Bar -->
{{ template "sticky_actions" (dict 
    "Localizer" .Localizer 
    "SaveType" "button" 
    "SaveAction" "saveDeviceForm();" 
) }}

<script>
    function deleteDevice() {
        if (confirm('{{ t .Localizer "Delete device and ALL apps? This action cannot be undone." }}')) {
            document.getElementById('delete-device-form').submit();
        }
    }
    
    function resetImgUrl() {
        document.getElementById('img_url').value = '{{ .DefaultImgURL }}';
        updateExampleCommands();
    }
    function resetWsUrl() {
        document.getElementById('ws_url').value = '{{ .DefaultWsURL }}';
    }

    function toggleCustomBrightnessInputs() {
        const checkbox = document.getElementById('use_custom_brightness_scale');
        const inputs = document.getElementById('custom_brightness_inputs');
        if (checkbox.checked) {
            inputs.classList.remove('hidden');
        } else {
            inputs.classList.add('hidden');
        }
    }

    function parseImageUrl(imageUrl) {
        try {
            const url = new URL(imageUrl);
            const pathParts = url.pathname.split("/").filter(Boolean);
            const deviceId = pathParts[0];
            const server = `${url.protocol}//${url.host}`;
            return { server, deviceId };
        } catch (e) {
            return { server: window.location.origin, deviceId: 'UNKNOWN' };
        }
    }

    function updateExampleCommands() {
        const apiKey = document.getElementById("api_key").value.trim();
        const imageUrl = document.getElementById("img_url").value.trim();
        const { server, deviceId } = parseImageUrl(imageUrl);

        const curl = `curl -X POST ${server}/v0/devices/${deviceId}/push -H 'Authorization: ${apiKey || 'CHANGEME'}' -H 'Content-Type: application/json' --data '{"image": "'"$(base64 -w 0 -i test.webp)"'"}'`;
        document.getElementById("curl_example").value = curl;

        const pixlet = `pixlet push -u ${server} -t '${apiKey || 'CHANGEME'}' ${deviceId} test.webp`;
        document.getElementById("pixlet_example").value = pixlet;
    }

    document.addEventListener('DOMContentLoaded', function() {
        if (typeof enableLocationSearch === 'function') {
            enableLocationSearch(document.getElementById('location_search'), document.getElementById('location_results'), document.getElementById('location'), null);
        }
        updateExampleCommands();
        
        // Initialize the cycle time slider highlight
        const slider = document.getElementById('default_interval-{{ .Device.ID }}');
        if (slider && typeof updateIntervalValue === 'function') {
            updateIntervalValue('{{ .Device.ID }}', slider.value);
        }
    });

    function saveDeviceForm() {
        const useCustomScaleCheckbox = document.getElementById('use_custom_brightness_scale');
        const hiddenInput = document.getElementById('custom_brightness_scale_hidden');

        if (useCustomScaleCheckbox && useCustomScaleCheckbox.checked) {
            const values = [];
            for (let i = 0; i < 6; i++) {
                const input = document.getElementById('brightness_level_' + i);
                if (input) values.push(input.value);
            }
            if (hiddenInput) hiddenInput.value = values.join(',');
        } else if (hiddenInput) {
            hiddenInput.value = '';
        }
        document.getElementById('device-form').submit();
    }
</script>

<!-- Hidden form for config import -->
<form action="/devices/{{ .Device.ID }}/import_config" method="post" enctype="multipart/form-data" style="display: none">
    <input type="file" name="file" id="import_config_file" onchange="if(confirm('{{ t .Localizer "Overwrite all current settings and apps?" }}')) { this.form.submit(); } else { this.value = ''; }" accept=".json">
</form>
<form action="/devices/{{ .Device.ID }}/ota"
      method="post"
      enctype="multipart/form-data"
      style="display: none">
    <input type="file"
           name="firmware_file"
           id="custom_firmware_file"
           onchange="if(confirm('{{ t .Localizer "Install custom firmware? The device will reboot." }}')) { this.form.submit(); } else { this.value = ''; }"
           accept=".bin">
</form>
{{ end }}
