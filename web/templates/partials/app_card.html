{{ define "app_card" }}
<!-- App Card Component -->
<div class="w3-card-4 w3-padding app-card" draggable="true" data-iname="{{ .App.Iname }}">
  <div class="app-card-content">
    <!-- Left: Preview Image -->
    <div class="app-preview">
      <div class="app-img">
        <img src="/devices/{{ .Device.ID }}/installations/{{ .App.Iname }}/preview"
             alt="{{ t .Localizer "Preview" }}">
        {{ if .App.EmptyLastRender }}
        <div class="inactive-overlay">
          <span class="inactive-badge-overlay"><i class="fa-solid fa-triangle-exclamation" aria-hidden="true"></i> {{ t .Localizer "INACTIVE" }}</span>
        </div>
        {{ end }}
      </div>
    </div>

    <!-- Middle: App Info and Action Buttons -->
    <div class="app-info">
      <div class="app-header">
        <h3>{{ .App.Name }}-{{ .App.Iname }}</h3>
        <div class="app-status">
          {{ if isPinned .Device .App.Iname }}
          <span class="status-badge pinned"><i class="fa-solid fa-thumbtack" aria-hidden="true"></i> {{ t .Localizer "PINNED" }}</span>
          {{ else }}
            {{ if .App.Enabled }}
            <span class="status-badge enabled"><i class="fa-solid fa-circle-check" aria-hidden="true"></i> {{ t .Localizer "ENABLED" }}</span>
            {{ else }}
            <span class="status-badge disabled"><i class="fa-solid fa-circle-xmark" aria-hidden="true"></i> {{ t .Localizer "DISABLED" }}</span>
            {{ end }}
          {{ end }}
          {{ if and .App.AutoPin (or (isPinned .Device .App.Iname) .App.Enabled) }}
          <span class="status-badge autopin"><i class="fa-solid fa-wand-magic-sparkles" aria-hidden="true"></i> {{ t .Localizer "AUTOPIN" }}</span>
          {{ end }}
        </div>
      </div>

      <div class="app-details">
        <p class="app-render-info">
          {{ t .Localizer "Interval:" }} {{ .App.UInterval }} min |
          {{ if .App.EmptyLastRender }}{{ t .Localizer "No output for " }}{{ end }}
          {{ t .Localizer "Last:" }} {{ timeago .Localizer .App.LastRender }}
          <!-- Duration missing for now -->
        </p>
        {{ if ne .App.DisplayTime 0 }}
        <p>{{ t .Localizer "Display Time (secs):" }} {{ .App.DisplayTime }}</p>
        {{ end }}
        {{ if .App.Notes }}
        <p>{{ t .Localizer "Notes:" }} {{ .App.Notes }}</p>
        {{ end }}
      </div>

      <div class="app-actions">
        <!-- Primary Actions Row -->
        <div class="app-actions-primary">
          <a class="action w3-button w3-blue w3-round"
             href="/devices/{{ .Device.ID }}/{{ .App.Iname }}/config"><i class="fa-solid fa-pen-to-square" aria-hidden="true"></i> {{ t .Localizer "Edit" }}</a>
          {{ if eq .Device.Info.ProtocolType "WS" }}
          <button class="action w3-button w3-blue w3-round"
                  onclick="previewApp('{{ .Device.ID }}', '{{ .App.Iname }}', null, this)"><i class="fa-solid fa-play" aria-hidden="true"></i> {{ t .Localizer "Preview" }}</button>
          {{ end }}
          <button class="action w3-button w3-green w3-round"
                  onclick="duplicateApp('{{ .Device.ID }}', '{{ .App.Iname }}')"><i class="fa-solid fa-copy" aria-hidden="true"></i> {{ t .Localizer "Duplicate" }}</button>

          {{ if gt (len .DevicesWithUIScales) 1 }}
          <div class="copy-to-dropdown">
            <select class="action w3-button w3-indigo w3-round custom-select"
              onchange="if(this.value) { duplicateAppToDevice('{{ .Device.ID }}', '{{ .App.Iname }}', this.value, null, false); this.selectedIndex=0; }">
              <option value="" disabled selected>{{ t .Localizer "Copy to..." }}</option>
              {{ range $item := .DevicesWithUIScales }}
              {{ $target_device := $item.Device }}
              {{ if ne $target_device.ID .Device.ID }}
              <option value="{{ $target_device.ID }}">{{ $target_device.Name }}</option>
              {{ end }}
              {{ end }}
            </select>
            <i class="fa fa-caret-down custom-select-arrow"></i>
          </div>
          {{ end }}

          <button class="action w3-button w3-red w3-round"
                  onclick="deleteApp('{{ .Device.ID }}', '{{ .App.Iname }}', false, {{ t .Localizer "Delete App?" | json }})"><i class="fa-solid fa-trash" aria-hidden="true"></i> {{ t .Localizer "Delete" }}</button>
        </div>

        <!-- Secondary Actions Row -->
        <div class="app-actions-secondary">
          <button class="action w3-button w3-blue w3-round app-btn-no-hover"
                  onclick="moveApp('{{ .Device.ID }}', '{{ .App.Iname }}', 'top')"><i class="fa-solid fa-angles-up" aria-hidden="true"></i> {{ t .Localizer "Top" }}</button>
          <button class="action w3-button w3-blue w3-round app-btn-no-hover"
                  onclick="moveApp('{{ .Device.ID }}', '{{ .App.Iname }}', 'bottom')"><i class="fa-solid fa-angles-down" aria-hidden="true"></i> {{ t .Localizer "Bottom" }}</button>
          {{ if isPinned .Device .App.Iname }}
          <button class="action w3-button w3-orange w3-round app-btn-no-hover"
             onclick="togglePin('{{ .Device.ID }}', '{{ .App.Iname }}')"><i class="fa-solid fa-thumbtack-slash" aria-hidden="true"></i> {{ t .Localizer "Unpin" }}</button>
          {{ else }}
            <button class="action w3-button w3-green w3-round app-btn-no-hover"
               onclick="togglePin('{{ .Device.ID }}', '{{ .App.Iname }}')"><i class="fa-solid fa-thumbtack" aria-hidden="true"></i> {{ t .Localizer "Pin" }}</button>
            {{ if .App.Enabled }}
            <button class="action w3-button w3-orange w3-round app-btn-no-hover"
               onclick="toggleEnabled('{{ .Device.ID }}', '{{ .App.Iname }}')"><i class="fa-solid fa-pause" aria-hidden="true"></i> {{ t .Localizer "Disable" }}</button>
            {{ else }}
            <button class="action w3-button w3-green w3-round app-btn-no-hover"
               onclick="toggleEnabled('{{ .Device.ID }}', '{{ .App.Iname }}')"><i class="fa-solid fa-play" aria-hidden="true"></i> {{ t .Localizer "Enable" }}</button>
            {{ end }}
          {{ end }}
        </div>
      </div>
    </div>
  </div>
</div>
{{ end }}
