{{ define "device_card" }}
<!-- ============================================
     TEENAGE ENGINEERING DESIGN SYSTEM
     Device Card - Sharp, Instrument-Style Control Panel
     Think: OP-1 synthesizer, not generic web form
     ============================================ -->

<div id="device-card-{{ .Item.ID }}" class="device-card-container">

    <!-- DEVICE HEADER -->
    <div class="device-header">
        <div class="device-header-row">
            <h1 class="device-name">
                <a href="{{ .Item.ImgURL }}" target="_blank" class="device-link">{{ .Item.Name }}</a>
            </h1>
            
            <!-- Status Badges -->
            <div class="device-badges">
                {{ if and .Item.PinnedApp (ne (deref .Item.PinnedApp) "") }}
                <span class="badge black">
                    <i data-lucide="pin" class="icon-xs"></i>
                    {{ t .Localizer "PINNED:" }}
                    {{ $pinned := deref .Item.PinnedApp }}
                    {{ $pinnedName := "" }}
                    {{ range .Item.Apps }}
                    {{ if eq .Iname $pinned }}
                    {{ $pinnedName = printf "%s-%s" .Name .Iname }}
                    {{ end }}
                    {{ end }}
                    {{ if ne $pinnedName "" }}{{ $pinnedName }}{{ else }}{{ $pinned }}{{ end }}
                </span>
                {{ end }}

                {{ if .Item.GetNightModeIsActive }}
                <span class="badge gray" title="{{ t .Localizer "Night Mode Active" }}">
                    <i data-lucide="moon" class="icon-xs"></i>
                    {{ t .Localizer "NIGHT MODE" }}
                </span>
                {{ else if .Item.GetDimModeIsActive }}
                <span class="badge gray" title="{{ t .Localizer "Dim Mode Active" }}">
                    <i data-lucide="circle-half" class="icon-xs"></i>
                    {{ t .Localizer "DIM MODE" }}
                </span>
                {{ end }}
            </div>
        </div>
    </div>

    <!-- DEVICE CONTROL PANEL - Two Column Layout -->
    <div class="device-control-panel">

        <!-- LEFT COLUMN: Controls -->
        <div class="device-controls">

            <!-- BRIGHTNESS CONTROL - Instrument-Style Button Grid -->
            <div class="control-group">
                <label class="control-label">{{ t .Localizer "BRIGHTNESS" }}</label>
                {{ if not .ReadOnly }}
                <div class="brightness-grid">
                    {{ range $i := seq 0 5 }}
                    <button type="button"
                            class="brightness-btn {{ if eq $.Item.BrightnessUIScale $i }}active{{ end }}"
                            data-brightness="{{ $i }}"
                            onclick="setBrightness('{{ $.Item.ID }}', {{ $i }})">{{ $i }}</button>
                    {{ end }}
                </div>
                {{ end }}
            </div>

            <!-- APP CYCLE TIME - Precision Slider with Inline Value -->
            <div class="control-group">
                <label class="control-label" for="default_interval-{{ .Item.ID }}">
                    {{ t .Localizer "APP CYCLE TIME" }}
                </label>
                <div class="slider-container">
                    <span class="slider-label-min">1s</span>
                    <input type="range"
                           name="default_interval"
                           class="cycle-time-slider"
                           id="default_interval-{{ .Item.ID }}"
                           min="1"
                           max="30"
                           value="{{ .Item.DefaultInterval }}"
                           {{ if .ReadOnly }}
                           disabled
                           {{ else }}
                           oninput="updateIntervalValue('{{ .Item.ID }}', this.value)"
                           onchange="updateInterval('{{ .Item.ID }}', this.value)"
                           ontouchend="updateInterval('{{ .Item.ID }}', this.value)"
                           {{ end }}>
                    <span id="intervalValue-{{ .Item.ID }}" class="slider-value-label">{{ .Item.DefaultInterval }}s</span>
                </div>
            </div>

            <!-- ACTION BUTTONS - Sharp Rectangular -->
            {{ if not .ReadOnly }}
            <div class="control-group">
                <div class="device-action-grid">
                    <a class="btn-device-action" href="/devices/{{ .Item.ID }}/addapp">
                        <i data-lucide="plus-circle" class="icon-md"></i>
                        <span>{{ t .Localizer "Add App" }}</span>
                    </a>
                    <a class="btn-device-action" href="/devices/{{ .Item.ID }}/update">
                        <i data-lucide="edit-3" class="icon-md"></i>
                        <span>{{ t .Localizer "Edit Device" }}</span>
                    </a>
                    {{ if .Item.Type.SupportsFirmware }}
                    <a class="btn-device-action" href="/devices/{{ .Item.ID }}/firmware">
                        <i data-lucide="cpu" class="icon-md"></i>
                        <span>{{ t .Localizer "Firmware" }}</span>
                    </a>
                    {{ end }}
                </div>
            </div>
            {{ end }}

            <!-- VIEW TOGGLE - Compact/Expand Switch -->
            <div class="control-group">
                <label class="control-label">{{ t .Localizer "VIEW" }}</label>
                <div class="view-toggle-buttons">
                    <button id="compactAllBtn-{{ .Item.ID }}"
                            class="btn-view-toggle active"
                            onclick="toggleAllAppsCompact('{{ .Item.ID }}')"
                            title="{{ t .Localizer "Collapse all app cards" }}">
                        <i data-lucide="minimize-2" class="icon-base"></i>
                        <span>{{ t .Localizer "COMPACT" }}</span>
                    </button>
                    <button id="expandAllBtn-{{ .Item.ID }}"
                            class="btn-view-toggle"
                            onclick="toggleAllAppsExpanded('{{ .Item.ID }}')"
                            title="{{ t .Localizer "Expand all app cards" }}">
                        <i data-lucide="maximize-2" class="icon-base"></i>
                        <span>{{ t .Localizer "EXPAND" }}</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- RIGHT COLUMN: Display Preview + Device Info -->
        <div class="device-preview-section">
            <!-- Currently Displaying App - LED Panel -->
            <div class="currently-displaying">
                <div class="preview-label">{{ t .Localizer "CURRENTLY DISPLAYING" }}</div>
                <div class="led-panel device-led-panel">
                    <img id="currentWebp-{{ .Item.ID }}"
                         class="preview-image device-preview-image"
                         data-src="/devices/{{ .Item.ID }}/current"
                         src="/devices/{{ .Item.ID }}/current"
                         alt="{{ t .Localizer "Preview" }}"
                         loading="lazy">
                </div>
            </div>

            <!-- Device Info (Collapsible) -->
            <div class="device-info-box">
                <button class="device-info-toggle"
                        aria-expanded="false"
                        aria-controls="device-info-content-{{ .Item.ID }}"
                        onclick="toggleDeviceInfo('{{ .Item.ID }}')">
                    <i data-lucide="chevron-down" class="icon-md"></i>
                    <span>{{ t .Localizer "DEVICE INFO" }}</span>
                </button>
                <div id="device-info-content-{{ .Item.ID }}" class="device-info-content">
                    <table class="device-info-table">
                        {{ if .Item.Info.FirmwareVersion }}
                        <tr>
                            <td class="info-label">{{ t $.Localizer "Firmware Version:" }}</td>
                            <td class="info-value">{{ .Item.Info.FirmwareVersion }}</td>
                        </tr>
                        {{ end }}
                        {{ if .Item.Info.FirmwareType }}
                        <tr>
                            <td class="info-label">{{ t $.Localizer "Firmware Type:" }}</td>
                            <td class="info-value">{{ .Item.Info.FirmwareType }}</td>
                        </tr>
                        {{ end }}
                        {{ if .Item.Info.ProtocolVersion }}
                        <tr>
                            <td class="info-label">{{ t $.Localizer "Protocol Version:" }}</td>
                            <td class="info-value">{{ deref .Item.Info.ProtocolVersion }}</td>
                        </tr>
                        {{ end }}
                        {{ if .Item.Info.MACAddress }}
                        <tr>
                            <td class="info-label">{{ t $.Localizer "MAC Address:" }}</td>
                            <td class="info-value">{{ .Item.Info.MACAddress }}</td>
                        </tr>
                        {{ end }}
                        <tr>
                            <td class="info-label">{{ t $.Localizer "Protocol Type:" }}</td>
                            <td class="info-value">{{ .Item.Info.ProtocolType }}</td>
                        </tr>
                        {{ if .Item.LastSeen }}
                        <tr>
                            <td class="info-label">{{ t $.Localizer "Last Seen:" }}</td>
                            <td class="info-value">{{ timeago $.Localizer .Item.LastSeen }}</td>
                        </tr>
                        {{ end }}
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- DRAG INSTRUCTION -->
    {{ if not .ReadOnly }}
    <div class="drag-instruction-bar">
        <i data-lucide="grip-vertical" class="icon-sm"></i>
        <span>{{ t .Localizer "Drag apps to reorder or copy from/to another device" }}</span>
    </div>
    {{ end }}

    <!-- APPS LIST -->
    <div id="appsList-{{ .Item.ID }}" class="apps-list">
        {{ range .Item.Apps }}
        {{ template "app_card" (dict "App" . "Device" $.Item "Localizer" $.Localizer "Devices" $.Devices "ReadOnly" $.ReadOnly) }}
        {{ end }}
    </div>
</div>

<script>
// Toggle all app cards to compact view
function toggleAllAppsCompact(deviceId) {
    const appsList = document.getElementById(`appsList-${deviceId}`);
    const compactBtn = document.getElementById(`compactAllBtn-${deviceId}`);
    const expandBtn = document.getElementById(`expandAllBtn-${deviceId}`);

    if (!appsList) return;

    // Find all expanded app cards and collapse them
    appsList.querySelectorAll('.app-card[data-expanded="true"]').forEach(card => {
        const iname = card.dataset.iname;
        if (iname && typeof collapseAppCard === 'function') {
            collapseAppCard(iname);
        }
    });

    // Update button states
    if (compactBtn) compactBtn.classList.add('active');
    if (expandBtn) expandBtn.classList.remove('active');
}

// Toggle all app cards to expanded view
function toggleAllAppsExpanded(deviceId) {
    const appsList = document.getElementById(`appsList-${deviceId}`);
    const compactBtn = document.getElementById(`compactAllBtn-${deviceId}`);
    const expandBtn = document.getElementById(`expandAllBtn-${deviceId}`);

    if (!appsList) return;

    // Find all compact app cards and expand them
    appsList.querySelectorAll('.app-card[data-expanded="false"]').forEach(card => {
        const iname = card.dataset.iname;
        if (iname && typeof expandAppCard === 'function') {
            expandAppCard(iname);
        }
    });

    // Update button states
    if (expandBtn) expandBtn.classList.add('active');
    if (compactBtn) compactBtn.classList.remove('active');
}

// Toggle device info visibility
function toggleDeviceInfo(deviceId) {
    const toggle = document.querySelector(`#device-card-${deviceId} .device-info-toggle`);
    const content = document.getElementById(`device-info-content-${deviceId}`);
    
    if (!toggle || !content) return;
    
    const isExpanded = toggle.getAttribute('aria-expanded') === 'true';
    toggle.setAttribute('aria-expanded', !isExpanded);
    content.classList.toggle('is-expanded');
}

// Initialize Lucide icons when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }
    
    // Initialize all cycle-time-sliders with their CSS variable
    document.querySelectorAll('.cycle-time-slider').forEach(slider => {
        const min = parseInt(slider.min) || 1;
        const max = parseInt(slider.max) || 30;
        const value = parseInt(slider.value) || min;
        const percentage = ((value - min) / (max - min)) * 100;
        slider.style.setProperty('--slider-value', percentage + '%');
    });
});
</script>
{{ end }}
