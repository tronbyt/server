{{ define "app_list_grid" }}
<div class="app-catalog">
    <div class="catalog-header">
        <h3 class="catalog-title">{{ .Title }}</h3>
        {{ if and .ShowVersion .SystemRepoInfo .SystemRepoInfo.CommitHash }}
        <div class="catalog-version">
            <span class="version-hash">
                (version: <a href="{{ .SystemRepoInfo.CommitURL }}"
                   target="_blank"
                   class="version-link"
                   title="{{ .SystemRepoInfo.CommitHash }}">
                    {{ if .SystemRepoInfo.CommitMessage }}{{ .SystemRepoInfo.CommitMessage }}{{ else }}{{ substr .SystemRepoInfo.CommitHash 0 8 }}{{ end }}
                </a>)
            </span>
            {{ if .SystemRepoInfo.CommitDate }}
            <span class="version-date">{{ .SystemRepoInfo.CommitDate }}</span>
            {{ end }}
        </div>
        {{ end }}
    </div>

    {{ if .ShowControls }}
    <!-- Filter and Sort Controls -->
    <div class="catalog-controls">
        <div class="control-row">
            <div class="search-field">
                <i data-lucide="search" class="search-icon"></i>
                <input type="search"
                       id="{{ .SearchID }}"
                       class="search-input"
                       placeholder="{{ t .Localizer "Search apps..." }}"
                       onkeyup="searchApps('{{ .SearchID }}', '{{ .GridID }}')"
                       oninput="searchApps('{{ .SearchID }}', '{{ .GridID }}')"
                       onkeydown="preventSubmitOnEnter(event)" />
            </div>
            
            <div class="filter-toggles">
                <label class="toggle-label">
                    <input type="checkbox"
                           id="hide_installed_{{ .SearchID }}"
                           onchange="toggleInstalledApps('{{ .SearchID }}')"
                           class="toggle-checkbox">
                    <span class="toggle-text">{{ t .Localizer "Hide installed" }}</span>
                </label>
                <label class="toggle-label">
                    <input type="checkbox"
                           id="show_broken_{{ .SearchID }}"
                           onchange="toggleBrokenApps('{{ .SearchID }}')"
                           class="toggle-checkbox">
                    <span class="toggle-text">{{ t .Localizer "Show broken" }}</span>
                </label>
            </div>
            
            <div class="sort-field">
                <label for="sort_{{ .SearchID }}" class="sort-label">{{ t .Localizer "Sort by:" }}</label>
                <select id="sort_{{ .SearchID }}" class="sort-select" onchange="sortApps('{{ .SearchID }}')">
                    <option value="system" selected>{{ t .Localizer "Default" }}</option>
                    <option value="newest">{{ t .Localizer "Newest" }}</option>
                    <option value="alphabetical">{{ t .Localizer "A-Z" }}</option>
                    <option value="rev-alphabetical">{{ t .Localizer "Z-A" }}</option>
                </select>
            </div>
        </div>
    </div>
    {{ end }}

    <div id="{{ .GridID }}" class="app-grid">
        {{ range .Apps }}
        {{ template "app_card_grid_item" (dict "App" . "DeviceID" $.DeviceID "Localizer" $.Localizer "IsCustom" $.IsCustom "ConfigProduction" $.ConfigProduction) }}
        {{ end }}
    </div>
</div>
{{ end }}

{{ define "app_card_grid_item" }}
<div class="app-tile {{ if .App.Broken }}is-broken{{ end }}"
     data-value="{{ .App.ID }}"
     data-path="{{ .App.Path }}"
     data-name="{{ .App.Name }}"
     data-installed="{{ .App.IsInstalled }}"
     data-recommended-interval="{{ .App.RecommendedInterval }}"
     data-date="{{ .App.Date }}"
     data-broken="{{ .App.Broken }}"
     data-author="{{ .App.Author }}">
    
    <div class="tile-badges">
        {{ if .App.IsInstalled }}
        <span class="tile-badge badge-installed">{{ t .Localizer "Installed" }}</span>
        {{ end }}
        {{ if .App.Supports2x }}
        <span class="tile-badge badge-2x">2x</span>
        {{ end }}
    </div>

    <div class="tile-preview">
        <div class="preview-skeleton"></div>
        <img data-src="/preview/app/{{ .App.ID }}"
             alt="{{ .App.Name }}"
             class="preview-image lazy-image"
             width="64"
             height="32"
             loading="lazy">
    </div>

    <div class="tile-info">
        <h4 class="tile-name">{{ .App.Name }}</h4>
        <p class="tile-summary">{{ .App.Summary }}</p>
        {{ if .App.Author }}
        <div class="tile-author">{{ .App.Author }}</div>
        {{ end }}
    </div>

    {{ if .App.Broken }}
    <div class="tile-broken">
        <i data-lucide="alert-triangle"></i>
        <span>{{ t .Localizer "BROKEN" }}</span>
        <span class="broken-reason">{{ .App.BrokenReason }}</span>
    </div>
    {{ end }}

    <div class="tile-actions">
        {{ if .IsCustom }}
        <a href="/devices/{{ .DeviceID }}/uploads/{{ .App.ID }}/delete"
           class="tile-delete"
           onclick="event.stopPropagation(); return confirm('{{ t .Localizer "Delete this uploaded app? This cannot be undone." }}');">
            <i data-lucide="trash-2"></i> {{ t .Localizer "Delete" }}
        </a>
        {{ end }}

        {{ if eq .ConfigProduction "0" }}
            {{ if .App.Broken }}
            <button class="tile-action tile-action-success unmark-broken-btn"
                    onclick="event.stopPropagation(); unmarkAppAsBroken('{{ .App.FileName }}', '{{ .App.PackageName }}', event, {{ t .Localizer "UnmarkAppBrokenConfirm" (dict "AppName" .App.FileName) | json }});">
                {{ t .Localizer "Unmark Broken" }}
            </button>
            {{ else }}
            <button class="tile-action tile-action-danger mark-broken-btn"
                    onclick="event.stopPropagation(); markAppAsBroken('{{ .App.FileName }}', '{{ .App.PackageName }}', event, {{ t .Localizer "MarkAppBrokenConfirm" (dict "AppName" .App.FileName) | json }});">
                {{ t .Localizer "Mark Broken" }}
            </button>
            {{ end }}
        {{ end }}
    </div>
</div>
{{ end }}
